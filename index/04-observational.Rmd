---
output: 
    thesisdown::thesis_pdf: default
bibliography: bib/thesis.bib
csl: csl/nature.csl
space_betwee_paragraphs: true
fig_caption: true
always_allow_html: yes
link-citations: true
toc-depth: 2
lot: true
lof: true
indent: true
header-includes: # include other LaTeX packages here
    \usepackage{booktabs}
    \usepackage{longtable}
    \usepackage{siunitx}
    \usepackage[left]{lineno}
    \usepackage{float}
    \floatplacement{figure}{H}
    \linenumbers
    \pagestyle{plain}
    \raggedbottom 
    \usepackage{indentfirst}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# word count = 
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this will tell the .Rmd file what output you are knitting to (word, pdf, html) so that you cna use if else statements when making tables - html/pdf output tables do not work well in word. For word we need to use the 'flextable' packaged to make tables.
## packages
library(dplyr)
library(kableExtra)
library(flextable)
options(knitr.kable.NA = '')
```

# Associations between multiple measures of adiposity and metabolites: observational analysis {#observational} 
```{r include=FALSE}
ALSPAC_N <- read.table("data/observational/data/metabolomics/data_prep/other/ALSPAC_N.txt", header = T, sep = "\t")
ALSPAC_QC_N <- read.table("data/observational/data/metabolomics/data_prep/final/qc/ALSPAC_QC_N.txt", header = T, sep = "\t")
```


<style>
body {
text-align: justify}
</style>

## Chapter Summary {-}

In Chapter \@ref(introduction) and \@ref(systematic-review), the link between adiposity and disease was presented both in observational and causal analysis frameworks. This work highlighted that adiposity is associated, likely causally, with many outcomes. A key takeaway from Chapter \@ref(introduction) was that the underlying mechanisms of disease development are not well understood, but that some adiposity-disease relationships may be explained by changes in metabolic, immune, and protein pathways. In this chapter, observational epidemiological methods are used to explore associations between one of the potential pathways linking adiposity to disease, metabolites. The aim of this chapter is to provide an observational grounding for subsequent causal analysis work in Chapter \@ref(MR) and \@ref(mediation). \par

\newpage

## Introduction {#observational-intro} 
Adiposity is associated with an increased risk of numerous diseases, as well as mortality[@Flegal2013; @Lee2015; @Elagizi2018; @Jenkins2018; @Pischon2008; @Rost2018; @Mørkedal2011; @Dong2018; @Lee2018; @Bigaard2004] (see Chapter \@ref(introduction) and \@ref(systematic-review)). There is a need to understand the mechanisms underlying these associations so that intervention strategies, which are challenging to implement effectively, can be targeted and more efficacious. \par

Adiposity has been linked with many downstream measures that could serve as intermediates of disease and thus be useful targets for reducing the burden of adiposity. Notably, previous work has highlighted metabolites[@Bray2004; @Haslam2005; @Collaboration2009] as a possible pathway linking adiposity with diseases such as cancer[@Bhaskaran2014], coronary heart disease (CHD)[@Paul2006; @Koliaki2019], and type 2 diabetes[@Al-Goblan2014]. Metabolites are intermediate or end products of cellular processes with multiple functions including as energy, signalling, transportation, and structural components. Metabolic effects can be far reaching[@Johnson2016; @Wishart2019] and during homeostasis are tightly controlled. The many functions metabolites play mean that imbalances can be detrimental[@Griffin2006; @Johnson2016; @Wishart2019]. Measurement of metabolites has become increasingly common among cohort studies with the advancement, including reduction in costs, of mass spectrometry (MS) and nuclear magnetic resonance (NMR) platforms able to perform targeted, semi-targeted, and untargeted assays. \par

Adiposity has been associated with many metabolites[@Wurtz2014; @Moore2014; @SantosFerreira2017; @Cirulli2019; @Lau2020; @Brachem2020; @Stevens2020; @Wulaningsih2019; @Frigerio2021; @Neeland2019; @Bachlechner2016; @Rangel-Huerta2019] and, in the largest study to date by Wurtz et al., (2014)[@Wurtz2014], influences whole classes of metabolites including amino acids, fatty acids, hormones, inflammatory markers, and lipids. Although there is evidence to show these associations vary between sexes and over time[@Wurtz2014], the focus of many analyses has been on body mass index (BMI) as a measure for overall adiposity, has included small sample sizes, and has looked at a single time-point. \par

While BMI correlates well with, and is a predictor of, many health outcomes[@Donato1998; @NIH2013], it is a crude measure of adiposity with several issues, not least the inability to differentiate lean and fat mass[@Flegal2009], and evidence highlights the importance and utility of combining complimentary assessments of adiposity using multiple measures[@WorldHealthOrganisation2008; @Collaboration2009]. As many studies have focussed on the effect of adiposity on metabolites in adulthood and given the effects of adiposity are shown to present early in life[@Bibbins-Domingo2007; @Hannon2005; @Baer2005; @Swerdlow2002; @Biro2010], investigation of the effect of adiposity in younger ages may provide additional information on the association with metabolites. The Avon Longitudinal Study of Parents and Children (ALSPAC), a longitudinal birth cohort study, with repeated metabolomic and anthropometric measures, provides an opportunity to expand on the current literature. Here, observational analysis of measures of adiposity and metabolites provide a basis from which to investigate causal associations. In addition, comparison with previous work by Wurtz et al.,[@Wurtz2014] is possible for a number of metabolites. \par

## Methods {#observational-methods} 
Data were available for exposures (measures of adiposity), outcomes (metabolites), and potential confounders from ALSPAC. Exposures included body mass index (BMI), waist hip ratio (WHR) and body fat percentage (BF). Metabolomics data were available for up to `r ALSPAC_N$combined_metabolites[[1]]` metabolites. These metabolites include directly measured metabolites such as the amino acids tyrosine and phenylalanine, as well as derived (not-directly measured) metabolite measures such as the ratio of saturated fatty acids to total fatty acid. Covariate data included age, sex, mothers or own education, smoking history, alcohol history, diet, and physical activity. All analyses and data manipulation were performed using `R` (version 3.6.2)[@r2019]. Specific `R` packages are described where appropriate. All code for this work is available on [GitHub](https://github.com/mattlee821/000_thesis/tree/master/index/data/observational). \par

### Data overview 
The Avon Longitudinal Study of Parents and Children[@Fraser2013; @Boyd2013; @Northstone2019] is a prospective cohort study that invited women resident in Avon, UK with expected dates of delivery between 1st April 1991 and 31st December 1992 to participate. The initial number of pregnancies enrolled was 14,541 (for these at least one questionnaire has been returned or a “Children in Focus” clinic has been attended by 19/07/99). Of these initial pregnancies, a total of 14,676 foetuses, resulted in 14,062 live births and 13,988 children alive at one year of age. The mothers and fathers associated with each pregnancy are referred to as generation 0 (G0) while the children of each eligible pregnancy (including individuals from subsequent recruitment drives) are referred to as generation 1 (G1). \par

When the oldest G1 individuals were approximately seven years of age, an attempt was made to bolster the initial sample with eligible cases who had failed to join the study originally. As a result, when considering variables collected from the age of seven onwards (and potentially abstracted from obstetric notes) there are data available for more than the 14,541 pregnancies mentioned above. The number of new pregnancies not in the initial sample (known as Phase I enrolment) that are currently represented on the built files and reflecting enrolment status at the age of 24 is 913 (456, 262, and 195 recruited during Phases II, III, and IV respectively), resulting in an additional 913 G1 individuals being enrolled. The phases of enrolment are described in more detail in the cohort profile paper and its update[@Fraser2013; @Boyd2013; @Northstone2019]. The total sample size for analyses using any data collected after the age of seven is therefore 15,454 pregnancies, resulting in 15,589 foetuses, of which 14,901 were alive at one year of age. \par

The study [website](http://www.bristol.ac.uk/alspac/) contains details of all the data that is available through a fully searchable data dictionary and [variable search tool](http://www.bristol.ac.uk/alspac/researchers/our-data/). Ethical approval for the study was obtained from the ALSPAC Ethics and Law Committee and the [Local Research Ethics Committees](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). Informed consent for the use of data collected via questionnaire and clinics was obtained from participants following recommendations of the ALSPAC Ethics and Law Committee at the time. Full details of the ALSPAC consent procedures are available on the [study website](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). \par

Data in ALSPAC are split by clinic visits. For this work, metabolomics data were available for G1 individuals from the following clinics: Focus at 7 (~8 years old), Focus at 8 (~9 years old), Before Breakfast Study (~8 years old), Teen Focus 3 (~18 years old), Teen Focus 4 (~17 years old), and Focus at 24 (~24 years old). Metabolomics data for G0 individuals were available from: Focus on Mothers 1 (~48 years old), Focus on Mothers 2 (~51 years old), and Focus on Fathers 1 (~53 years old). All data on exposures and covariates were obtained from the same clinic from which metabolomics data were collected. Where data on exposures and covariates were not available at the metabolomics clinic visit they were obtained from the most recent clinic with available data. The Before Breakfast Study, unlike the other clinics, only collected metabolomics data, as such data on exposures and covariates were extracted for these individuals from the Focus at 8 clinic. Metabolomics data for each time point were extracted first and subsequent data on exposures and covariates were extracted for individuals with metabolomics data. The metabolomics data were provided with standard exclusions for identifiable individuals and those with withdrawn consent already excluded. \par

### Exposures: adiposity
Measures of adiposity (BMI, WHR, and BF) were obtained for all individuals with available metabolomics data; identifiable individuals and those with withdrawn consent were removed when obtaining the metabolomics data. Data were obtained from the same clinics as data for the metabolomics data, e.g., metabolomics data was obtained from Focus at 7 and so was anthropometric data for the same individuals. No anthropometric data were available for the Before Breakfast Study, so the Focus at 8 clinic, as the most age appropriate clinic, was used instead. Data on WHR was not available for the Teen Focus 3 and 4 clinics. \par

BMI was calculated as $\displaystyle \frac{weight(kg)}{height (m^2)}$ and WHR as $\displaystyle \frac{waist\ circumference\ (cm)} {hip\ circumference\ (cm)}$. Height was measured to the last complete mm using the Harpenden Stadiometer. Individuals were positioned with their feet flat and heels together, standing straight so that their heels, calves, buttocks and shoulders came into contact with the vertical backboard of the stadiometer. The headboard was lowered until it touched the individuals head and a 1Kg weight was placed on the headboard to ensure head contact and to minimise hair thickness. Weight was measured using the Tanita Body Fat Analyser (Models TBF 305 and 401A) or electronic bathroom scales, if the individual had a pacemaker. Individuals were encouraged to pass urine and undress to their underclothes. For all G1 individuals ‘Female Standard’ was entered into the machine. For all individuals and their height was entered to the nearest cm. Individuals stepped onto the measuring platform which had been wiped with disinfecting alcohol and positioned so that both feet were located in parallel with the toe and heel in contact with their respective electrodes. Measurement was completed when the weight and fat ratio readings were fixed and the buzzer beeped. Weight was measured to the nearest 50g for G1 individuals and to the nearest 0.1kg for G0 individuals. Circumferences were measured using the Seca 200 or 201 body tension tape and were repeated twice for accuracy. \par

BF was measured using dual-energy x-ray absorptiometry in all individuals except for individuals from Foucs at 7. Briefly, measurement required individuals to be prone and stationary while a Lunar prodigy narrow fan beam densitometer performed a whole body DXA scan. Data were processed using Lunar Prodigy software. Individuals did not have measurements taken if they: were pregnant, had a radiological investigation using contrast media within the week before the DXA scan, had a recent nuclear medicine investigation with persistent radioactivity, weighed greater than 159kg. BF was calculated as $\displaystyle \frac{fat\ mass} {fat\ mass + fat\ free\ mass} 100$. \par

For Focus at 7, BF was not measured, instead bioeletrical impedance data, which were converted to estimates of BF, were available. Briefly, individuals were encouraged to pass urine and undress to their underclothes. A Tanita Body Fat Analyser (Model TBF 305) was used to measure weight and impedance. Height was entered to the nearest $cm$ and 'female standard' was used as the sex variable for all individuals. The Tanita Body Fat Analyser TBF 305 is a single frequency (50kHz) leg-to-leg device. In single frequency devices, impedance is a representation of resistance which is related to the volume of water (which one assumes makes up the majority of fat free mass (FFM)), as such, the higher the resistance/impedance the greater the amount of FFM. Calculation of BF from the impedance measure is only possible at the time of measurement, however these derived BF measures were not stored and the equation to calculate them was not available from the manufacturer. Previous work[@Chouinard2007] has shown that comparison of BF derived from the manufacturer's equation and an alternative[@Jebb2000] showed little difference in resulting BF estimates. The equation was derived in a study involving 205 (101 women) healthy adults with a mean age of 43.8 (SD = 16) for men and 40.4 (SD = 13.6) for women. The equation, where $Z$ is the impedance measure from the device in ohms, height is in meters, weight is in kilograms, age is in years, and female-specific components are given as $19.6\ +\ ln(height)$, is given as: \par

\begin{equation}
\begin{split}
  BF = -156.1 - 89.1\ ln(height) \\
  \ +\ 45.6\ ln(weight) \\
  \ +\ 0.120\ age\ \\
  \ +\ 0.0494\ Z \\
  \ +\ (19.6\ ln(height))
\end{split}
  (\#eq:BF)
\end{equation}

Given that the equation was derived from adult data, its application to child data was explored. A raw impedance measure, from a similar model (Tanita Body Fat Analyser (Model TBF 401A)), were obtained for individuals from Teen Focus 3 and 4 (i.e., where both DXA and impedance measures were available) and the equation was used to compare BF derived from the impedance device and BF measured with DXA in adolescents. Exploration involved visual inspection of distribution and Spearman's correlation with BMI, height, weight and other BF measures from Teen Focus 3 and 4. The same observations were carried out for raw impedance. The calculated BF estimates correlated well with height and weight, however they resulted in negative estimates of BF. In a linear model the estimate is based on the per-unit increase, the absolute value of the exposure therefore does not need to be positive. As such, BF calculated using equation \@ref(eq:BF) was used in subsequent analyses as a measure of BF in children. \par

<!-- The raw impedance values correlated well with height and weight, and in adolescents were highly correlated with impedance derived and DXA derived BF estimates (See Appendix \@ref(appendix-observational-BF-validation)). -->

### Outcomes: metabolites
```{r QC-data, echo=FALSE}
load("data/observational/data/metabolomics/data_prep/final/qc/children/MetaboQC_release/ReportData.Rdata")
children_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
children_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
children_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/adolescents/MetaboQC_release/ReportData.Rdata")
adolescents_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adolescents_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adolescents_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/young_adults/MetaboQC_release/ReportData.Rdata")
young_adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
young_adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
young_adults_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/adults/MetaboQC_release/ReportData.Rdata")
adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adults_independent <- nrow(qc_data$varexp)
```
Metabolomics data were measured using the same NMR platform for all individuals. Briefly, high-throughput proton (^1^H) NMR assays were performed on ethylenediaminetetraacetic acid (EDTA) plasma/serum samples. Samples were fasted. Measurements were taken at three molecular windows (lipoprotein lipids, low molecular-weight metabolites, and lipid extracts) enabling broad quantification of metabolomic measures. These measures also included derived measures, lipoprotein particle sizes, and fatty acid ratios, inclusion of which has shown to increase overall power in statistical analyses[@Altmaier2008; @Gieger2008; @Suhre2010]. Full details on the NMR methodology has previously been described[@Soininen2009; @Inouye2010; @Kettunen2012; @Soininen2015] and is available from the [ALSPAC data dictionary](http://www.bristol.ac.uk/alspac/researchers/access/) (data dictionary identifiers: children = D5704, mothers = D5705, fathers = D5700). The Before Breakfast study does not have a documentation file and is described elsewhere[@Ong2004]; fasted metabolomics data, not the post glucose challenge metabolomics data, were taken from The Before Breakfast Study. Descriptions of metabolites are available in the Appendix \@ref(appendix-observational-metabolites). \par

The spectral NMR data were processed by Nightingale Health and provided as a processed file with identifiable individuals (triplets/quadruplets) and individuals who had withdrawn consent removed. Some mothers and fathers were duplicated in this data due to the way in which mothers were originally enrolled into the study and assigned IDs. If a mother enrolled with two different pregnancies (both having an expected delivery date within the recruitment period (April 1991-December 1992)), she will have two separate IDs. A father associated with both of these pregnancies will also be duplicated. Duplicate measurements for mothers and fathers were removed. \par 

In order to maximize the sample size at each clinic, data were combined where clinics were within a similar age range. For these combined data sets, duplicate individuals (i.e., those attending both clinics) were identified, and the measurement from the most recent clinic was dropped. No metabolites were excluded at this stage, however the number of metabolites available for each clinic visit differed as metabolites are added and removed over time by Nightingale as validations change. \par

Pre-analysis processing of metabolomics data is important as there can be quality issues with sample and metabolite data[@Hughes2021]. However, there is no standardised method for performing pre-analysis processing and for deciding what thresholds to use to exclude metabolites and individuals from downstream analyses. The `R` package [`metaboprep`](https://github.com/MRCIEU/metaboprep)[@Hughes2021] can be used to process data before analyses using a transparent and reproducible workflow. Here, after combining clinic visit data where appropriate, `metaboprep` (version 0.0.1) was used to identify and exclude individuals and metabolites that did not meet certain requirements. This process was performed twice, firstly including and secondly excluding the derived metabolomics measures from missingness and clustering analyses to see if these derived measures were unduly influencing exclusions. Briefly, individuals and then metabolites, with high missingness ($\geq$ 80%) were removed. Missingness was then re-calculated for individuals and metabolites, with removal based on 20% missingness. Individuals were then removed based on total sum abundance, considering outliers as $\geq$ 5 standard deviations (SD) away from the mean. Using this metabolite dataset, a dendrogram based on a Spearman's rho distance matrix was produced, and a set of clusters identified based on a Spearman's rho of 0.5. For each cluster, the metabolite with the least missingness was tagged as the representative feature. Finally, principal component (PC) analysis was conducted using the representative features to evaluate structure among individuals. Outliers were identified as being $\geq$ 5 standard deviations away from the mean of PC 1 and 2, and were excluded. Additionally, in order to gain an overview of the variability of metabolite concentrations, the mean, SD of the mean, median, and range of metabolite concentrations were visually compared across age groups. \par

### Covariates
```{r ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/observational/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/observational/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/observational/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/observational/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# table ====
data <- data.frame(group = c("Metabolomics N",
                             "age", "age", "age",
                             "sex","sex",
                             "education", "education", "education", "education", "education",
                             "smoking",
                             "alcohol", "alcohol", "alcohol", "alcohol", "alcohol",
                             "diet", "diet", "diet",
                             "physical activity", "physical activity","physical activity"),
                   subgroup = c("N",
                                "N","mean","sd",
                                "N","female",
                                "1","2","3","4","5",
                                "N",
                                "1","2","3","4","5",
                                "N","mean","sd",
                                "N/1","mean/2","sd/3"),
                   children = c(ALSPAC_QC_N$N[1],
                                nrow(children_qc[!is.na(children_qc$age),]),round(mean(children_qc$age, na.rm  = T), 2),round(sd(children_qc$age, na.rm  = T), 2),
                                nrow(children_qc[!is.na(children_qc$sex),]),table(children_qc$sex)[[2]],
                                (table(children_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[1] * 100),
                                "-",
                                "-","-","-","-","-",
                                nrow(children_qc[!is.na(children_qc$diet),]),round(mean(children_qc$diet, na.rm  = T), 2),round(sd(children_qc$diet, na.rm  = T), 2),
                                "-","-","-"),
                   adolescents = c(ALSPAC_QC_N$N[2],
                                   nrow(adolescents_qc[!is.na(adolescents_qc$age),]),round(mean(adolescents_qc$age, na.rm  = T), 2),round(sd(adolescents_qc$age, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$sex),]),table(adolescents_qc$sex)[[2]],
                                   (table(adolescents_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$ever_smoked),]),
                                   (table(adolescents_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$diet),]),round(mean(adolescents_qc$diet, na.rm  = T), 2),round(sd(adolescents_qc$diet, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$physical_activity),]),round(mean(adolescents_qc$physical_activity, na.rm  = T), 2),round(sd(adolescents_qc$physical_activity, na.rm  = T), 2)),
                   young_adults = c(ALSPAC_QC_N$N[3],
                                    nrow(young_adults_qc[!is.na(young_adults_qc$age),]),round(mean(young_adults_qc$age, na.rm  = T), 2),round(sd(young_adults_qc$age, na.rm  = T), 2),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$sex),]),table(young_adults_qc$sex)[[2]],
                                    (table(young_adults_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$ever_smoked),]),
                                    (table(young_adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    "-","-","-",
                                    nrow(young_adults_qc[!is.na(young_adults_qc$physical_activity),]),round(mean(young_adults_qc$physical_activity, na.rm  = T), 2),round(sd(young_adults_qc$physical_activity, na.rm  = T), 2)),
                                    
                   adults = c(ALSPAC_QC_N$N[4],
                              nrow(adults_qc[!is.na(adults_qc$age),]),round(mean(adults_qc$age, na.rm  = T), 2),round(sd(adults_qc$age, na.rm  = T), 2),
                              nrow(adults_qc[!is.na(adults_qc$sex),]),table(adults_qc$sex)[[2]],
                              (table(adults_qc$education)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              nrow(adults_qc[!is.na(adults_qc$ever_smoked),]),
                              (table(adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              "-","-","-",
                              (table(adults_qc$physical_activity)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[3]]/ALSPAC_QC_N$N[4] * 100))
                   )
```

Evidence has shown that age[@Yu2012; @Brennan2020], sex[@Brennan2020], education[@Zajacova2018], smoking[@Bonevski2014], alcohol[@Bonevski2014], diet[@Afshin2019], and physical activity[@ODonoghue2018] all influence the metabolomic profile and adiposity. Data for each of these covariates were obtained for all individuals with metabolomics data. Age was taken from the metabolomics clinic visit as months since birth. Sex was taken from the initial assessment questionnaire for G1 individuals completed by their parents. For G0 individuals sex was self-reported at the metabolomics clinic visit. \par

Maternal education was used for children, adolescents and young adults. Own education was used for mothers and mother reported partner education was used for fathers. Specifically, mothers were asked, during their pregnancy, 'What educational qualifications do you, your partner, your mother, and your father have?' with possible answers: CSE or GCSE (D, E, F or G); O-level or GCSE (A, B, or C); A-level; qualifications in shorthand/ typing/or other skills e.g. hairdressing;, apprenticeship; state enrolled nurse; state registered nurse; City and Guilds intermediate technical; City & Guilds final technical; City & Guilds full technical; teaching qualification; university degree; no qualification; qualifications not known; not applicable; other (please describe). This data was available as a recoded variable of 5 categories of lowest (1) to highest (5) level of education. \par

Smoking was binary; adolescents (at the metabolomics clinic), young adults (at the metabolomics clinic), and adults (mothers were asked during pregnancy; fathers were asked in at a clinic prior to the metabolomics clinic) were asked whether they had ever smoked a cigarette before. \par

<!-- fathers asked in 2013 -->

Alcohol was assessed differently for Teen Focus 3 and Teen Focus 4, Focus at 24, and G0 individuals. Individuals from Teen Focus 3 were asked what their alcohol drinking pattern was with possible answers: only ever tried drinking once/twice, used to drink sometimes [but] never drink now, sometimes drink but less than once a week, usually drink on 1/2 days a week, usually drink on >2 days a week but not every day, and usually drink every day. Individuals from Teen Focus 4, Focus at 24, and G0 individuals (mothers were asked at a prior clinic visit to the metabolomics clinic and fathers at the metabolomics clinic) were asked the frequency they had drinks containing alcohol with possible answers: never, monthly or less, two to four times a month, two to three times a week, four or more times a week. \par

<!-- mothers asked in 2013 -->

Diet data derived by Anderson et al., (2013)[@Anderson2013] were available for G1 individuals aged 7 and 13. Data from age 7 was matched with metabolomics data for Focus at 7 while data from age 13 was matched with metabolomics data for Teen Focus 3 and 4. Diet data were not available for young adults or adults. Data is given as predicted kilo-calories consumed per day. \par

Data on physical activity were collected differently for different clinic visits. For G1 individuals from Teen Focus 3 and Focus at 24, accelerometry data were collected at the same clinic for which metabolomics data were collected. Briefly, individuals wore an accelerometry device for the 7 days following their clinic visit whilst keeping a diary of the times they wore and took off the device. Individuals were advised to wear the accelerometer device if the following days were part of a ‘normal week’ with regards to their activity. For Focus at 24 individuals, physical activity data are the average number of minutes per day spent doing moderate to vigorous physical activity. For Teen Focus 3 individuals, physical activity data are the mean counts per minute spent doing moderate to vigorous physical activity for the whole week. For G0, individuals were asked 'Do you take part in physical activity (e.g., running, swimming, dancing, golf, tennis, squash, jogging, and bowls)?' with possible answers: no, occasionally (less than monthly), and frequently (once a month or more). Data for mothers were available in 2010, fathers data were available at the metabolomics clinic. Physical activity data were not available for Focus at 7. \par

### Statistical analysis
#### Data
Metabolomics data were obtained first. This data were obtained with identifiable individuals (triplets/quadruplets) and individuals who had withdrawn consent removed. Metabolomics data were available for: Focus at 7 (n = `r ALSPAC_N$total_N[1]`; metabolites = `r ALSPAC_N$total_metabolites[1]`), Before Breakfast Study (n = `r ALSPAC_N$total_N[2]`; metabolites = `r ALSPAC_N$total_metabolites[2]`), Teen Focus 3 (n = `r ALSPAC_N$total_N[3]`; metabolites = `r ALSPAC_N$total_metabolites[3]`), Teen Focus 4 (n = `r ALSPAC_N$total_N[4]`; metabolites = `r ALSPAC_N$total_metabolites[4]`), Focus at 24 (n = `r ALSPAC_N$total_N[5]`; metabolites = `r ALSPAC_N$total_metabolites[5]`), Focus on Mothers 1 (n = `r ALSPAC_N$total_N[6]`; metabolites = `r ALSPAC_N$total_metabolites[6]`), Focus on Mothers 2 (n = `r ALSPAC_N$total_N[7]`; metabolites = `r ALSPAC_N$total_metabolites[7]`), Focus on Fathers (n = `r ALSPAC_N$total_N[8]`; metabolites = `r ALSPAC_N$total_metabolites[8]`). Metabolites includes derived ratios, for example ratio of saturated fatty acids to total fatty acid. \par

In order to maximise sample size, data for similarly aged clinics were combined. After combining the G1 clinics Focus at 7 and Before Breakfast Study (children), and Teen Focus 3 and Teen Focus 4 (adolescents), metabolomics data were available for `r ALSPAC_N$combined_N[1]` children (mean age (SD) = 7.56 (0.36); metabolites = `r ALSPAC_N$combined_metabolites[1]`), `r ALSPAC_N$combined_N[3]` adolescents (mean age (SD) = 16.06 (1.11); metabolites = `r ALSPAC_N$combined_metabolites[3]`), and `r ALSPAC_N$total_N[5]` young adults from the Focus at 24 clinic (mean age (SD) = 24.03 (0.85); metabolites = `r ALSPAC_N$total_metabolites[5]`), ; Table \@ref(tab:observational-table-ALSPAC-N)). After combining the G0 clinics Focus on Mothers 1, Focus on Mothers 2, and Focus on Fathers 1, metabolomics data were available for `r ALSPAC_N$combined_N[9]` adults (mean age (SD) = 49.53 (5.32); metabolites = `r ALSPAC_N$combined_metabolites[9]`). G0 and G1 individuals are independent, however there is familial overlap between them. Improtantly, G1 individuals are not independent, that is, the same individuals will have attended multiple clinics. As such, any effects specific to an individual will be propogated through all G1 clinics that individual attends. \par

All subsequent data on exposures and covariates were obtained for the individuals included in each of the combined groups. All data on exposures and covariates were obtained from the clinic closest in date to that of the metabolomics clinic. \par

#### Statistical analysis
To estimate the association between measures of adiposity and metabolites, all exposures were $Z$-scored and linear regression was performed. Metabolites were not transformed as the majority did not appear to have skewed distributions after pre-analysis processing using `metaboprep`. Variables known to influence the metabolomic profile and adiposity (age, sex, education, smoking, alcohol, diet, and physical activity), were included as covariates. Three linear models were used to investigate potential effects of these covariates. Model 1 included age and sex. Model 2 included variables in model 1 and mothers/own level of education, whether respondent had ever smoked, frequency respondent had a drink containing alcohol, and predicted kilo-calories consumed per day. Model 3 comprised all variables included in model 2 and physical activity. To maximise sample size for analyses, model 1 and 2 comprised individuals with data on all covariates except physical activity. Model 3 comprised all individuals with data on all covariates. Model 2, as the most adjusted and given the reduced sample size in model 3, is presented as the main analysis for this work. \par

For all analyses, units represent the change in each metabolite per standard deviation change in the exposure. Metabolite abbreviations are used in figures and tables for space. For complete labels, class, subclass, and units for each metabolite see [GitHub](https://github.com/mattlee821/000_thesis/blob/master/index/data/observational/tables/metabolites.txt). 95% confidence intervals (CI) were calculated and a multiple testing threshold specific for each age group was applied. Multiple testing thresholds were calculated as the number of independent metabolites within the raw metabolomics data given a Spearman’s rho of approximately 0.75 among the metabolites with data for at least 20% of samples -- this was calculated during metabolite pre-analysis processing using `metaborpep`. The number of independent metabolites in each age group were calculated as: children = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`. \par

Metabolites were grouped into subclasses (grouping data provided by the metabolomics platform) based on biological pathway. Consistency in the direction of effect estimates across models within each exposure and age group was investigated, as was the number of tests reaching a multiple testing threshold. In addition, directional consistency for results for exposures across age groups (using results from model 2) was also investigated. A Spearmans rho correlation analysis was used to investigate the correlation between effect estimates across exposures and age groups. Circos plots (via the `EpiViz` `R` package) were used to visualize and compare global metabolic profiles within age groups across exposures. Forestplots, created using the `ggforestplot` `R` package, were used to examine specific subclasses where variation among metabolites within the subclass and strong effects were identified. Results for derived measures and lipoprotein particle size and fatty acid ratios are presented in the Appendix. Directions of effect estimates were compared to that of previous work by Wurtz et al. (2014)[@Wurtz2014] where appropriate. \par

## Results {#observational-results} 
```{r echo=FALSE, warning=FALSE, error=FALSE}
# data ====
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data <- subset(data, subclass != "NA")
# shared metabolites ====
a <- subset(data, model == "model2")
a <- subset(a, exposure == "bmi")
b <- subset(a, group == "children")
c <- subset(a, group == "adolescents")
d <- subset(a, group == "young_adults")
e <- subset(a, group == "adults")
b <- as.data.frame(b[,1])
colnames(b) <- "metabolite"
b$group <- "children"
c <- as.data.frame(c[,1])
colnames(c) <- "metabolite"
c$group <- "adolescents"
d <- as.data.frame(d[,1])
colnames(d) <- "metabolite"
d$group <- "young_adults"
e <- as.data.frame(e[,1])
colnames(e) <- "metabolite"
e$group <- "adults"
f <- full_join(b,c, by = "metabolite")
f <- full_join(f,d, by = "metabolite")
f <- full_join(f,e, by = "metabolite")
metabolites <- f[complete.cases(f), ]
metabolites <- metabolites[,1]
metabolites <- droplevels(as.factor(metabolites))

# n in each plot
plot_data <- subset(data, exposure == "bmi")
plot_data <- subset(plot_data, model == "model2")
plot_data <- plot_data[plot_data$metabolite %in% metabolites, ]
plot_data <- subset(plot_data, group == "children")
ratios <- subset(plot_data, subclass == "Ratios")
fa_ratios <- subset(plot_data, subclass == "Fatty acids ratios")
lp_size <- subset(plot_data, subclass == "Lipoprotein particle size")
```

### Data overview
In pre-analysis processing of metabolomics data, derived metabolite measures drastically increased the number of representative metabolites in the dataset. As such, metabolomics data that underwent pre-analysis processing with the inclusion of derived features were used throughout. The total number of individuals with metabolomics data, as well as the number of metabolites available prior to pre-processing is given in Table \@ref(tab:observational-table-ALSPAC-N). \par

\blandscape
```{r observational-table-ALSPAC-N, echo=FALSE}
knitr::kable(ALSPAC_N, longtable = F, booktabs = T, format = "latex", escape = F,
    caption = 'Metabolomics data available prior to pre-analysis processing', 
    row.names = F,
    col.names = linebreak(c("Age group", "N", "Metabolites", "Age/clinic subgroup", "N", "Unique\n N", "Metabolites", "Unique\n metabolites"))) %>%
  collapse_rows(columns = 1:3) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Data were available from multiple time points. Generation 1 individuals were were measured at 5 time points and combined into three groups (Children, Adolescents, Young adults). Generation 0 individuals were measured at three time points and combined (Adults). N = number of individuals in each group group; Metabolites = the number of metabolites measured for each group; Subgroup = age or clinic identifier; Unique N = the number of individuals in the subgroup who do not appear in the other subgroup; Unique metabolites = Number of metabolites unique to that subgroup.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```
\elandscape

Pre-analysis processing of metabolomics data resulted in the following exclusions: `r children_samples_removed` individuals and `r children_features_removed` metabolites were removed from the children's data (4 samples excluded for $\geq$ 80% missingness, 1 sample excluded for total sum abundance $\geq$ 5 SD from the mean, 1 sample excluded as a result of being $\geq$ 5 SD from the mean of PC1 and 2, and 4 metabolites removed for $\geq$ 20% missingness); `r adolescents_samples_removed` individuals and `r adolescents_features_removed` metabolites were removed from the adolescents data (1 sample excluded for total sum abundance $\geq$ 5 SD from the mean and 4 samples excluded as a result of being $\geq$ 5 SD from the mean of PC1 and 2); `r young_adults_samples_removed` individuals and `r young_adults_features_removed` metabolites were removed from the young adults data (1 sample excluded for total sum abundance $\geq$ 5 SD from the mean and 3 sample excluded as a result of being $\geq$ 5 SD from the mean of PC1 and 2); `r adults_samples_removed` individuals and `r adults_features_removed` metabolites were removed from the adults data (1 sample excluded for total sum abundance $\geq$ 5 SD from the mean, 6 samples excluded as a result of being $\geq$ 5 SD from the mean of PC1 and 2, and 4 metabolites removed for $\geq$ 20% missingness). Processed metabolomics data available for analysis is given in Table \@ref(tab:observational-table-ALSPAC-QC-N). \par

```{r observational-table-ALSPAC-QC-N, echo=FALSE}
x <- ALSPAC_QC_N

x[3,1] <- "Young adults"
knitr::kable(x, longtable = F, booktabs = T, format = "latex", escape = F,
             row.names = F,
             col.names = c("Group", "N", "Metabolites"),
             caption = 'Metabolomics data available after pre-analysis processing') %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Number of individuals (N) and metabolites available after pre-analysis processing of metabolomics data was performed using the `metaboprep` `R` package and including derived measures.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

Of individuals with metabolomics data, a majority also had data on measures of adiposity (Table \@ref(tab:observational-table-ALSPAC-adiposity)), except for adolescents where data on WHR was not available. Adiposity data were normally distributed (Appendix Figure \@ref(appendix-observational-figure-adiposity-distribution)). Data on covariates were also available in the majority of individuals, the exception being physical activity where fewer individuals had available data and no data was available for children (Table \@ref(tab:observational-table-ALSPAC-adiposity)). \par

<!-- Do you factor in difference in N for covarites in the analyses????-->
<!-- A total of `r nlevels(metabolites)` metabolites were available in all age groups. -->

```{r observational-table-ALSPAC-adiposity, echo=FALSE, warning=FALSE, error=FALSE}
adiposity_table <- read.table("data/observational/tables/adiposity_table.txt", header = T, sep = "\t")

knitr::kable(adiposity_table, longtable = F, booktabs = T, format = "latex", escape = F,
             caption = 'Measures of adiposity available for individuals with metabolomics data',
             row.names = F,
             col.names = c("Age group", "N", "N","mean","SD","N","mean","SD","N","mean","SD")) %>%
  add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3)) %>%
    kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Measures were obtained for all individuals with processed metabolomics data. Wait hip ratio (WHR) was not available for adolescents. Body fat percentage (BF) was not available for children but a raw impedance measure was available. Age group = the combined age group clinic visits were combined into; BMI = body mass index; N = the number of individuals with available data; mean = the mean of the anthropometric measure; SD = standard deviation of the mean; - = data not available.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

```{r observational-table-ALSPAC-covariates, echo=FALSE, warning=FALSE, error=FALSE}
covariate_table <- read.table("data/observational/tables/covariate_table.txt", header = T, sep = "\t", colClasses = "character")

knitr::kable(covariate_table, longtable = T, booktabs = T, format = "latex", escape = F,
             caption = 'Covariates available for individuals with metabolomics data', row.names = F, 
             col.names = c("","","Children","Adolescents","Young adults","Adults")) %>%
  collapse_rows(columns = 1) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Education is highest level of education (1-5); for children, adolescents, and young adults education is maternal education; for adults education is own education. Smoking is binary. Alcohol is frequency respondent consumes an alcoholic drink, with 1 being low and 5 high. Diet is predicted kilo-calories consumed per day. Physical activity in dolescents is mean counts per minute of activity across 7 days. For young adults physical activity is the average number of valid minutes per day spent doing moderate to vigorous activity. For adults, physical activity is: no physical activity (1), occasionally (2), frequently (3). Group = the groups clinic visits were combined into; N = the number of individuals with available data; mean = the mean of the measure; SD = standard deviation of the mean. - = data not available.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

When looking at the variability in metabolite concentrations across age groups, the mean and SD of the mean metabolite concentration, as well as the median metabolite concentration and range between the minimum and maximum metabolite concentration for each metabolite were generally similar across all age groups. Variability in metabolite concentrations tended to increase (larger SD of mean metabolite concentration and range of metabolite concentrations for each metabolite) with age however, with the largest variability predominantly seen in adults. Variability appeared much larger when looking exclusively at derived metabolite measures as opposed to directly measured metabolites. All plots are available on [GitHub](https://github.com/mattlee821/000_thesis/tree/master/index/data/observational/figures/metabolite_concentrations). \par

### Statistical analysis
```{r echo=FALSE, warning=FALSE, error=FALSE}
library(tidyr)
# how many consistent significnat effects
# main analysis, consistent direction, significant ====
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data_all <- data
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

n_children <- nrow(children)/3
n_adolescents <- nrow(adolescents)/2
n_young_adults <- nrow(young_adults)/3
n_adults <- nrow(adults)/3

## subset for multiple testing threshold ====
children <- subset(children, p <= 0.05/children_independent)
adolescents <- subset(adolescents, p <= 0.05/adolescents_independent)
young_adults <- subset(young_adults, p <= 0.05/young_adults_independent)
adults <- subset(adults, p <= 0.05/adults_independent)

# limit to interested rows ====
children <- children[,c(1,3,13,14,15)]
adolescents <- adolescents[,c(1,3,13,14,15)]
young_adults <- young_adults[,c(1,3,13,14,15)]
adults <- adults[,c(1,3,13,14,15)]

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

### children ====
data <- children[,c(4:ncol(children))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$group <- "children"
children_consistent_significant <- nrow(children)

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$group <- "adolescents"
adolescents_consistent_significant <- nrow(adolescents)

### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$group <- "young_adults"
young_adults_consistent_significant <- nrow(young_adults)

### adults ====
data <- adults[,c(4:ncol(adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$group <- "adults"
adults_consistent_significant <- nrow(adults)

```

```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/children_independent)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/children_independent)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/children_independent)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/children_independent)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/children_independent)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/children_independent)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/adolescents_independent)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/adolescents_independent)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/adolescents_independent)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/adolescents_independent)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/adolescents_independent)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/adolescents_independent)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/young_adults_independent)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/young_adults_independent)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/young_adults_independent)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/young_adults_independent)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/young_adults_independent)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/young_adults_independent)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/young_adults_independent)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/young_adults_independent)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/young_adults_independent)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/adults_independent)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/adults_independent)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/adults_independent)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/adults_independent)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/adults_independent)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/adults_independent)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/adults_independent)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/adults_independent)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/adults_independent)

# precent of total ====
children_m1_bmi_percent <- nrow(children_m1_bmi_sig) / nrow(children_m1_bmi) * 100
children_m2_bmi_percent <- nrow(children_m2_bmi_sig) / nrow(children_m2_bmi) * 100
children_m1_whr_percent <- nrow(children_m1_whr_sig) / nrow(children_m1_whr) * 100
children_m2_whr_percent <- nrow(children_m2_whr_sig) / nrow(children_m2_whr) * 100
children_m1_bf_percent <- nrow(children_m1_bf_sig) / nrow(children_m1_bf) * 100
children_m2_bf_percent <- nrow(children_m2_bf_sig) / nrow(children_m2_bf) * 100
adolescents_m1_bmi_percent <- nrow(adolescents_m1_bmi_sig) / nrow(adolescents_m1_bmi) * 100
adolescents_m2_bmi_percent <- nrow(adolescents_m2_bmi_sig) / nrow(adolescents_m2_bmi) * 100
adolescents_m3_bmi_percent <- nrow(adolescents_m3_bmi_sig) / nrow(adolescents_m3_bmi) * 100
adolescents_m1_bf_percent <- nrow(adolescents_m1_bf_sig) / nrow(adolescents_m1_bf) * 100
adolescents_m2_bf_percent <- nrow(adolescents_m2_bf_sig) / nrow(adolescents_m2_bf) * 100
adolescents_m3_bf_percent <- nrow(adolescents_m3_bf_sig) / nrow(adolescents_m3_bf) * 100
young_adults_m1_bmi_percent <- nrow(young_adults_m1_bmi_sig) / nrow(young_adults_m1_bmi) * 100
young_adults_m2_bmi_percent <- nrow(young_adults_m2_bmi_sig) / nrow(young_adults_m2_bmi) * 100
young_adults_m3_bmi_percent <- nrow(young_adults_m3_bmi_sig) / nrow(young_adults_m3_bmi) * 100
young_adults_m1_whr_percent <- nrow(young_adults_m1_whr_sig) / nrow(young_adults_m1_whr) * 100
young_adults_m2_whr_percent <- nrow(young_adults_m2_whr_sig) / nrow(young_adults_m2_whr) * 100
young_adults_m3_whr_percent <- nrow(young_adults_m3_whr_sig) / nrow(young_adults_m3_whr) * 100
young_adults_m1_bf_percent <- nrow(young_adults_m1_bf_sig) / nrow(young_adults_m1_bf) * 100
young_adults_m2_bf_percent <- nrow(young_adults_m2_bf_sig) / nrow(young_adults_m2_bf) * 100
young_adults_m3_bf_percent <- nrow(young_adults_m3_bf_sig) / nrow(young_adults_m3_bf) * 100
adults_m1_bmi_percent <- nrow(adults_m1_bmi_sig) / nrow(adults_m1_bmi) * 100
adults_m2_bmi_percent <- nrow(adults_m2_bmi_sig) / nrow(adults_m2_bmi) * 100
adults_m3_bmi_percent <- nrow(adults_m3_bmi_sig) / nrow(adults_m3_bmi) * 100
adults_m1_whr_percent <- nrow(adults_m1_whr_sig) / nrow(adults_m1_whr) * 100
adults_m2_whr_percent <- nrow(adults_m2_whr_sig) / nrow(adults_m2_whr) * 100
adults_m3_whr_percent <- nrow(adults_m3_whr_sig) / nrow(adults_m3_whr) * 100
adults_m1_bf_percent <- nrow(adults_m1_bf_sig) / nrow(adults_m1_bf) * 100
adults_m2_bf_percent <- nrow(adults_m2_bf_sig) / nrow(adults_m2_bf) * 100
adults_m3_bf_percent <- nrow(adults_m3_bf_sig) / nrow(adults_m3_bf) * 100

min_significant_percent <- round(min(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

max_significant_percent <- round(max(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

mean_significnat_percent <- round(mean(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

median_significant_percent <- round(median(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

# percent change ====
adolescents_m1_m3_bmi_percent_change <- (nrow(adolescents_m1_bmi_sig) - nrow(adolescents_m3_bmi_sig)) / nrow(adolescents_m1_bmi_sig) * 100


```

```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
m1 <- subset(data, model == "model1")
m2 <- subset(data, model == "model2")
m3 <- subset(data, model == "model3")

children_m1 <- subset(m1, group == "children")
children_m2 <- subset(m2, group == "children")
children_m3 <- subset(m3, group == "children")

adolescents_m1 <- subset(m1, group == "adolescents")
adolescents_m2 <- subset(m2, group == "adolescents")
adolescents_m3 <- subset(m3, group == "adolescents")

young_adults_m1 <- subset(m1, group == "young_adults")
young_adults_m2 <- subset(m2, group == "young_adults")
young_adults_m3 <- subset(m3, group == "young_adults")

adults_m1 <- subset(m1, group == "adults")
adults_m2 <- subset(m2, group == "adults")
adults_m3 <- subset(m3, group == "adults")

table <- data.frame(group = c("Children", "Adolescents", "Young adults", "Adults"),
                    N = c(5650,4484,3265,6399),
                    m1_m2 = c(unique(children_m1$n), unique(adolescents_m1$n), unique(young_adults_m1$n), unique(adults_m1$n)),
                    m3 = c("--", unique(adolescents_m3$n), unique(young_adults_m3$n), unique(adults_m3$n)))
```

In total, metabolomics data were available for 5,650 children, 4,484 adolescents, 3,265 young adults, and 6,399 adults. After obtaining data on covariates data were available for between `r min(data$n)`--`r max(data$n)` individuals (Table \@ref(tab:observational-table-N)). Model 1 and model 2 were restricted to all individuals with complete data for adiposity and covariate data for model 2. Model 3 was restricted to individuals with complete data for all adiposity measures and all covariates. \par

```{r observational-table-N, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
m1 <- subset(data, model == "model1")
m2 <- subset(data, model == "model2")
m3 <- subset(data, model == "model3")

children_m1 <- subset(m1, group == "children")
children_m2 <- subset(m2, group == "children")
children_m3 <- subset(m3, group == "children")

adolescents_m1 <- subset(m1, group == "adolescents")
adolescents_m2 <- subset(m2, group == "adolescents")
adolescents_m3 <- subset(m3, group == "adolescents")

young_adults_m1 <- subset(m1, group == "young_adults")
young_adults_m2 <- subset(m2, group == "young_adults")
young_adults_m3 <- subset(m3, group == "young_adults")

adults_m1 <- subset(m1, group == "adults")
adults_m2 <- subset(m2, group == "adults")
adults_m3 <- subset(m3, group == "adults")

table <- data.frame(group = c("Children", "Adolescents", "Young adults", "Adults"),
                    N = c(5650,4484,3265,6399),
                    m1_m2 = c(unique(children_m1$n), unique(adolescents_m1$n), unique(young_adults_m1$n), unique(adults_m1$n)),
                    m3 = c("--", unique(adolescents_m3$n), unique(young_adults_m3$n), unique(adults_m3$n)))

knitr::kable(table, longtable = T, booktabs = T, format = "latex", escape = T,
             caption = 'Total number of individulas with metabolomics data and total number of individuals included in each linear model', row.names = F, 
             col.names = c("Age group","N","Model 1 & 2","Model 3")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "The total number of individuals with available metabolomics data (N) and the sample size for each linear model (Model 1 & 2 and Model 3).", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

Across all models and exposures, between `r min_significant_percent`--`r max_significant_percent` % (median = `r round(median_significant_percent,1)` %) of metabolites reached a multiple testing threshold (multiple testing threshold for children = `r round(0.05/children_independent,4)`, adolescents = `r round(0.05/adolescents_independent,4)`, young adults = `r round(0.05/young_adults_independent,4)`, adults = `r round(0.05/adults_independent,4)`). In summary, between 83-193, 139-193 and 75-197 metabolites reached a multiple testing threshold across all age groups for BMI, WHR, and BF respectively (Table \@ref(tab:observational-table-significant-results)).

```{r observational-table-significant-results, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/tables/multiple_testing_table.txt", header = T, sep ="\t")

knitr::kable(data, longtable = T, booktabs = T, format = "latex", escape = F,
             caption = 'Number of tests reaching a multiple testing threshold', row.names = F, 
             col.names = c("","N","1","2","3","1","2","3","1","2","3")) %>%
  collapse_rows(columns = 1) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3)) %>%
  kableExtra::footnote(general = "Number of metabolites (N) reaching a multiple testing threshold for each model (1-3) within each age group for each exposure. Multiple testing thresholds: children = 0.0012, adolescents = 0.0012, young adults = 0.0013, adults = 0.0011. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage; 1 = model 1 adjustment for age and sex; 2 = model 2 adjustment for model 1 plus maternal/own education, smoking status, alcohol frequency, diet (where available); 3 = model 3, adjustment for model 2 plus physical activity (where available).", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

#### Directional consistency between effect estimates across three linear models within exposures and age groups
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
```
Across models, within each exposure and age group, the majority of tests resulted in directionally consistent effect estimates (Figure \@ref(fig:observational-figure-directional-consistency)). Of these directionally consistent effects, the majority of effect estimates were positive. That is, across a majority of metabolites, adiposity was associated with an increase in metabolites. The strength of these effect estimates were broadly consistent across models; confidence intervals overlapped across the majority of metabolites for all models within each group and exposure (Appendix \@ref(appendix-observational-figures-forestplots)). Of the `r nlevels(metabolites)` metabolites measured in all age groups, directional consistency was supported by strong evidence of correlation across models within exposures and age groups (Appendix \@ref(appendix-observational-correlations)). \par

(ref:observational-figure-directional-consistency-cap) **Directional consistency between effect estimates across three linear models within exposures and age groups**. A positive effect reflects all model betas being in the positive direction; a negative effect reflects all model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-directional-consistency-scap) Directional consistency between effect estimates across three linear models within exposures and age groups

```{r observational-figure-directional-consistency, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap='(ref:observational-figure-directional-consistency-cap)', fig.scap='(ref:observational-figure-directional-consistency-scap)'}
knitr::include_graphics("data/observational/figures/plot_directional_consistency_across_models_within_exposures_groups.pdf")
```

#### Directional consistency between effect estimates for linear model 2 across exposures within age groups
```{r echo=FALSE, warning=FALSE, error=FALSE}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,14,15,16)]
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children ====
data <- children[,c(4:ncol(children))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$exposure <- "children"
# ### children inverse
# data <- children[,c(4:ncol(children))]
# data <- data[complete.cases(data), ]
# data$direction = sapply( 1:nrow(data), function(i){
# 	## set data vector
# 	x = sign( data[i, ] )
# 	##
# 	if( x[1] == -1 & sum(x[2:3]) == 2 ){
# 		direct = 1
# 	} else{
# 		if( x[1] == 1 & sum(x[2:3]) == -2 ){
# 		direct = 2
# 		} else {
# 			direct = 3
# 		}
# 	}
# 	}
# )
# data <- data %>%
#   mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
#                                      direction == 2 ~ "Negative effect",
#                                      direction == 3 ~ "Opposite effect"))
# data$direction_group <- factor(data$direction_group,
#                                levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
# children_inverse <- data
# children_inverse$exposure <- "children_inverse"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$exposure <- "adolescents"
### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$exposure <- "young_adults"
### adults ====
data <- adults[,c(4:ncol(adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$exposure <- "adults"
## join data frames ====
data <- bind_rows(children,adolescents,young_adults,adults)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure)[c(3,1,4,2)])
```

Given the broad agreement between models, including the high correlation observed for effects between model 2 and model 3 (Spearmans rho = 0.81--0.99; Appendix \@ref(appendix-observational-correlations)), and the fact that model 3 was not run for children as data on physical activity were not available, results here on are presented for model 2 (all results are available on [GitHub](https://github.com/mattlee821/000_thesis/tree/master/index/data/observational)). \par

Across the three exposures (BMI, WHR, and BF) within each age group, effects showed mostly consistent directions of effect. The majority of effects were to increase (positive) metabolites (Figure \@ref(fig:observational-figure-directional-consistency-2)). The most inconsistent directions across exposures were found for children, where `r round(table(children$direction_group)[[3]]/(nrow(children))*100)`% of metabolites showed inconsistent directions of effect. For adolescents, young adults, and adults `r round(table(adolescents$direction_group)[[3]]/(nrow(adolescents))*100)`, `r round(table(young_adults$direction_group)[[3]]/(nrow(young_adults))*100)`, and `r round(table(adults$direction_group)[[3]]/(nrow(adults))*100)`% of metabolites showed inconsistent directions of effect across measures of adiposity respectively. A large proportion of metabolites with evidence for a consistent direction of effect across all three exposures also reached the multiple testing threshold: children = `r children_consistent_significant`, adolescents = `r adolescents_consistent_significant`, young adults = `r young_adults_consistent_significant`, and adults = `r adults_consistent_significant`. \par

Of the `r nlevels(metabolites)` metabolites measured across all age groups, directional consistency was supported by strong evidence of correlation across exposures within age groups (Spearmans rho = 0.61--0.97) and within exposures across age groups (Spearmans rho = 0.48--0.82; Appendix \@ref(appendix-observational-correlations)). \par

(ref:observational-figure-directional-consistency-2-cap) **Directional consistency between effect estimates for linear model 2 across exposures within age groups**. A positive effect reflects all model betas being in the positive direction; a negative effect reflects all model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-directional-consistency-2-scap) Directional consistency between effect estimates for linear model 2 across exposures within age groups

```{r observational-figure-directional-consistency-2, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap='(ref:observational-figure-directional-consistency-2-cap)', fig.scap='(ref:observational-figure-directional-consistency-2-scap)'}
knitr::include_graphics("data/observational/figures/plot_directional_consistency_model2_within_exposures_groups.pdf")
```

#### Global metabolic profile
To aid visual comparison between metabolite subclasses, directly measured metabolites were visualised seperately to derived measures which are presented in the Appendix \@ref(appendix-observational). Dervied metabolites are metabolites that are not directly measured by the metabolomics array and are instead derived during the processing of the raw NMR spectra. Derived measures include ratios such as Cholesterol esters in very large VLDL to total lipids in very large VLDL ratio and Total cholesterol in very large VLDL to total lipids in very large VLDL ratio. \par

Overall, the global pattern of association was very similar for all measures of adiposity for children (Figure \@ref(fig:observational-figure-circosplot-main-children)), adolescents (Figure \@ref(fig:observational-figure-circosplot-main-adolescents)), young adults (Figure \@ref(fig:observational-figure-circosplot-main-young-adults)), and adults (Figure \@ref(fig:observational-figure-circosplot-main-adults)) across all directly measured metabolites. Across all age groups, the largest effects were found for the fatty acids subclass; the metabolite total fatty acids showed the largest effect across all exposures for each age group. Metabolites in subclasses small VLDL, medium VLDL, large VLDL, and very large VLDL were the only ones to reach the specified multiple testing thresholds across all exposures and age groups. Across age groups, the direction of effect was consistent for the majority of metabolites within exposures (Appendix \@ref(appendix-observational-figures-forestplots)). On the whole, effect sizes were lowest in children and increased with age. The largest effect in adults, total fatty acids (change in metabolite per standard deviation change in the exposure (beta) = 0.51), was twice that observed in children (beta = 0.21). \par

Effect estimates for derived measures were much higher for all exposures and age groups compared to directly measured metabolites. However, the global pattern of association was very similar within age groups across exposures and across age groups within exposures (Appendix \@ref(appendix-observational-figures-circosplots)). There was also considerable variation within subclasses for derived measures. The largest effect across all age groups and exposures among derived measures was observed for cholesterol esters in very large VLDL to total lipids in very large VLDL ratio and total cholesterol in very large VLDL to total lipids in very large VLDL ratio. \par

(ref:observational-figure-circosplot-main-children-cap) **Effect estimates from linear regression of adiposity measures on metabolites in children**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the change in metabolite per standard deviation change in the exposure; 95% confidence intervals are shown and may be hidden by the point estimate if very tight. Solid points indicate a multiple testing threshold has been reached (0.05/`r children_independent`).

(ref:observational-figure-circosplot-main-children-scap) Effect estimates from linear regression of adiposity measures on metabolites in children

```{r observational-figure-circosplot-main-children, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-children-cap)', fig.scap='(ref:observational-figure-circosplot-main-children-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_children.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-adolescents-cap) **Effect estimates from linear regression of adiposity measures on metabolites in adolescents**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the change in metabolite per standard deviation change in the exposure; 95% confidence intervals are shown and may be hidden by the point estimate if very tight. Solid points indicate a multiple testing threshold has been reached (0.05/`r adolescents_independent`).

(ref:observational-figure-circosplot-main-adolescents-scap) Effect estimates from linear regression of adiposity measures on metabolites in adolescents

```{r observational-figure-circosplot-main-adolescents, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-adolescents-cap)', fig.scap='(ref:observational-figure-circosplot-main-adolescents-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_adolescents.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-young-adults-cap) **Effect estimates from linear regression of adiposity measures on metabolites in young adults**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the change in metabolite per standard deviation change in the exposure; 95% confidence intervals are shown and may be hidden by the point estimate if very tight. Solid points indicate a multiple testing threshold has been reached (0.05/`r young_adults_independent`).

(ref:observational-figure-circosplot-main-young-adults-scap) Effect estimates from linear regression of adiposity measures on metabolites in young adults

```{r observational-figure-circosplot-main-young-adults, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-young-adults-cap)', fig.scap='(ref:observational-figure-circosplot-main-young-adults-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_young_adults.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-adults-cap) **Effect estimates from linear regression of adiposity measures on metabolites in adults**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the change in metabolite per standard deviation change in the exposure; 95% confidence intervals are shown and may be hidden by the point estimate if very tight. Solid points indicate a multiple testing threshold has been reached (0.05/`r adults_independent`).

(ref:observational-figure-circosplot-main-adults-scap) Effect estimates from linear regression of adiposity measures on metabolites in adults

```{r observational-figure-circosplot-main-adults, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-adults-cap)', fig.scap='(ref:observational-figure-circosplot-main-adults-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_adults.pdf")
```

\newpage

#### Subclass results
The Nightingale NMR platform is able to separate out metabolites into subclasses. When looking at directly measured metabolite subclasses, there were associations between measures of adiposity and all subclasses except for large LDL in children where confidence intervals for all metabolites crossed the nul. For the derived measure subclasses, associations were observed across measures of adiposity for all subclasses except extremely large VLDL ratios in young adults and adults. \par

Across all age groups and exposures, associations with every metabolite in a particular subclass was observed for small VLDL, medium VLDL, large VLDL, very large VLDL, and extremely large VLDL. As age increased, the number of associations within subclasses tended to increase across all measures of adiposity. For example, across small LDL, medium LDL, and large LDL few associations were observed across measures of adiposity in children, however in adolescents and young adults, a majority of metabolites showed evidence of association; while in adults, all metabolites showed evidence of association. Effect size tended to increase with age as well, for example, the largest effects seen for small, medium, and large LDL metabolites were in adults and young adults (Figure \@ref(fig:observational-figure-forestplot-subclass-LDL)). \par

(ref:observational-figure-forestplot-subclass-LDL-cap) **Effect estimates from linear regression of adiposity measures on metabolites in all age groups for small, medium, and large LDL subclasses**. The forestplot shows the change in metabolite per standard deviation change in the exposure. 95% confidence intervals are given. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-forestplot-subclass-LDL-scap) Effect estimates from linear regression of adiposity measures on metabolites in all age groups for small, medium, and large LDL subclasses 

```{r observational-figure-forestplot-subclass-LDL, echo=FALSE, out.width='100%',  fig.cap='(ref:observational-figure-forestplot-subclass-LDL-cap)', fig.scap='(ref:observational-figure-forestplot-subclass-LDL-scap)'}
knitr::include_graphics("data/observational/figures/forestplot_subclass_LDL.pdf")
```

### Comparison with previous work {#chapter4-wurtz-comparison}
A total of 82 metabolites were measured by Wurtz et al. (2014)[@Wurtz2014]. Of these, 42 were also measured acros children, adolescents, young adults, and adults. Across all analyses conducted here for model 2, a majority of metabolites showed a consistent direction of effect with the study by Wurtz et al.[@Wurtz2014] (Figure \@ref(fig:observational-figure-wurtz-comparison)). However, there were some metabolites where the effects from Wurtz et al., were opposite to the majority of effects found here, such as fatty acid chain length (falen) and albumin (alb). \par

The majority of effect estimates were in the positive direction, i.e. an increase in adiposity increased metabolites; 30 metabolites had primarily positive effects as a result of adiposity, and 12 metabolites had primarily negative effects as a reuslt of adiposity. A total of 18 metabolites were associated with a positive effect across analyses by Wurtz et al., and all age groups and exposures here, this included phenylalanine, tyrosine, and apolipoprotein B. Seven metabolites were associated with a negative effect across all analyses, including citrate and apolipoprotein A1. Looking at the overall effects for each subclass, there were primarily positive effects of adiposity for subclasses aromatic and branched chain amaino acids, cholesterol, fatty acids, glycerides and phospholipids, and glycolysis related metabolites. Primarily negative effects were found for lipoprotein paricle size and fatty acids ratios. The remaining subclasses where closely split (amino acids and fluid balance) or composed of one metabolites (IDL, inflammation, and ketone bodies). \par

\newpage
\thispagestyle{empty}

(ref:observational-figure-wurtz-comparison-cap) **Comparison of the directions of effect estimates from linear regression of adiposity measures on metabolites across all age groups and analysis by Wurtz et al. (2014)[@Wurtz2014].** 

(ref:observational-figure-wurtz-comparison-scap) Comparison of the directions of effect estimates from linear regression of adiposity measures on metabolites across all age groups and analysis by Wurtz et al. (2014)[@Wurtz2014]

```{r observational-figure-wurtz-comparison, echo=FALSE, out.width='75%', fig.cap='(ref:observational-figure-wurtz-comparison-cap)', fig.scap='(ref:observational-figure-wurtz-comparison-scap)'}
knitr::include_graphics("data/observational/figures/wurtz_comparison.pdf")
```

\noindent The tile plot shows the direction of effect estimate for 42 metabolites as positive (blue) or negative (yellow). If all analyses show the same direction of effect then that row will be the same colour, e.g., all analyses show a decreasing effect on apoa1 and an increasing effect on apob. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage; IDL = intermediate density lipoproteins. White space indicates no analysis. For full names of metabolites see appendix. \par

## Discussion {#observational-discussion} 
In this chapter, the influence of adiposity on the metabolic profile is demonstrated in an observational framework. These effects persist, not only when measured at different ages, but also when adjusting for covariates such as smoking, physical activity, and diet. Effects are similar across multiple measures of adiposity and to those previously reported[@Wurtz2014]. The association between adiposity and metabolites is global, with effects seen across all subclasses of metabolites. These effects are broadly consistent between metabolites within each subclass. \par

When looking at each exposure across age groups (e.g., the effects of BMI in children, adolescents, young adults, and adults), there were similar effects seen in individuals measured at multiple time points. As age increased, the number of associations within subclasses tended to increase across all measures of adiposity. Fewer associations were observed in children than in adolescents and young adults. A similar metabolic profile is apparent in adults, though effect sizes appear slightly larger. These results may reflect (i) an effect of prolonged adiposity exposure or (ii) increased variation in metabolites with age. Given that longitudinal work has shown that BMI tracks over time[@Singh2008; @Buscot2018] there may be a dose response relationship here whereby adiposity has a compounding effect on metabolites over time. Alternatively, metabolite concentrations have been shown to increase in older populations over time[@Darst2019] and there was evidence that metabolite variation tended to increase as age increased. \par

Within each age group, there was directional consistency across the three exposures. Effect sizes across exposures were similar within age groups, with overlapping confidence intervals. BMI showed a broadly stronger association on metabolites across age groups. Effects for BF appeared to be closer to, and crossed, the null more often than BMI and WHR. This may suggest that overall body composition in addition to detrimental deposition, may be driving these effects. That is, the compounding effect of increased overall body mass (primarily through increased fat mass; as estimated by BMI) and the predilection to store this additional mass viscerally (as estimated by WHR), may be more powerful than either of these effects alone on the effect of metabolites. \par

Results were consistent across models. Effect estimates showed consistent directions for the majority of tests. Effect sizes were broadly similar in the case of models 1 and 2. Effect sizes in model 3 were smaller compared with models 1 and 2. However, confidence intervals overlapped across the majority of tests even if they crossed the null in some instances for model 3. Consistency across models suggests weak evidence of confounding. Whether these results represent a true causal effect or are subject to reverse causation or residual confounding requires further investigation. \par

The key strengths of this work however are the use of (i) ALSPAC and (ii) multiple measures of adiposity to examine adipositys effects (iii) across the lifecourse. ALSPAC is a prospective cohort study with a general population base and here, analyses were performed on up to 4,450 individuals. The breadth of data measured across multiple generations enabled linear models to be adjusted for covariates that have been known to affect adiposity and metabolite concentrations[@Yu2012; @Brennan2020; @Brennan2020; @Zajacova2018; @Bonevski2014; @Afshin2019; @ODonoghue2018]. These analyses were performed across two generations of individuals, G0 and G1. Data on G1 individuals were available from multiple time points and, in combination with data from G0 individuals, enabled the investigation of adipositys effects across the lifecourse from childhood to adulthood. The use of multiple measures of adiposity, as has been recommended previously[@WorldHealthOrganisation2008; @Collaboration2009] but which has not been explored in relation to metabolic effects, may indicate that overall body composition and deposition is more important in metabolic changes than either component alone. \par

Previous work by Wurtz et al. (2014)[@Wurtz2014] identified numerous associations between BMI and metabolites in a large population. Results here show a broadly similar pattern of association with those by Wurtz et al., with the majority of the 42 comparable metabolites showing consistent directions of effect. This includes phenylalanine and tyrosine, both of which are known to be increased by adiposity and age[@Haufe2016; @Fattuoni2018; @Zheng2016a; @Ho2016; @Newgard2009; @Yu2018; @Xie2014; @Kim2010], as well as consistent negative effects on seven metabolites, including apolipoprotein A1 which is the major component of HDL particles and enables uptake of lipids by HDL and the subsequent recycle and excretion of lipids[@Feingold2000; @Marz2017]. Differences in effect estimate direction was minimal and split relatively evenly across age groups. Only one metabolite from the Wurtz et al study, fatty acid chain length, had a direction of effect (negative) that was inconsistent across all age groups here. In follow-up Mendelian randomization analysis by Wurtz et al., fatty acid chain length was found to have a positive direction of effect. \par

### Limitations
Observational analyses are limited due to issues of confounding and reverse causation. Prospective studies, such as ALSPAC, are able to provide some separation between the measurement of an exposure and outcome, and thus mitigate the potential effects of reverse causation. However, as data on adiposity measures and metabolites were collected at the same time reverse causation remains a limitation. It was however possible to account for the potential effects of confounding by adjusting linear models for potential confounders. Although many potential confounders were included across the models, it is likely these analyses will not have fully accounted for confounding, either due to measurement error or unmeasured confounding. For example, adults were asked 'do you take part in physical activity (e.g. running, swimming, dancing, golf, tennis, squash, jogging, bowls)?', with possible answers of 'no', 'occasionally (less than monthly)' and 'frequently (once a month or more)'. Broad categories such as these are unlikely to capture the full impact of physical activity given that 'frequently' will encompass individuals who exercise once a month as well as every day. In addition, although it was possible to investigate the effect of adiposity across the life course, it is likely that G1 individuals with measurement data from their teens will have been undergoing puberty. Puberty is likely to have an affect on adiposity and covariates such as physical activity, as well as the metabolome. \par

There are two key limitations in regards to metabolomics data. The first is that these data are limited in their breadth. Although a relatively large number of metabolites were investigated, they were predominantly lipid based. This leaves a broad array of metabolites that have not been investigated. As such, the metabolites investigated here are broadly reflective of the lipidome and not a global metabolic profile. The Nightingale NMR platform does however provides many derived measures, such as ratios and number of bonds. However, there was considerable variation in the concentration of these derived measures compared to directly measured metabolites. Given adipositys relationship with lipids it is unsurprising there were a large number of associations identified. There is thus a clear need to expand beyond lipid based platforms in investigating the effects of adiposity, as these effects are likely not reflective of a global metabolic profile. MS platforms, such as those used by Metabolon, are a potential next step as studies investigating adipositys effects on MS derived metabolites (which are few and far between) have used case control analyses[@Moore2018], looked at small number of individuals[@Cirulli2019], or focussed on children[@Perng2020]. \par

There is no standardised approach, nor a gold standard, for performing metabolomics quality control. Here, quality control, including outlier detection and removal, was performed using the `metaboprep` `R` package. The default settings for exclusions based on metabolite missingness (20%), sample missingness (20%), total sum abundance (5 SD), and principal components (5 SD) were used. Most samples were removed for having missingness > 20% compared to total peak area and PC. 20% sample missingness is arbitrarily defined and used among other studies[@Lotta2021], however a more stringent threshold (e.g. 5%) may have resulted in additional sample exclusions. Metadata, such as batch and runday, was not available and could not be included in quality control, though this is likely more an issue with MS data. `metaboprep` calculated the number of independent metabolites using a clustering dendorgram and a tree cut height based on a Spearman's Rho of 0.5. Although most metabolites were shared across age groups, differences in the number of independent metabolites were found. There were also differences in the number of clusters and truly independent metabolites. Similarly, inclusion of derived metabolites resulted in differing numbers of independent metabolites. Metabolites did not undergo transformation to standardise their concentrations in order to presever clinical utility and improve interpretation of results. \par

Metabolomics measures were taken at specific time points in ALSPAC children and at ~50 years of age in adults. Though measures of adiposity were available at the same time points, data on confounders were not. Smoking status for example was available for adult males at the metabolomics clinic but the closest available measure for adult females was a number of years earlier, in which time (though unlikely) they may have taken up smoking. Although data were obtained where available from the closest time point, the mismatch in timings may lead to confounded estimates, increasing the number of false positives. \par

In all age groups, the availability of data was limited. Absence of physical activity and diet data meant model 3 was not performed for children and model 2 and 3 for young adults and adults were not adjusted for diet. However, adjusting for diet, where available (children and adolescents), had little impact on results (Table \@ref(tab:observational-table-significant-results)) and is therefore likely not to have changed findings in young adults and adults. \par

In children, BF was not available. A raw impedance measure was available and derivation of BF using Equation \@ref(eq:BF) showed positive correlation with BMI and weight in children and BF measures in adolescents. However, this derived measure included numerous negative estimates of BF. The equation performed well in adolescents, correlating highly with DXA derived BF (Figure \@ref(fig:observational-figure-BF-validation-correlation-2)). The negative estimates of BF are likely a result of Equation \@ref(eq:BF) being derived in an adult population. Brief investigation showed negative estimates of BF remained when using adolescent age with child height and weight (data not shown). Given that in single frequency devices, impedance is based on the volume of an individual, it is probable that the values used in the equation do not accurately reflect the proportions of children pre-puberty. Child-specific equations were not available and the manufacturer was unwilling to share the equation used by their impedance devices. However, given that in a linear model, the estimate is based on the per-unit increase, the absolute value negative or otherwise, will likely not alter the strength of association. \par

The distribution of BMI at each age group was very similar across sexes. However, the distribution of WHR and BF differed among sexes in adolescents, young adults and adults; males had on average a higher WHR, while females had a higher BF. Though Z-scores were used and sex was included as a covariate, the differences in WHR and BF distributions may highlight an underlying difference which, if associated with metabolites, may have confounded the relationship between adiposity and metabolites. For example, hormonal contraceptive use has shown to influence the metabolome[@Rauschert2017] and may be used less often by individuals with a high BMI[@Mody2014]. \par

There was little difference in results from the three models in regards to direction of effect estimates. However, when including only individuals with physical activity (model 3), the size of effects and the number of associations reaching a multiple testing threshold decreased. This is likely an effect of reduced power given the smaller sample size for model 3. Given the consistency in the direction of effects across models and the highly similar effects across model 1 and 2, there is likely little effect of confounding. However, the possibility of unmeasured confounding can not be ruled out. \par

### Conclusion
The large number of associations identified using multiple exposures adds weight to the evidence, shown previously for BMI, of association between adiposity and metabolites. As with previous work, there were associations between adiposity and many metabolites, including increased phenylalanine and tyrosine and decreases with HDL components. This work suggests the broad and consistent effects of adiposity on a broad array of lipid metabolites likely persist over time. Though covariates were included, the potential for unmeasured confounding is likely, and follow-up analysis will require this to be taken into account. Of particular note is the increasing effect size and number of associations as a result of adiposity across the metabolic profile with age. Given that many adiposity associated diseases occur later in life, exposure to an altered metabolic profile over time may be important in disease development. This is especially true as weight loss in overweight and obese individuals is associated with a normalizing of metabolite changes[@Rangel-Huerta2019]. \par

\