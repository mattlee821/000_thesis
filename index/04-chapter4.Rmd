---
output: html_document
bibliography: bib/library.bib
csl: csl/nature.csl
space_betwee_paragraphs: true
fig_caption: true
always_allow_html: yes
link-citations: true
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# word count = 
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this will tell the .Rmd file what output you are knitting to (word, pdf, html) so that you cna use if else statements when making tables - html/pdf output tables do not work well in word. For word we need to use the 'flextable' packaged to make tables.
## packages
library(dplyr)
library(kableExtra)
library(flextable)
options(knitr.kable.NA = '')
```

# Observational analysis {#chapter4} 


<style>
body {
text-align: justify}
</style>

#### *Associations between measures of increased adiposity and metabolites: observational analysis*

In Chapters [1](#chapter1) and [2](#chapter2) the link between increased adiposity and disease was presented both in observational (Chapter 1) and causal analysis (Chapter 2) frameworks. This work highlighted key limiting areas in understanding the biological pathways leading to disease development. In this chapter observational methods will be used to assess one of the potential pathways, metabolites. The aim of this chapter is to provide an observational grounding for subsequent causal analysis work in Chapters [5](#chapter5) and [9](#chapter9).

\newpage

## Introduction
In Chapter [1](#chapter1) and [2](#chapter2) a growing body of work both observational and causal was presented linking increased adiposity to many diseases. Many of these, and others, have proposed metabolites to be involved in this process[@Bray2004; @Haslam2005; @Collaboration2009]. However, few studies have identified intermediate metabolites and pathways that lie on the disease development pathway. Only the development of diabetes appears to have a clearly described process of metabolic changes as a result of increased adiposity[@Bray2004; @Haslam2005; @Collaboration2009]. <br>

Metabolic changes as a result of increased adiposity have recently been highlighted in a systematic review[@Rangel-Huerta2019]. The studies included reveal the wide scale metabolic change as a result of obesity. However, the majority of studies included fewer than 100 individuals and all focused on obesity as a singular measure of adiposity. <br>

Analysis across thousands of individuals investigating the effects of BMI on the metabolome have however revealed a similarly wide range of effects[@Wurtz2014]. To our knowledge, the work by Wurtz et al[@Wurtz2014] is the largest investigation of the effects of increased adiposity on the metabolome to date. Their analysis, involving 88 metabolites measured in 12,664 adolescents and young adults, identified a majority of metabolites to be associated with increased BMI after adjusting for sex. In causal analysis similar results were found. Given the crude estimation of adiposity provided by BMI these effects require further consideration across a number of measures of increased adiposity. <br>

The Avon Longitudinal Study of Parents and Children (ALSPAC), a longitudinal birth cohort study, provides an opportunity to expand on this work using data from many thousands of individuals with multiple measures of increased adiposity and metabolomics data measured at multiple time points. Here, observational analysis of measures of increased adiposity and metabolites provide a basis from which to investigate causal associations. In addition, replication of results from Wurtz et al.[@Wurtz2014] is possible for a number of metabolites. <br>

\newpage

## Methods
```{r include=FALSE}
ALSPAC_N <- read.table("data/chapter4/data/metabolomics/data_prep/other/ALSPAC_N.txt", header = T, sep = "\t")
ALSPAC_QC_N <- read.table("data/chapter4/data/metabolomics/data_prep/final/qc/ALSPAC_QC_N.txt", header = T, sep = "\t")
```

Data were available for exposures (measures of increased adiposity), outcomes (metabolites), and potential confounders from the Avon Longitudinal Study of Parents and Children (ALSPAC). In ALSPAC, exposures included body mass index (BMI), waist hip ratio (WHR) and body fat percentage (BF); metabolomics data was available for up to `r max(ALSPAC_N$combined_metabolites)` metabolites; data on available confounders included: age, sex, mothers or own education, smoking history, alcohol history, diet and physical activity. All analysis and data manipulation was performed using `R`(version 3.6.2)[@r2019]. Specific `R` packages are described where appropriate. All code for this work is available on [GitHub](https://github.com/mattlee821/000_thesis/index/data/chapter4). The following ID's are associated with this work: [B3160](https://proposals.epi.bristol.ac.uk/?q=node/129769) and [B3473](https://proposals.epi.bristol.ac.uk/?q=node/130064). <br>

### Overview
The Avon Longitudinal Study of Parents and Children[@Fraser2013; @Boyd2013; @Northstone2019] is a large prospective cohort study that invited women resident in Avon, UK with expected dates of delivery between 1st April 1991 and 31st December 1992 to participate. The initial number of pregnancies enrolled was 14,541 (for these at least one questionnaire has been returned or a “Children in Focus” clinic has been attended by 19/07/99). Of these initial pregnancies, a total of 14,676 fetuses, resulted in 14,062 live births and 13,988 children alive at one year of age. <br>

When the oldest children were approximately seven years of age, an attempt was made to bolster the initial sample with eligible cases who had failed to join the study originally. As a result, when considering variables collected from the age of seven onwards (and potentially abstracted from obstetric notes) there are data available for more than the 14,541 pregnancies mentioned above. The number of new pregnancies not in the initial sample (known as Phase I enrollment) that are currently represented on the built files and reflecting enrollment status at the age of 24 is 913 (456, 262 and 195 recruited during Phases II, III and IV respectively), resulting in an additional 913 children being enrolled. The phases of enrollment are described in more detail in the cohort profile paper and its update[@Fraser2013; @Boyd2013; @Northstone2019]. The total sample size for analyses using any data collected after the age of seven is therefore 15,454 pregnancies, resulting in 15,589 fetuses, of which 14,901 were alive at one year of age. <br>

The study [website](http://www.bristol.ac.uk/alspac/) contains details of all the data that is available through a fully searchable data dictionary and [variable search tool](http://www.bristol.ac.uk/alspac/researchers/our-data/). Ethical approval for the study was obtained from the ALSPAC Ethics and Law Committee and the [Local Research Ethics Committees](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). Informed consent for the use of data collected via questionnaire and clinics was obtained from participants following recommendations of the ALSPAC Ethics and Law Committee at the time. Full details of the ALSPAC consent procedures are available on the [study website](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). <br>

ALSPAC data is split by clinic visits. For this work data for children was taken from the following clinics: Focus at 7 (~7 years old), Focus at 8 (~8 years old), Before Breakfast Study (~8 years old), Teen Focus 3 (~15 years old) Teen Focus 4 (~17 years old), Focus at 24 (~24 years old). Data on adults was taken from: Focus on Mothers 1 (~50 years old), Focus on Mothers 2 (~50 years old), and Focus on Fathers 1 (~50 years old). This data was combined into 4 categories for analysis: children (Focus at 7, Focus at 8, & Before Breakfast Study), adolescents (Teen Focus 3 and 4), young adults (Focus at 24), and adults (Focus on Mothers 1 and 2 and Focus on Fathers 1). Metabolomics data was obtained first. Where data was combined and individuals attended more than one clinic, and provided a valid measurement, data from the most recent clinic was dropped. <br>

### Outcomes: metabolites
```{r QC-data, echo=FALSE}
load("data/chapter4/data/metabolomics/data_prep/final/qc/children/MetaboQC_release/ReportData.Rdata")
children_samples_removed <- nrow(metdata) - nrow(qdata)
children_features_removed <- ncol(metdata) - ncol(qdata)
children_independent <- nrow(varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/adolescents/MetaboQC_release/ReportData.Rdata")
adolescents_samples_removed <- nrow(metdata) - nrow(qdata)
adolescents_features_removed <- ncol(metdata) - ncol(qdata)
adolescents_independent <- nrow(varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/young_adults/MetaboQC_release/ReportData.Rdata")
young_adults_samples_removed <- nrow(metdata) - nrow(qdata)
young_adults_features_removed <- ncol(metdata) - ncol(qdata)
young_adults_independent <- nrow(varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/adults/MetaboQC_release/ReportData.Rdata")
adults_samples_removed <- nrow(metdata) - nrow(qdata)
adults_features_removed <- ncol(metdata) - ncol(qdata)
adults_independent <- nrow(varexp)
```
Metabolomics data were available for all clinics in ALSPAC except Focus at 8. There were slight differences in the methodology used across time points for the children and for the fathers measurements. However, data are directly comparable. Briefly, high-throughput proton (^1^H) nuclear magnetic resonance (NMR) assays were performed on EDTA plasma/serum samples. Samples were predominantly fasted. Measurements were taken at three molecular windows (lipoprotein lipids, low molecular-weight metabolites, and lipid extracts) enabling broad quantification of over 220 metabolomic measures. Full details on the NMR methodology has previously been described[@Soininen2009; @Inouye2010; @Kettunen2012; @Soininen2015] and is available from the [ALSPAC data dictionary](http://www.bristol.ac.uk/alspac/researchers/access/) (data dictionary identifiers: children = D5704, mothers = D5705, fathers = D5700). The Before Breakfast study does not have a documentation file and is described elsewhere[@Ong2004]. <br>

Data were provided with identifiable individuals (triplets/quadruplets) and individuals with withdraw consent removed. Some mothers and fathers were duplicated in the raw data due to the way in which mothers were originally enrolled into the study and assigned IDs. If a mother enrolled with two different pregnancies (both having an expected delivery date within the recruitment period (April 1991-December 1992)), she will have two separate IDs. A father associated with both of these pregnancies will also be duplicated. Duplicate measurements for mothers and fathers were removed. Raw metabolomics data was therefore available for: Focus at 7 (n = `r ALSPAC_N$total_N[1]`; metabolites = `r ALSPAC_N$total_metabolites[1]`), Before Breakfast Study (`r ALSPAC_N$total_N[2]`; `r ALSPAC_N$total_metabolites[2]`), Teen Focus 3 (`r ALSPAC_N$total_N[3]`; `r ALSPAC_N$total_metabolites[3]`), Teen Focus 4 (`r ALSPAC_N$total_N[4]`; `r ALSPAC_N$total_metabolites[4]`), Focus at 24 (`r ALSPAC_N$total_N[5]`; `r ALSPAC_N$total_metabolites[5]`), Focus on Mothers 1 (`r ALSPAC_N$total_N[6]`; `r ALSPAC_N$total_metabolites[6]`), Focus on Mothers 2 (`r ALSPAC_N$total_N[7]`; `r ALSPAC_N$total_metabolites[7]`), Focus on Fathers (`r ALSPAC_N$total_N[8]`; `r ALSPAC_N$total_metabolites[8]`). <br> 

Data were combined where multiple clinic visits were available. For these combined data sets duplicate individuals (i.e. those attending both clinics) were identified, and the measurement from the most recent clinic dropped. The number of metabolites measured at each clinic visit for the children and adult data differed; unique metabolites were included in the combined data set. Raw, combined, metabolomics data was therefore available for: children (`r ALSPAC_N$combined_N[1]`; `r ALSPAC_N$combined_metabolites[1]`), adolescents (`r ALSPAC_N$combined_N[3]`; `r ALSPAC_N$combined_metabolites[3]`), young adults (`r ALSPAC_N$total_N[5]`; `r ALSPAC_N$total_metabolites[5]`), adults (`r ALSPAC_N$combined_N[9]`; `r ALSPAC_N$combined_metabolites[9]`; Table \@ref(tab:chapter4-table-ALSPAC-N)). </br>

\blandscape
```{r chapter4-table-ALSPAC-N, echo=FALSE}
data <- ALSPAC_N
# make table
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
  x <- knitr::kable(
    (data), longtable = F, booktabs = T,
    caption = 'Metabolomics data available in ALSPAC', row.names = F,
    col.names = c("Combined group", "N", "N\n metabolites", "Subgroup", "Subgroup\nN", "Unique\nN", "Total\nmetabolites", "Unique\nmetabolites"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-N) shows the number of individuals with metabolomics data in ALSPAC. Children were measured at 5 time points and combined into three groups (Children, Adolescents, Young adults). Mothers were measured at two time points and combined. Fathers were measured at a single time point. Combined mothers and the fathers data were grouped as Adults. N = number of individuals in the Combined group; N metabolites = the number of metabolites measured in the Combined group; Subgroup = age or clinic identifier; Subgroup N = number of individuals in the Subgroup; Unique N = the number of individuals unique to the Subgroup relative to the Combined group; Total metabolites = the number of metabolites measured for the Subgroup; Unique metabolites = as with Unique N, the total number of metabolites measured in the Subgroup not measured in the other Subgroup of that Combined group.*
\esmall
\elandscape

Quality control of the combined metabolite data (i.e. children, adolescents, young adults, adults) was performed using the `R` package [`MetaboQC`](https://github.com/MRCIEU/MetaboQC)(version 0.0.1). Metabolites and individuals were....if metabolite and individual missingness was >= 20%. Individuals were....if total peak area was > 5 standard deviations away from the mean. Individuals were....if values were > 5 standard deviations from the mean of principal component 1 and 2. <br>

Quality control resulted in: `r children_samples_removed` individuals and `r children_features_removed` metabolites removed from the children's data, `r adolescents_samples_removed` individuals and `r adolescents_features_removed` metabolites removed from the adolescents data, `r young_adults_samples_removed` individuals and `r young_adults_features_removed`metabolites removed from the young adults data, `r adults_samples_removed` individuals and `r adults_features_removed` metabolites removed from the adults data. Quality controlled metabolomics data available for analysis was therefore available for: children (n = `r ALSPAC_QC_N$N[1]`; metabolites = `r ALSPAC_QC_N$Metabolites[1]`), adolescents (`r ALSPAC_QC_N$N[2]`; `r ALSPAC_QC_N$Metabolites[2]`), young adults (`r ALSPAC_QC_N$N[3]`; `r ALSPAC_QC_N$Metabolites[3]`), adults (`r ALSPAC_QC_N$N[4]`; `r ALSPAC_QC_N$Metabolites[4]`; Table \@ref(tab:chapter4-table-ALSPAC-QC-N)). <br>

```{r chapter4-table-ALSPAC-QC-N, echo=FALSE}
data <- ALSPAC_QC_N
# make table
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
  x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Quality controlled metabolomics data available in ALSPAC', row.names = F,
    col.names = c("Group", "N", "Metabolites"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-QC-N) shows the number of individuals and metabolites available in ALSPAC after quality control of metabolomics data. Group = the groups clinic visits were combined into; N = number of individuals with available metabolomics data after quality control; Metabolites = the number of metabolites measured in the Group after quality control.*
\esmall

### Exposures: measures of increased adiposity
Measures of increased adiposity (BMI, WHR, BF) were obtained for all individuals with available raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. As metabolomics measures were obtained on unique individuals where multiple clinics were attended, anthropometric data for these individuals was taken from the clinic associated with the metabolomic measure. No anthropometric data was available for the Before Breakfast Study, instead the Focus at 8 clinic, as the most age appropriate clinic, was used. <br>

Measures for: children were taken from Focus at 7 and 8, for adolescents Teen Focus 3 and 4, for mothers Focus on Mothers 1 and 2, for fathers Focus on Fathers. Data on WHR was not available in adolescents. BMI was calculated as $\displaystyle \frac{weight(kg)}{height (m^2)}$ and WHR as $\displaystyle \frac{waist\ circumference\ (mm/cm)} {hip\ circumference\ (mm/cm)}$. BF was measured in adolescents, young adults, and adults using dual energy x-ray absorptiometry (DXA). Briefly, measurement required individuals to be prone and stationary while a Lunar prodigy narrow fan beam densitometer performed a whole body DXA scan. Data was processed using Lunar Prodigy software. Individuals did not have measurements taken if they: were pregnant; had a radiological investigation using contrast media within the week before the DXA scan; had a recent nuclear medicine investigation with persistent radioactivity; weighed greater than 159kg. BF was calculated as a percentage as $\displaystyle \frac{fat\ mass} {fat\ mass + fat\ free\ mass}\ 100$. Available anthropometric measures for individuals with metabolomics data is given in Table \@ref(tab:chapter4-table-ALSPAC-adiposity) and distributions given in Figure \@ref(fig:chapter4-figure-raincloudplot-adiposity-measures). <br>

In children BF was not measured. A bioeletrical impedance measure was available, however the derived BF calculation was not and it was not possible to calculate BF using the raw impedance value in the same way that the impedance device would have (personal communication with manufacturer see Appendix \@ref(fig:chapter4-appendix-communications-tanita)). Briefly, children were encouraged to pass urine and undress to their underclothes. A Tanita Body Fat Analyser (Model TBF 305) was used to measure weight and impedance. Height was entered to the nearest $cm$ and 'female standard' was used for all children. <br>

The Tanita Body Fat Analyser TBF 305 is a single frequency (50$kHz$) leg-to-leg device. In single frequency devices impedance is a representation of resistance which is related to the volume of water (which one assumes makes up the majority of fat free mass (FFM)), as such, the higher the resistance/impedance the greater the amount of FFM. Previous work[@Chouinard2007] has shown that comparison of BF derived from the manufacturers equation and an alternative[@Jebb2000] showed little difference in resulting BF. The equation was derived in a study involving 205 (101 women) healthy adults with a mean age of 43.8 (SD = 16) for men and 40.4 (SD = 13.6) for women. The equation, where $Z$ is the impedance measure from the device in $ohms$, height is in meters, weight is in kilograms, age is in years, and female specific components are given in parenthesis, is given as: <br>

\begin{equation}
\begin{split}
  BF = -156.1 - 89.1\ ln(height) \\
  \ +\ 45.6\ ln(weight) \\
  \ +\ 0.120\ age\ \\
  \ +\ 0.0494\ Z \\
  \ +\ (19.6\ ln(height))
\end{split}
  (\#eq:BF)
\end{equation}

Given that the equation was derived from adult data its application to child data was explored. A raw impedance measure, from a similar model (Tanita Body Fat Analyser (Model TBF 401A)), was obtained for adolescents and use of the equation at this time point was used to compare the equations use in children as both BF derived from the impedance device and DXA were available in adolescents. Exploration involved visual inspection of distribution and Spearman's correlation with BMI, height, weight and other BF measures in adolescents. The same exploration using impedance as a proxy for FFM was also performed. <br>

\blandscape
```{r chapter4-table-ALSPAC-adiposity, echo=FALSE, warning=FALSE, error=FALSE}
children_raw <- read.table("data/chapter4/data/analysis/children_raw_phenofile.txt", header = T, sep = "\t")
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_raw <- read.table("data/chapter4/data/analysis/adolescents_raw_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_raw <- read.table("data/chapter4/data/analysis/young_adults_raw_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_raw <- read.table("data/chapter4/data/analysis/adult_raw_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# adiposity table ====
adiposity_table <- data.frame(Group = c("Children", "Children", "Adolescents", "Adolescents", "Young_adults", "Young_adults", "Adults", "Adults"),
                              Metabolomics = c("raw", "qc", "raw", "qc", "raw", "qc", "raw", "qc"),
                              Metabolomics_N = c(ALSPAC_N$combined_N[1],ALSPAC_QC_N$N[1],ALSPAC_N$combined_N[3],ALSPAC_QC_N$N[2],ALSPAC_N$total_N[5],ALSPAC_QC_N$N[3],ALSPAC_N$combined_N[9],ALSPAC_QC_N$N[4]),
                              BMI_N = c(nrow(children_raw[!is.na(children_raw$bmi),]), nrow(children_qc[!is.na(children_qc$bmi),]),
                                        nrow(adolescents_raw[!is.na(adolescents_raw$bmi),]), nrow(adolescents_qc[!is.na(adolescents_qc$bmi),]),
                                        nrow(young_adults_raw[!is.na(young_adults_raw$bmi),]), nrow(young_adults_qc[!is.na(young_adults_qc$bmi),]),
                                        nrow(adults_raw[!is.na(adults_raw$bmi),]), nrow(adults_qc[!is.na(adults_qc$bmi),])),
                              BMI_mean = c(round(mean(children_raw$bmi, na.rm  = T), 2),round(mean(children_qc$bmi, na.rm  = T), 2),
                                           round(mean(adolescents_raw$bmi, na.rm  = T), 2),round(mean(adolescents_qc$bmi, na.rm  = T), 2),
                                           round(mean(young_adults_raw$bmi, na.rm  = T), 2),round(mean(young_adults_qc$bmi, na.rm  = T), 2),
                                           round(mean(adults_raw$bmi, na.rm  = T), 2),round(mean(adults_qc$bmi, na.rm  = T), 2)),
                              BMI_SD = c(round(sd(children_raw$bmi, na.rm  = T), 2),round(sd(children_qc$bmi, na.rm  = T), 2),
                                         round(sd(adolescents_raw$bmi, na.rm  = T), 2),round(sd(adolescents_qc$bmi, na.rm  = T), 2),
                                         round(sd(young_adults_raw$bmi, na.rm  = T), 2),round(sd(young_adults_qc$bmi, na.rm  = T), 2),
                                         round(sd(adults_raw$bmi, na.rm  = T), 2),round(sd(adults_qc$bmi, na.rm  = T), 2)),
                              WHR_N = c(nrow(children_raw[!is.na(children_raw$whr),]), nrow(children_qc[!is.na(children_qc$whr),]),
                                        NA, NA,
                                        nrow(young_adults_raw[!is.na(young_adults_raw$whr),]), nrow(young_adults_qc[!is.na(young_adults_qc$whr),]),
                                        nrow(adults_raw[!is.na(adults_raw$whr),]), nrow(adults_qc[!is.na(adults_qc$whr),])),
                              WHR_mean = c(round(mean(children_raw$whr, na.rm  = T), 2),round(mean(children_qc$whr, na.rm  = T), 2),
                                           NA,NA,
                                           round(mean(young_adults_raw$whr, na.rm  = T), 2),round(mean(young_adults_qc$whr, na.rm  = T), 2),
                                           round(mean(adults_raw$whr, na.rm  = T), 2),round(mean(adults_qc$whr, na.rm  = T), 2)),
                              WHR_SD = c(round(sd(children_raw$whr, na.rm  = T), 2),round(sd(children_qc$whr, na.rm  = T), 2),
                                         NA,NA,
                                         round(sd(young_adults_raw$whr, na.rm  = T), 2),round(sd(young_adults_qc$whr, na.rm  = T), 2),
                                         round(sd(adults_raw$whr, na.rm  = T), 2),round(sd(adults_qc$whr, na.rm  = T), 2)),
                              BF_N = c(nrow(children_raw[!is.na(children_raw$bf),]), nrow(children_qc[!is.na(children_qc$bf),]),
                                       nrow(adolescents_raw[!is.na(adolescents_raw$bf),]), nrow(adolescents_qc[!is.na(adolescents_qc$bf),]),
                                       nrow(young_adults_raw[!is.na(young_adults_raw$bf),]), nrow(young_adults_qc[!is.na(young_adults_qc$bf),]),
                                       nrow(adults_raw[!is.na(adults_raw$bf),]), nrow(adults_qc[!is.na(adults_qc$bf),])),
                              BF_mean = c(round(mean(children_raw$bf, na.rm  = T), 2),round(mean(children_qc$bf, na.rm  = T), 2),
                                          round(mean(adolescents_raw$bf, na.rm  = T), 2),round(mean(adolescents_qc$bf, na.rm  = T), 2),
                                          round(mean(young_adults_raw$bf, na.rm  = T), 2),round(mean(young_adults_qc$bf, na.rm  = T), 2),
                                          round(mean(adults_raw$bf, na.rm  = T), 2),round(mean(adults_qc$bf, na.rm  = T), 2)),
                              BF_SD = c(round(sd(children_raw$bf, na.rm  = T), 2),round(sd(children_qc$bf, na.rm  = T), 2),
                                        round(sd(adolescents_raw$bf, na.rm  = T), 2),round(sd(adolescents_qc$bf, na.rm  = T), 2),
                                        round(sd(young_adults_raw$bf, na.rm  = T), 2),round(sd(young_adults_qc$bf, na.rm  = T), 2),
                                        round(sd(adults_raw$bf, na.rm  = T), 2),round(sd(adults_qc$bf, na.rm  = T), 2))
                              )
data <- adiposity_table
# make table ====
if (doc.type == "docx") { 
  x <- data
  
  } else { 

if (doc.type != "docx") { 
    x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Measures of increased adiposity available for individuals with metabolomics data', row.names = F, col.names = c("Group","Data","N", "BMI N","mean","SD","WHR N","mean","SD","BF N","mean","SD"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
#=====
rm(children_raw,children_qc,adolescents_raw,adolescents_qc,young_adults_raw,young_adults_qc,adults_raw,adults_qc,adiposity_table)
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-adiposity) gives information on measures of increased adiposity for individuals with metabolomics data. Measures were obtained for all individuals who had raw metabolomics data; WHR was not available for adolescents. Group = the groups clinic visits were combined into; Data = whether the data presented is for the raw or the QC'd metabolomics data; N = the number of individuals with available data; mean = the mean of the anthropometric measure; SD = standard deviation of the mean. NA = data not available.*
\esmall
\elandscape

```{r chapter4-figure-raincloudplot-adiposity-measures, echo=FALSE, out.width='100%', fig.cap="Raincloud plots of ALSPAC individuals data on measures of increased adiposity"}
knitr::include_graphics("data/chapter4/figures/plot_raincloud_adiposity_measures.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-raincloudplot-adiposity-measures) shows the distribution of adiposity measures among different groups separated by sex. Data is presented for individuals with raw metabolomics data and of known sex. The interquartile range and median are also shown. From left to right: children, adolescents, young adults, adults. From top to bottom: body mass index (BMI), waist hip ratio (WHR), body fat percentage (BF). Data is organised with males at the top and females at the bottom of each individual plot. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019]*
\esmall


### Confounders
```{r ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
children_raw <- read.table("data/chapter4/data/analysis/children_raw_phenofile.txt", header = T, sep = "\t")
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_raw <- read.table("data/chapter4/data/analysis/adolescents_raw_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_raw <- read.table("data/chapter4/data/analysis/young_adults_raw_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_raw <- read.table("data/chapter4/data/analysis/adult_raw_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# table ====
data <- data.frame(Group = c("Children", "Children", "Adolescents", "Adolescents", "Young_adults", "Young_adults", "Adults", "Adults"),
                              Metabolomics = c("raw", "qc", "raw", "qc", "raw", "qc", "raw", "qc"),
                              Metabolomics_N = c(ALSPAC_N$combined_N[1],ALSPAC_QC_N$N[1],ALSPAC_N$combined_N[3],ALSPAC_QC_N$N[2],ALSPAC_N$total_N[5],ALSPAC_QC_N$N[3],ALSPAC_N$combined_N[9],ALSPAC_QC_N$N[4]),
                              age_N = c(nrow(children_raw[!is.na(children_raw$age),]), nrow(children_qc[!is.na(children_qc$age),]),
                                        nrow(adolescents_raw[!is.na(adolescents_raw$age),]), nrow(adolescents_qc[!is.na(adolescents_qc$age),]),
                                        nrow(young_adults_raw[!is.na(young_adults_raw$age),]), nrow(young_adults_qc[!is.na(young_adults_qc$age),]),
                                        nrow(adults_raw[!is.na(adults_raw$age),]), nrow(adults_qc[!is.na(adults_qc$age),])),
                              age_mean = c(round(mean(children_raw$age, na.rm  = T), 2),round(mean(children_qc$age, na.rm  = T), 2),
                                           round(mean(adolescents_raw$age, na.rm  = T), 2),round(mean(adolescents_qc$age, na.rm  = T), 2),
                                           round(mean(young_adults_raw$age, na.rm  = T), 2),round(mean(young_adults_qc$age, na.rm  = T), 2),
                                           round(mean(adults_raw$age, na.rm  = T), 2),round(mean(adults_qc$age, na.rm  = T), 2)),
                              age_SD = c(round(sd(children_raw$age, na.rm  = T), 2),round(sd(children_qc$age, na.rm  = T), 2),
                                         round(sd(adolescents_raw$age, na.rm  = T), 2),round(sd(adolescents_qc$age, na.rm  = T), 2),
                                         round(sd(young_adults_raw$age, na.rm  = T), 2),round(sd(young_adults_qc$age, na.rm  = T), 2),
                                         round(sd(adults_raw$age, na.rm  = T), 2),round(sd(adults_qc$age, na.rm  = T), 2)),
                              sex_N = c(nrow(children_raw[!is.na(children_raw$sex),]), nrow(children_qc[!is.na(children_qc$sex),]),
                                        nrow(adolescents_raw[!is.na(adolescents_raw$sex),]), nrow(adolescents_qc[!is.na(adolescents_qc$sex),]),
                                        nrow(young_adults_raw[!is.na(young_adults_raw$sex),]), nrow(young_adults_qc[!is.na(young_adults_qc$sex),]),
                                        nrow(adults_raw[!is.na(adults_raw$sex),]), nrow(adults_qc[!is.na(adults_qc$sex),])),
                              sex_female = c(table(children_raw$sex)[[2]], table(children_qc$sex)[[2]],
                                             table(adolescents_raw$sex)[[2]], table(adolescents_qc$sex)[[2]],
                                             table(young_adults_raw$sex)[[2]], table(young_adults_qc$sex)[[2]],
                                             table(adults_raw$sex)[[2]], table(adults_qc$sex)[[2]]),
                              education_N = c(nrow(children_raw[!is.na(children_raw$maternal_education),]), nrow(children_qc[!is.na(children_qc$maternal_education),]),
                                                       nrow(adolescents_raw[!is.na(adolescents_raw$maternal_education),]), nrow(adolescents_qc[!is.na(adolescents_qc$maternal_education),]),
                                                       nrow(young_adults_raw[!is.na(young_adults_raw$maternal_education),]), nrow(young_adults_qc[!is.na(young_adults_qc$maternal_education),]),
                                                       nrow(adults_raw[!is.na(adults_raw$education),]), nrow(adults_qc[!is.na(adults_qc$education),])),
                              education_mean = c(round(mean(children_raw$maternal_education, na.rm  = T), 2),round(mean(children_qc$maternal_education, na.rm  = T), 2),
                                                          round(mean(adolescents_raw$maternal_education, na.rm  = T), 2),round(mean(adolescents_qc$maternal_education, na.rm  = T), 2),
                                                          round(mean(young_adults_raw$maternal_education, na.rm  = T), 2),round(mean(young_adults_qc$maternal_education, na.rm  = T), 2),
                                                          round(mean(adults_raw$education, na.rm  = T), 2),round(mean(adults_qc$education, na.rm  = T), 2)),
                              education_SD = c(round(sd(children_raw$maternal_education, na.rm  = T), 2),round(sd(children_qc$maternal_education, na.rm  = T), 2),
                                                        round(sd(adolescents_raw$maternal_education, na.rm  = T), 2),round(sd(adolescents_qc$maternal_education, na.rm  = T), 2),
                                                        round(sd(young_adults_raw$maternal_education, na.rm  = T), 2),round(sd(young_adults_qc$maternal_education, na.rm  = T), 2),
                                                        round(sd(adults_raw$education, na.rm  = T), 2),round(sd(adults_qc$education, na.rm  = T), 2)),
                              ever_smoked_N = c(NA,NA,
                                                nrow(adolescents_raw[!is.na(adolescents_raw$ever_smoked),]), nrow(adolescents_qc[!is.na(adolescents_qc$ever_smoked),]),
                                                nrow(young_adults_raw[!is.na(young_adults_raw$ever_smoked),]), nrow(young_adults_qc[!is.na(young_adults_qc$ever_smoked),]),
                                                nrow(adults_raw[!is.na(adults_raw$ever_smoked),]), nrow(adults_qc[!is.na(adults_qc$ever_smoked),])),
                              frequency_alcohol_N = c(NA,NA,
                                                      nrow(adolescents_raw[!is.na(adolescents_raw$frequency_alcohol),]), nrow(adolescents_qc[!is.na(adolescents_qc$frequency_alcohol),]),
                                                      nrow(young_adults_raw[!is.na(young_adults_raw$frequency_alcohol),]), nrow(young_adults_qc[!is.na(young_adults_qc$frequency_alcohol),]),
                                                      nrow(adults_raw[!is.na(adults_raw$frequency_alcohol),]), nrow(adults_qc[!is.na(adults_qc$frequency_alcohol),])),
                              frequency_alcohol_mean = c(NA,NA,
                                                         round(mean(adolescents_raw$frequency_alcohol, na.rm  = T), 2),round(mean(adolescents_qc$frequency_alcohol, na.rm  = T), 2),
                                                         round(mean(young_adults_raw$frequency_alcohol, na.rm  = T), 2),round(mean(young_adults_qc$frequency_alcohol, na.rm  = T), 2),
                                                         round(mean(adults_raw$frequency_alcohol, na.rm  = T), 2),round(mean(adults_qc$frequency_alcohol, na.rm  = T), 2)),
                              frequency_alcohol_SD = c(NA,NA,
                                                       round(sd(adolescents_raw$frequency_alcohol, na.rm  = T), 2),round(sd(adolescents_qc$frequency_alcohol, na.rm  = T), 2),
                                                       round(sd(young_adults_raw$frequency_alcohol, na.rm  = T), 2),round(sd(young_adults_qc$frequency_alcohol, na.rm  = T), 2),
                                                       round(sd(adults_raw$frequency_alcohol, na.rm  = T), 2),round(sd(adults_qc$frequency_alcohol, na.rm  = T), 2)),
                              diet_N = c(nrow(children_raw[!is.na(children_raw$diet),]), nrow(children_qc[!is.na(children_qc$diet),]),
                                         nrow(adolescents_raw[!is.na(adolescents_raw$diet),]), nrow(adolescents_qc[!is.na(adolescents_qc$diet),]),
                                         NA,NA,
                                         NA,NA),
                              diet_mean = c(round(mean(children_raw$diet, na.rm  = T), 2),round(mean(children_qc$diet, na.rm  = T), 2),
                                            round(mean(adolescents_raw$diet, na.rm  = T), 2),round(mean(adolescents_qc$diet, na.rm  = T), 2),
                                            NA,NA,
                                            NA,NA),
                              diet_SD = c(round(sd(children_raw$diet, na.rm  = T), 2),round(sd(children_qc$diet, na.rm  = T), 2),
                                          round(sd(adolescents_raw$diet, na.rm  = T), 2),round(sd(adolescents_qc$diet, na.rm  = T), 2),
                                          NA,NA,
                                          NA,NA),
                              physical_activity_N = c(NA,NA,
                                                      nrow(adolescents_raw[!is.na(adolescents_raw$physical_activity),]), nrow(adolescents_qc[!is.na(adolescents_qc$physical_activity),]),
                                                      nrow(young_adults_raw[!is.na(young_adults_raw$physical_activity),]), nrow(young_adults_qc[!is.na(young_adults_qc$physical_activity),]),
                                                      nrow(adults_raw[!is.na(adults_raw$physical_activity),]), nrow(adults_qc[!is.na(adults_qc$physical_activity),])),
                              physical_activity_mean = c(NA,NA,
                                                         round(mean(adolescents_raw$physical_activity, na.rm  = T), 2),round(mean(adolescents_qc$physical_activity, na.rm  = T), 2),
                                                         round(mean(young_adults_raw$physical_activity, na.rm  = T), 2),round(mean(young_adults_qc$physical_activity, na.rm  = T), 2),
                                                         round(mean(adults_raw$physical_activity, na.rm  = T), 2),round(mean(adults_qc$physical_activity, na.rm  = T), 2)),
                              physical_activity_SD = c(NA,NA,
                                                       round(sd(adolescents_raw$physical_activity, na.rm  = T), 2),round(sd(adolescents_qc$physical_activity, na.rm  = T), 2),
                                                       round(sd(young_adults_raw$physical_activity, na.rm  = T), 2),round(sd(young_adults_qc$physical_activity, na.rm  = T), 2),
                                                       round(sd(adults_raw$physical_activity, na.rm  = T), 2),round(sd(adults_qc$physical_activity, na.rm  = T), 2))
)
data1 <- data[,c(1:12)]
data2 <- data[,c(1:3,13:21)]


```

Data on confounders were obtained for all individuals with raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. The following confounders were used: age, sex, maternal/own education, smoking, alcohol, diet, physical activity. Age was taken from the metabolomics clinic visit. Data on the number of individuals with available data is given in Table \@ref(tab:chapter4-table-ALSPAC-confounders). <br>

Maternal education was used for children, adolescents and young adults. Own education was used for mothers and mother reported partner education was used for fathers. Specifically, mothers were asked, during their pregnancy, 'What educational qualifications do you, your partner, your mother, and your father have?' with possible answers: CSE or GCSE (D, E, F or G), O-level or GCSE (A, B, or C), A-level, qualifications in shorthand/ typing/or other skills, e.g. hairdressing, apprenticeship, state enrolled nurse, state registered nurse, City and Guilds intermediate technical, City & Guilds final technical, City & Guilds full technical, teaching qualification, university degree, no qualification, qualifications not known, not applicable, other (please describe). <br>

Smoking was binary; adolescents (at the metabolomics clinic), young adults (at the metabolomics clinic), and adults (mothers were asked during pregnancy; fathers were asked in 2013) were asked whether they had ever smoked a cigarette before. <br>

Adolescents (Teen Focus 3) were asked what their alcohol drinking pattern was with possible answers: only ever tried drinking once/twice, used to drink sometimes [but] never drink now, sometimes drink but less than once a week, usually drink on 1/2 days a week, usually drink on >2 days a week but not every day, usually drink every day. Adolescents (Teen Focus 4), young adults (at the metabolomics clinic), mothers (in 2013), and fathers (at the metabolomics clinic) were asked the frequency they had drinks containing alcohol with possible answers: never, monthly or less, two to four times a month, two to three times a week, four or more times a week. <br>

Diet data was available from[@Anderson2013] as predicted kilo-calories consumed per day at ages 7 and 13. Data from age 7 was matched with metabolomics data for children while data from age 13 was matched with adolescents. Diet data was not available elsewhere. <br>

Physical activity was not available for children. In adolescents and young adults, accelerometry data was collected at the metabolomics clinic. Briefly, individuals wore an accelerometry device for the days following their clinic visit whilst keeping a diary of the times they wore and took off the device. Individuals were advised to wear the accelerometer device if the following days were part of a ‘normal week’ with regards to their activity. For young adults physical activity data is the average number of minutes per day spent doing moderate to vigorous physical activity. For adolescents data was available from Teen Focus 3 and is the mean counts per minute spent doing moderate to vigorous physical activity for the whole week. Adults were asked 'do you take part in physical activity (e.g. running, swimming, dancing, golf, tennis, squash, jogging, bowls)?' with possible answers: no, occasionally (less than monthly), frequently (once a month or more). Data for mothers was available in 2010, fathers data was available at the metabolomics clinic. <br>

\blandscape
```{r chapter4-table-ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
# make table ====
if (doc.type == "docx") { 
x <- data1
x1 <- data2
  
} else { 
  
  if (doc.type != "docx") { 
    x <- knitr::kable(
      (data1), longtable = T, booktabs = T,
      caption = 'Confounders available for individuals with raw metabolomics data', row.names = F, col.names = c("Group","Data","N","Age N","mean","SD","Sex N","female","Education N","mean","SD","Smoking N"))
    x <- kable_styling(x, full_width = F) 
    
    x1 <- knitr::kable(
      (data2), longtable = T, booktabs = T,
      row.names = F, col.names = c("Group","Data","N","Alcohol N","mean","SD","Diet N","mean","SD","PA N","mean","SD"))
    x1 <- kable_styling(x1, full_width = F) 
    
    
  } else {
    
  }
}
#=====
rm(children_raw,children_qc,adolescents_raw,adolescents_qc,young_adults_raw,young_adults_qc,adults_raw,adults_qc,data,data1,data2)
x
```
\elandscape

\blandscape
```{r echo=FALSE, warning=FALSE, error=FALSE}
x1
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-confounders) gives information on confounders for individuals with metabolomics data. Data on confounders were obtained for all individuals who had raw metabolomics data. Smoking and alcohol data were not available for children. Diet was not available for young adults and adults. Physical activity data was not available for children. Education is highest level of education; for children, adolescents, and young adults education is maternal education; for adults education is own education. Smoking is binary. Alcohol is frequency respondent consumes an alcoholic drink, with 1 being low and 5 high. Diet is predicted kilo-calories from[@Anderson2013]. Physical activity in adolescents is mean counts per minute of activity across 7 days (based on valid days). For young adults physical activity is the average number of valid minutes per day spent doing moderate to vigorous activity. For adults, physical activity is: no physical activity (1), occasionally (2), frequently (3). Group = the groups clinic visits were combined into; Data = whether the data presented is for the raw or the QC'd metabolomics data; N = the number of individuals with available data; mean = the mean of the measure; SD = standard deviation of the mean. NA = data not available.*
\esmall
\elandscape

### Statistical analysis
To investigate the association between measures of increased adiposity and metabolites, linear regression was performed using Z-scores. Three linear models were used to investigate potential effects of confounding with model 1 considered the main analysis. For models 1 and 2 the N was fixed (Table \@ref(tab:chapter4-table-ALSPAC-analysis-N)); model 3 was a complete case analysis. Variables known to influence the metabolomic profile (age[@Yu2012; @Brennan2020] and sex[@Brennan2020]) as well as be associated with health and socioeconomic status (education[@Zajacova2018], smoking[@Bonevski2014], alcohol[@Bonevski2014], diet[@Afshin2019], and physical activity[@ODonoghue2018]), were included as confounders. Model 1 included age at the metabolomics clinic visit and sex. Model 2 included model 1 and mothers/own level of highest education, whether respondent had ever smoked, frequency respondent had a drink containing alcohol, and predicted kilo-calories consumed per day (diet). Model 3 comprised model 2 and physical activity. <br>

```{r chapter4-table-ALSPAC-analysis-N, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

children_qc_raw <- children_qc[,c(2,4,6)]
children_qc_raw<- children_qc_raw[complete.cases(children_qc_raw), ]
adolescents_qc_raw <- adolescents_qc[,c(2,4)]
adolescents_qc_raw<- adolescents_qc_raw[complete.cases(adolescents_qc_raw), ]
young_adults_qc_raw <- young_adults_qc[,c(2,4,6)]
young_adults_qc_raw<- young_adults_qc_raw[complete.cases(young_adults_qc_raw), ]
adults_qc_raw <- adults_qc[,c(2,4,6)]
adults_qc_raw<- adults_qc_raw[complete.cases(adults_qc_raw), ]

children_qc_complete <- children_qc[complete.cases(children_qc), ]
adolescents_qc_complete <- adolescents_qc[,c(1:11,13:ncol(adolescents_qc))]
adolescents_qc_complete <- adolescents_qc_complete[complete.cases(adolescents_qc_complete), ]
young_adults_qc_complete <- young_adults_qc[,c(1:12,14:ncol(young_adults_qc))]
young_adults_qc_complete <- young_adults_qc_complete[complete.cases(young_adults_qc_complete), ]
adults_qc_complete <- adults_qc[,c(1:12,14:ncol(adults_qc))]
adults_qc_complete <- adults_qc_complete[complete.cases(adults_qc_complete), ]

qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
children <- qc[complete.cases(qc), ]
qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
adolescents <- qc[complete.cases(qc), ]
qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
young_adults <- qc[complete.cases(qc), ]
qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")
adults <- qc[complete.cases(qc), ]

# adiposity table ====
data <- data.frame(group = c("Children", "Adolescents", "Young adults", "Adults"),
                   N = c(nrow(children_qc_raw),nrow(adolescents_qc_raw),nrow(young_adults_qc_raw),nrow(adults_qc_raw)),
                   models = c(nrow(children_qc_complete),nrow(adolescents_qc_complete),nrow(young_adults_qc_complete),nrow(adults_qc_complete)),
                   model_3 = c(NA,nrow(adolescents),nrow(young_adults),nrow(adults)))

# make table ====
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
    x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Number of individuals included in statistical analysis', row.names = F, col.names = c("Group","N","Model 1 & 2", "Model 3"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
#=====
rm(children_qc,adolescents_qc,young_adults_qc,adults_qc,data)
```
\noindent
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-analysis-N) gives the number of individuals included in the linear regression analysis. Group = the groups clinic visits were combined into; N = the complete number of individuals with available metabolomics data and data on all three exposures; Model 1 & 2 = complete cases across all exposures and confounders except physical activity; Model 3 = complete case analysis. Physical activity data not available for Children.*
\esmall

Model 1 was performed for all groups. Models 2 and 3 were performed as follows: for Children, model 2 (physical activity data was not available); for adolescents, models 2 and 3; for young adults, models 2 and 3 (diet was not available for model 2); for adults, models 2 and 3 (diet was not available for model 2). For all analyses the units represent a change in the rank normally transformed position of the metabolite per standard deviation change in the exposure. Ninety-five percent confidence intervals were calculated and a multiple testing threshold specific for each group was applied. Multiple testing thresholds were calculated as the number of independent metabolites within the raw data given a Spearman’s rho of approximately 0.75 among the metabolites with data for at least 20% of samples - this was calculated during metabolite quality control. The number of independent metabolites in each group was: children = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent` <br>

#### Presentation
Metabolites were grouped into subclasses (grouping data provided by the metabolomics platform) based on biological pathway with a *Ratios* group for derived measures. The main analysis (model 1) is presented for each age group using Circos plots to enable comparison across exposures -- *Ratios*, *Lipoprotein particle size*, and *Fatty acid ratios* were displayed separately. All analyses were visualised using forestplots, created using the `ggforestplot` `R` package, and  rainplots[@Henglin2019] created using the `rainplots` `R` package, to look for consistency in the direction of effect across models. All sensitivity analysis is available as supplement to this chapter (see \@ref(chapter4-appendix)) and on [GitHub](https://github.com/mattlee821/000_thesis/tree/master/index/data/chapter4/supplement). <br>

\newpage
## Results
### Validation of impedance
A measure of BF was not available in children. Instead raw impedance ($ohms$) was used to calculate (Equation \@ref(eq:BF)) BF. The calculated BF resulted in negative estimates of BF for some children (Figure \@ref(fig:chapter4-figure-BF-validation-distribution)). Calculated BF was positively correlated with weight, height and BMI. In adolescents calculated BF did not produce negative estimates. Adolescent calculated BF was positively correlated with weight, height, and BMI (Figure \@ref(fig:chapter4-figure-BF-validation-correlation)). Child and adolescent calculated BF positively correlated with adolescent measures of BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). <br>

The same observations were undertaken for raw impedance. In children and adolescents raw impedance negatively correlated with BMI and weight, but showed little evidence for a correlation with height (Figure \@ref(fig:chapter4-figure-BF-validation-distribution)). Similarly, there was weak evidence for correlation between impedance in children and adolescents and adolescent measures of BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). <br>

```{r chapter4-figure-BF-validation-distribution, echo=FALSE, out.width='100%', fig.cap="Raincloud plots of impedance and BF in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_raincloud.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-distribution) shows the distribution of the raw impedance value measured in $ohms$ and BF derived using equation \@ref(eq:BF) for children and adolescents. Data is presented for complete cases across: raw metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. The interquartile range and median are also shown. Data is organised with males at the top and females at the bottom of each individual plot. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019]*
\esmall

```{r chapter4-figure-BF-validation-correlation, echo=FALSE, out.width='100%', fig.cap="Correlation between BF and BMI, height, and weight in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_correlation.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-correlation) shows correlations for impedance and BF for children (columns 1 and 2) and adolescents (columns 3-6) with BMI (top row), weight (middle row), and height (bottom row). BF_calculates is BF derived using the raw impedance value measured in ohms and equation \@ref(eq:BF). Data is presented for complete cases across: raw metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. Data for men is shown in grey and women in red.*
\esmall

```{r chapter4-figure-BF-validation-correlation-2, echo=FALSE, out.width='100%', fig.cap="Correlation between differnet BF measures in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_correlation_bf.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2) shows correlations for BF calculated using equation \@ref(eq:BF) in children and adolescents. Column 1 shows correlations between child impedance values and and adolescent BF estimates. Column 2 shows correlations for child calculated BF and adolescent BF estimates. Column 3 shows correlations for adolescent calculated BF and adolescent BF estimates. Data is presented for complete cases across: raw metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. Data for men is shown in grey and women in red.*
\esmall

### Statistical analysis
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
```
Given the negative estimates of BF produced in children using equation \@ref(eq:BF) and lack of evidence to support a correlation between raw impedance and measures of BF, statistical analysis used raw impedance as a proxy for FFM. As the contents of the bodies volume is comprised of FFM (which includes bone) and fat mass, the inverse of the resulting effect estimates will approximate (given that it is not necessarily the case that the inverse of FFM is fat mass as fat mass also contains water) the effect of a decrease in FFM on metabolites. <br>

In total `r nrow(data)` tests were performed across the four age groups, with `r table(data$model)` tests performed for models 1, 2, and 3 respectively. The majority of tests within each age group and exposure (eg. Children BMI) resulted in directionally consistent effect estimates (Figure \@ref(fig:chapter4-figure-directional-consistency)). The strength of the effect estimates were broadly consistent across models with most change observed at model 3; *p-values* were broadly consistent for models 1 and 2 and mostly higher for model 3 (Supplementary \@ref(chapter4-appendix-figures-rainplots)). Confidence intervals overlapped across the majority of metabolites for all models within each group and exposure (Supplementary \@ref(chapter4-appendix-figures-forestplots)). As such only model 1 is discussed from here on.<br>

```{r chapter4-figure-directional-consistency, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap="Directional consistency across linear models"}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,13,14,15)]
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## seperate data into exposures ====
children_bmi <- subset(children, exposure == "bmi")
children_whr <- subset(children, exposure == "whr")
children_bf <- subset(children, exposure == "bf")
adolescents_bmi <- subset(adolescents, exposure == "bmi")
adolescents_whr <- subset(adolescents, exposure == "whr")
adolescents_bf <- subset(adolescents, exposure == "bf")
young_adults_bmi <- subset(young_adults, exposure == "bmi")
young_adults_whr <- subset(young_adults, exposure == "whr")
young_adults_bf <- subset(young_adults, exposure == "bf")
adults_bmi <- subset(adults, exposure == "bmi")
adults_whr <- subset(adults, exposure == "whr")
adults_bf <- subset(adults, exposure == "bf")

## convert to wide based on model ====
children_bmi <- spread(children_bmi, model, b)
children_whr <- spread(children_whr, model, b)
children_bf <- spread(children_bf, model, b)
adolescents_bmi <- spread(adolescents_bmi, model, b)
adolescents_whr <- spread(adolescents_whr, model, b)
adolescents_bf <- spread(adolescents_bf, model, b)
young_adults_bmi <- spread(young_adults_bmi, model, b)
young_adults_whr <- spread(young_adults_whr, model, b)
young_adults_bf <- spread(young_adults_bf, model, b)
adults_bmi <- spread(adults_bmi, model, b)
adults_whr <- spread(adults_whr, model, b)
adults_bf <- spread(adults_bf, model, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children_bmi ====
data <- children_bmi[,c(4:ncol(children_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_bmi <- data
children_bmi$exposure <- "children_bmi"
### children_whr ====
data <- children_whr[,c(4:ncol(children_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_whr <- data
children_whr$exposure <- "children_whr"


### children_bf ====
data <- children_bf[,c(4:ncol(children_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_bf <- data
children_bf$exposure <- "children_ffm"

### adolescents_bmi ====
data <- adolescents_bmi[,c(4:ncol(adolescents_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents_bmi <- data
adolescents_bmi$exposure <- "adolescents_bmi"

### adolescents_bf ====
data <- adolescents_bf[,c(4:ncol(adolescents_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents_bf <- data
adolescents_bf$exposure <- "adolescents_bf"

### young_adults_bmi ====
data <- young_adults_bmi[,c(4:ncol(young_adults_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_bmi <- data
young_adults_bmi$exposure <- "young_adults_bmi"

### young_adults_whr ====
data <- young_adults_whr[,c(4:ncol(young_adults_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_whr <- data
young_adults_whr$exposure <- "young_adults_whr"

### young_adults_bf ====
data <- young_adults_bf[,c(4:ncol(young_adults_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_bf <- data
young_adults_bf$exposure <- "young_adults_bf"

### adults_bmi ====
data <- adults_bmi[,c(4:ncol(adults_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_bmi <- data
adults_bmi$exposure <- "adults_bmi"

### adults_whr ====
data <- adults_whr[,c(4:ncol(adults_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_whr <- data
adults_whr$exposure <- "adults_whr"

### adults_bf ====
data <- adults_bf[,c(4:ncol(adults_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_bf <- data
adults_bf$exposure <- "adults_bf"

## join data frames ====
data <- bind_rows(children_bmi,children_whr,children_bf,adolescents_bmi,adolescents_bf,young_adults_bmi,young_adults_whr,young_adults_bf,adults_bmi,adults_whr,adults_bf)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure )[c(6,8,7,2,1,10,9,11,4,5,3)])
# plot ====
ggplot(data = data,
       aes(x = exposure)) +
  geom_bar(aes(fill = direction_group))  +
  scale_fill_manual(values = discrete_wes_pal) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                             title = "",
                             label.hjust = 0,
                             label.vjust = 0.5)) +
  xlab("") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank())
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-directional-consistency) shows the directional consistency of all models for each group and exposure A positive effect reflects both model betas being in the positive direction; a negative effect reflects both model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; FFM = fat free mass; BF = body fat percentage.*
\esmall

The effects of the three exposures (BMI, WHR, BF (FFM in children)) within each age group showed mostly consistent directions of effect, with the most inconsistent directions present in children (Figure \@ref(fig:chapter4-figure-directional-consistency-2)) -- a result of comparing increases in BMI and WHR with an increase in FFM. However, when taking into account the inverse of the effect estimate, and thus a decrease in FFM, directional consistency was in line with the other age groups (Figure \@ref(fig:chapter4-figure-directional-consistency)). <br>

```{r chapter4-figure-directional-consistency-2, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap="Directional consistency across exposures within each age group"}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,13,14,15)]
data <- subset(data, model == "model1")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children ====
data <- children[,c(4:ncol(children))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_normal <- data
children_normal$exposure <- "children"
### children inverse
data <- children[,c(4:ncol(children))]
data <- data[complete.cases(data), ]
data$direction = sapply( 1:nrow(data), function(i){
	## set data vector
	x = sign( data[i, ] )
	##
	if( x[1] == -1 & sum(x[2:3]) == 2 ){
		direct = 1
	} else{
		if( x[1] == 1 & sum(x[2:3]) == -2 ){
		direct = 2
		} else {
			direct = 3
		}
	}
	}
)
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 3 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_inverse <- data
children_inverse$exposure <- "children_inverse"
### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$exposure <- "adolescents"
### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$exposure <- "young_adults"
### adults ====
data <- adults[,c(4:ncol(adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$exposure <- "adults"
## join data frames ====
data <- bind_rows(children_normal,children_inverse,adolescents,young_adults,adults)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure)[c(3,4,1,5,2)])
# plot ====
ggplot(data = data,
       aes(x = exposure)) +
  geom_bar(aes(fill = direction_group))  +
  scale_fill_manual(values = discrete_wes_pal) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                             title = "",
                             label.hjust = 0,
                             label.vjust = 0.5)) +
  xlab("") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank())
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-directional-consistency-2) shows the directional consistency of all exposures for each age group. A positive effect reflects effect estimates for all exposures being in the positive direction; a negative effect reflects effect estimates being in the negative direction; opposite effect reflects different directions for the effect estimates across the exposures.*
\esmall

```{r echo=FALSE, warning=FALSE, error=FALSE}
library(tidyr)
# how many consistent significnat effects
# main analysis, consistent direction, significant ====
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data_all <- data
data <- subset(data, model == "model1")
children <- subset(data, group == "children")
children_no_ffm <- subset(children, exposure != "bf")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

n_children <- nrow(children)/3
n_children_no_ffm <- nrow(children_no_ffm)/2
n_adolescents <- nrow(adolescents)/2
n_young_adults <- nrow(young_adults)/3
n_adults <- nrow(adults)/3

## subset for multiple testing threshold ====
children <- subset(children, p <= 0.05/54)
children_no_ffm <- subset(children_no_ffm, p <= 0.05/54)
adolescents <- subset(adolescents, p <= 0.05/48)
young_adults <- subset(young_adults, p <= 0.05/46)
adults <- subset(adults, p <= 0.05/53)

# limit to interested rows ====
children <- children[,c(1,3,13,14,15)]
children_no_ffm <- children_no_ffm[,c(1,3,13,14,15)]
adolescents <- adolescents[,c(1,3,13,14,15)]
young_adults <- young_adults[,c(1,3,13,14,15)]
adults <- adults[,c(1,3,13,14,15)]


## convert to wide based on model ====
children <- spread(children, exposure, b)
children_no_ffm <- spread(children_no_ffm, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

### children ====
data <- children[,c(4:ncol(children))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$group <- "children"

### children_no_ffm ====
data <- children_no_ffm[,c(4:ncol(children_no_ffm))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_no_ffm <- data
children_no_ffm$group <- "children_no_ffm"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$group <- "adolescents"

### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$group <- "young_adults"

### adults ====
data <- adults[,c(4:ncol(adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$group <- "adults"

```

```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/54)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/54)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/54)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/54)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/54)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/54)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/48)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/48)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/48)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/48)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/48)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/48)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/46)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/46)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/46)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/53)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/53)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/53)



# precent of total ====
children_m1_bmi_percent <- nrow(children_m1_bmi_sig) / nrow(children_m1_bmi) * 100
children_m2_bmi_percent <- nrow(children_m2_bmi_sig) / nrow(children_m2_bmi) * 100
children_m1_whr_percent <- nrow(children_m1_whr_sig) / nrow(children_m1_whr) * 100
children_m2_whr_percent <- nrow(children_m2_whr_sig) / nrow(children_m2_whr) * 100
children_m1_bf_percent <- nrow(children_m1_bf_sig) / nrow(children_m1_bf) * 100
children_m2_bf_percent <- nrow(children_m2_bf_sig) / nrow(children_m2_bf) * 100
adolescents_m1_bmi_percent <- nrow(adolescents_m1_bmi_sig) / nrow(adolescents_m1_bmi) * 100
adolescents_m2_bmi_percent <- nrow(adolescents_m2_bmi_sig) / nrow(adolescents_m2_bmi) * 100
adolescents_m3_bmi_percent <- nrow(adolescents_m3_bmi_sig) / nrow(adolescents_m3_bmi) * 100
adolescents_m1_bf_percent <- nrow(adolescents_m1_bf_sig) / nrow(adolescents_m1_bf) * 100
adolescents_m2_bf_percent <- nrow(adolescents_m2_bf_sig) / nrow(adolescents_m2_bf) * 100
adolescents_m3_bf_percent <- nrow(adolescents_m3_bf_sig) / nrow(adolescents_m3_bf) * 100
young_adults_m1_bmi_percent <- nrow(young_adults_m1_bmi_sig) / nrow(young_adults_m1_bmi) * 100
young_adults_m2_bmi_percent <- nrow(young_adults_m2_bmi_sig) / nrow(young_adults_m2_bmi) * 100
young_adults_m3_bmi_percent <- nrow(young_adults_m3_bmi_sig) / nrow(young_adults_m3_bmi) * 100
young_adults_m1_whr_percent <- nrow(young_adults_m1_whr_sig) / nrow(young_adults_m1_whr) * 100
young_adults_m2_whr_percent <- nrow(young_adults_m2_whr_sig) / nrow(young_adults_m2_whr) * 100
young_adults_m3_whr_percent <- nrow(young_adults_m3_whr_sig) / nrow(young_adults_m3_whr) * 100
young_adults_m1_bf_percent <- nrow(young_adults_m1_bf_sig) / nrow(young_adults_m1_bf) * 100
young_adults_m2_bf_percent <- nrow(young_adults_m2_bf_sig) / nrow(young_adults_m2_bf) * 100
young_adults_m3_bf_percent <- nrow(young_adults_m3_bf_sig) / nrow(young_adults_m3_bf) * 100
adults_m1_bmi_percent <- nrow(adults_m1_bmi_sig) / nrow(adults_m1_bmi) * 100
adults_m2_bmi_percent <- nrow(adults_m2_bmi_sig) / nrow(adults_m2_bmi) * 100
adults_m3_bmi_percent <- nrow(adults_m3_bmi_sig) / nrow(adults_m3_bmi) * 100
adults_m1_whr_percent <- nrow(adults_m1_whr_sig) / nrow(adults_m1_whr) * 100
adults_m2_whr_percent <- nrow(adults_m2_whr_sig) / nrow(adults_m2_whr) * 100
adults_m3_whr_percent <- nrow(adults_m3_whr_sig) / nrow(adults_m3_whr) * 100
adults_m1_bf_percent <- nrow(adults_m1_bf_sig) / nrow(adults_m1_bf) * 100
adults_m2_bf_percent <- nrow(adults_m2_bf_sig) / nrow(adults_m2_bf) * 100
adults_m3_bf_percent <- nrow(adults_m3_bf_sig) / nrow(adults_m3_bf) * 100

min_significant_percent <- min(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent)

max_significant_percent <- max(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent)

mean_significnat_percent <- mean(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent)

median_significant_percent <- median(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent)

# percent change ====
adolescents_m1_m3_bmi_percent_change <- (nrow(adolescents_m1_bmi_sig) - nrow(adolescents_m3_bmi_sig)) / nrow(adolescents_m1_bmi_sig) * 100


```

Across all models and exposures between `r min_significant_percent` and `r max_significant_percent` (median = `r median_significant_percent`) metabolites reached a multiple testing threshold (children multiple testing threshold = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`; Table \@ref(tab:chapter4-table-significant-results)). Of those with a consistent direction of effect across the three exposures (using the inverse effect estimates of FFM in children) a total of `r nrow(children)`, `r nrow(adolescents)`, `r nrow(young_adults)`, and `r nrow(adults)` metabolites reached a multiple testing threshold for children, adolescents, young adults, and adults respectively. This equates to `r round(nrow(children)/n_children*100)`, `r round(nrow(adolescents)/n_adolescents*100)`, `r round(nrow(young_adults)/n_young_adults*100)`, and `r round(nrow(adults)/n_adults*100)` percent of metabolites. After removing FFM from the comparison in children, `r nrow(children_no_ffm)` consistent directions for metabolites reaching a multiple testing threshold between BMI and WHR were found. This equates to `r round(nrow(children_no_ffm)/n_children_no_ffm*100)` percent of metabolites. <br>

```{r chapter4-table-significant-results, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/54)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/54)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/54)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/54)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/54)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/54)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/48)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/48)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/48)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/48)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/48)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/48)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/46)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/46)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/46)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/53)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/53)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/53)

# table data frame ====
data <- data.frame(group = c("Children", "Adolescents", "Young adults", "Adults"),
                   metabolites = c(nrow(children_m1_bmi), nrow(adolescents_m1_bmi), nrow(young_adults_m1_bmi), nrow(adults_m1_bmi)),
                   m1_bmi = c(nrow(children_m1_bmi_sig), nrow(adolescents_m1_bmi_sig), nrow(young_adults_m1_bmi_sig), nrow(adults_m1_bmi_sig)),
                   m2_bmi = c(nrow(children_m2_bmi_sig), nrow(adolescents_m2_bmi_sig), nrow(young_adults_m2_bmi_sig), nrow(adults_m2_bmi_sig)),
                   m3_bmi = c("", nrow(adolescents_m3_bmi_sig), nrow(young_adults_m3_bmi_sig), nrow(adults_m3_bmi_sig)),
                   m1_whr = c(nrow(children_m1_whr_sig), "", nrow(young_adults_m1_whr_sig), nrow(adults_m1_whr_sig)),
                   m2_whr = c(nrow(children_m2_whr_sig), "", nrow(young_adults_m2_whr_sig), nrow(adults_m2_whr_sig)),
                   m3_whr = c("", "", nrow(young_adults_m3_whr_sig), nrow(adults_m3_whr_sig)),
                   m1_bf = c(nrow(children_m1_bf_sig), nrow(adolescents_m1_bf_sig), nrow(young_adults_m1_bf_sig), nrow(adults_m1_bf_sig)),
                   m2_bf = c(nrow(children_m2_bf_sig), nrow(adolescents_m2_bf_sig), nrow(young_adults_m2_bf_sig), nrow(adults_m2_bf_sig)),
                   m3_bf = c("", nrow(adolescents_m3_bf_sig), nrow(young_adults_m3_bf_sig), nrow(adults_m3_bf_sig))
                   )


# make table ====
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
    x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Metabolites reaching a multiple testing threshold', row.names = F, col.names = c("","N","1","2","3","1","2","3","1","2","3"))
  x <- kable_styling(x, full_width = F) %>%
    add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3))
} else {

}
}
x

```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-significant-results) shows the number of metabolites reaching a multiple testing threshold for each model within each age group. Multiple testing thresholds: children = 54, adolescents = 48, young adults = 46, adults = 53. N = total number of metabolites tested; BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage (in children this is fat free mass); 1 = model 1 adjustment for age and sex; 2 = model 2 adjustment for model 1 plus maternal/own education, smoking status, alcohol frequency, diet (where available); 3 = model 3, adjustment for model 2 plus physical activity (where available).*
\esmall

```{r echo=FALSE, warning=FALSE, error=FALSE}
# data ====
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data <- subset(data, subclass != "NA")
# shared metabolites ====
a <- subset(data, model == "model1")
a <- subset(a, exposure == "bmi")
b <- subset(a, group == "children")
c <- subset(a, group == "adolescents")
d <- subset(a, group == "young_adults")
e <- subset(a, group == "adults")
b <- as.data.frame(b[,1])
colnames(b) <- "metabolite"
b$group <- "children"
c <- as.data.frame(c[,1])
colnames(c) <- "metabolite"
c$group <- "adolescents"
d <- as.data.frame(d[,1])
colnames(d) <- "metabolite"
d$group <- "young_adults"
e <- as.data.frame(e[,1])
colnames(e) <- "metabolite"
e$group <- "adults"
f <- full_join(b,c, by = "metabolite")
f <- full_join(f,d, by = "metabolite")
f <- full_join(f,e, by = "metabolite")
metabolites <- f[complete.cases(f), ]
metabolites <- metabolites[,1]
metabolites <- droplevels(metabolites)

# n in each plot
plot_data <- subset(data, exposure == "bmi")
plot_data <- subset(plot_data, model == "model1")
plot_data <- plot_data[plot_data$metabolite %in% metabolites, ]
plot_data <- subset(plot_data, group == "children")
ratios <- subset(plot_data, subclass == "Ratios")
fa_ratios <- subset(plot_data, subclass == "Fatty acids ratios")
lp_size <- subset(plot_data, subclass == "Lipoprotein particle size")


```

There was high similarity between effect estimates within exposures across age groups (see Supplement \@ref(chapter4-appendix-correlations)). A total of `r nlevels(metabolites)` metabolites were measured in all age groups. Removing the *Ratios* (n = `r nrow(ratios)`), *Fatty acids ratios* (`r nrow(fa_ratios)`), and *Lipoprotein particle size* (`r nrow(lp_size)`) subclasses (Supplementary \@ref(chapter4-appendix-circosplot-supplement)) revealed highly similar metabolic profiles between children, adolescents, and young adults (Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BMI)) and adults, adolescents, and young adults (Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BMI-2)) for BMI, WHR (Figure \@ref(fig:chapter4-figure-circosplot-main-groups-WHR)), and BF (Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BF-2). The exception being child's FFM which showed an inverse association compared to the other groups (Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BF). Circos plots comparing the metabolic profiles across exposures within each age group are given in the Supplement (Supplementary \@ref(chapter4-appendix-circosplot-supplement2)) <br>

\newpage
```{r chapter4-figure-circosplot-main-groups-BMI, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of BMI and metabolites in children, adolescents, and young adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_BMI_children_adolescents_young_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BMI) shows each track as an age group; the outer track is children, the middle track is adolescents, the inner track is young adults. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46).*
\esmall

\newpage
```{r chapter4-figure-circosplot-main-groups-BMI-2, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of BMI and metabolites in adults, adolescents, and young adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_BMI_adults_adolescents_young_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BMI-2) shows each track as an age group; the outer track is adults, the middle track is adolescents, the inner track is young adults. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46).*
\esmall

\newpage
```{r chapter4-figure-circosplot-main-groups-WHR, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of WHR and metabolites in children, young adults, and adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_WHR_children_young_adults_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BMI-2) shows each track as an age group; the outer track is children, the middle track is young adults, the inner track is  adults. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46).*
\esmall

```{r chapter4-figure-circosplot-main-groups-BF, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of BF and metabolites in children, adolescents, and young adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_BF_children_adolescents_young_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BF) shows each track as an age group; the outer track is children, the middle track is adolescents, the inner track is young adults. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46). In children BF is FFM.*
\esmall

\newpage
```{r chapter4-figure-circosplot-main-groups-BF-2, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of BF and metabolites in adults, adolescents, and young adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_BF_adults_adolescents_young_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-groups-BF-2) shows each track as an age group; the outer track is adults, the middle track is adolescents, the inner track is young adults. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46).*
\esmall

\newpage

## Discussion
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data_main <- subset(data, model == "model1")
data_main <- subset(data_main, subclass != "Ratios")
data_main <- subset(data_main, subclass != "Fatty acids ratios")
data_main <- subset(data_main, subclass != "Lipoprotein particle size")
```
In this chapter the influence of increased adiposity on the metabolic profile is demonstrated in an observational framework. These effects persist, not only when measured at different ages, but also when adjusted for confounders and when examined across multiple measures of increased adiposity In the main analysis (model 1 and not including the subclasses *Ratios*, *Fatty acids ratios*, and *Lipoprotein particle size*) effects ranged from `r round(min(data_main$b))` to `r round(max(data_main$b))` with a median of `r round(median(data_main$b))`. The largest positive effects (> 0.1) were seen for Total fatty acids and mono-unsaturated fatty acids; the largest negative effects (< -0.1) were for Total lipids in large HDL and Total cholesterol in HDL. <br>

### Global metabolic profile
#### Across models: within exposures and groups
Across the models (within age group and within exposure) consistency in the direction of effect estimates were observed for the majority of tests. The effect size was broadly similar in the case of models 1 and 2. There was a decreases in effect sizes in model 3 compared with 1 and 2. However, confidence intervals overlapped across the majority of tests even if they crossed the null in some instances for model 3. <br>

The largest difference in directional consistency across models was observed for children's FFM. This may be explained by the fact that a raw impedance measure does not give a definitive value for FFM. Rather, impedance is a proxy for FFM and further calculation, which was not available, is required to obtain a FFM value. Measures of BF in adolescents and young adults showed the highest level of directional inconsistency within their respective age groups across the three models. In both instances DXA was used to measure BF, as the gold standard measure for BF -- though still with limitations, one must make a hard call as to whether an image pixel is fat mass or fat free mass -- this may suggest potential interaction with confounders. Additionally, in both adolescents and young adults physical activity (included in model 3) was much more specific with accelerometry data used. Whereas in adults, where directional inconsistency was not as pronounced for BF, physical activity was questionnaire based and limited in scope -- the maximum choice for respondents was once a month or more. <br>

#### Across exposures: within groups
In the main analysis (model 1), within each age group, there was high directional consistency across the three exposures for adolescents, young adults, and adults. In children, directional consistency was low and when using an inverse FFM effect estimate, directional consistency was still much lower than for the other age groups. Restricting to BMI and WHR exposures in children improved directional consistency to 54% of tests. Across all age groups BF appears to drive the directional inconsistency with inverse associations to that of BMI and WHR. Effect sizes across exposures were similar with overlapping confidence intervals for BMI and WHR. Effects for BF appeared to be closer to, and crossed, the null more often than BMI and WHR. <br>

#### Across groups: within exposures
In the main analysis when looking at each exposure across age groups (e.g. the effects of BMI in children, adolescents, young adults, and adults) we find highly similar effects in individuals measured at multiple time points (children, adolescents, and young adults). A similar metabolic profile is apparent in adults, though effect sizes appear slightly larger. The larger effects seen in adults may be due to the fact that metabolite concentrations have been shown to increase in older populations over time[@Darst2019]. Given that longitudinal work has shown that BMI tracks over time[@Singh2008; @Buscot2018] there may be a dose response relationship here whereby increased adiposity over time leads to increased metabolite concentrations. <br>

#### Comparison to previous work
Previous work[@Wurtz2014] identified numerous associations between BMI and metabolites in a large population. Results here are broadly in line with theirs in terms of effect direction. However, the effect sizes identified differed. This is likely due to differences in metabolite data preparation; here metabolites were inverse rank transformed as opposed to some metabolites being log transformed and all concentrations scaled to SD units. Of note are consistent results between apolipoprotein B and A1, phenylalanine and tyrosine, monounsaturated fatty acids, glycolysis related metabolites, and glycoprotein acetyls. Comparison with lipid subfractions is difficult because of the limited measures previously, however effects show broad agreement. <br>

### Limitations

#### Metabolomics
There is no standardised gold standard for performing metabolomics quality control. Here, quality control, including outlier detection and removal, was performed using the `MetaboQC` `R` package. The default settings for exclusions based on metabolite missingness (20%), sample missingness (20%), total peak area (5 SD), and principal components (5 SD) were used. Most samples were removed for having missingness > 20% (n = 620) compared to total peak area (4) and PC (12). Twenty percent sample missingness is arbitrarily defined and used among other studies[@Lotta2020], however a more stringent threshold (e.g. 5%) may have impacted on results. Especially given that metadata such as batch and runday information was not available. `MetaboQC` calculated the number of independent metabolites using a clustering dendorgram and a tree cut height based on a Spearman's Rho of ~0.75. Most metabolites were shared across age groups, however differences in the number of independent metabolites were found. There were similarly differences in the number of clusters and truly independent metabolites.

#### Data availability
Metabolomics measures were taken at specific time points in ALSPAC children and at ~50 years of age in adults. Though measures of increased adiposity were available at the same time points, data on confounders was not. Smoking status for example was available for adult males at the metabolomics clinic but the closest available measure for adult females was a number of years earlier, in which time they may have taken up smoking. Although data were obtained where available from the closest time point, the mismatch in timings may bias results, particularly in the case of smoking and alcohol consumption. <br>

In all age groups the availability of data was limiting. Absence of physical activity data meant model 3 was not performed for children, while absence of diet data in young adults and adults meant models 2 and 3 where constrained. The absence of diet data in young adults and adults may have affected the results of model 2 and 3 given that in adolescents where diet -- and all other confounders -- were available associations reaching a multiple testing threshold were much fewer than in models 1 and 2 (Table \@ref(tab:chapter4-table-significant-results)). <br>

In children body fat percentage was not available. A raw impedance measure was available and derivation of BF using Equation \@ref(eq:BF) showed positive correlation with BMI and weight in children and BF measures in adolescents. However, this derived measure included numerous negative estimates of BF. The equation performed well in adolescents, correlating highly with DXA derived BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). The negative estimates of BF are likely a result of Equation \@ref(eq:BF) being derived in an adult population. Brief investigation showed negative estimates of BF remained when using adolescent age with child height and weight (data not shown). Given that in single frequency devices impedance is based on the volume of an individual it is probable that the values used in the equation do not accurately reflect the proportions of children pre-puberty. Child specific equations were not available and the manufacturer was unwilling to share the equation used by their impedance devices. As such, raw impedance was used as a proxy for fat free mass in analyses. It should be noted that though impedance was negatively correlated with BMI and weight in children, and that the bodies total mass is made up of fat free mass and fat mass, this does not mean that the inverse of fat free mass is fat mass. This is because resistance in impedance devices is increased with an increase in water content and both fat free mass and fat mass are comprised of water. In addition, the impedance value of an individual with volume $X$ may be identical to an individual with volume $Y$ because their fat free mass content may be different i.e. volume and fat free mass are not equivalent. <br>

#### Sensitivity analyses
The distribution of BMI at each age group was very similar across sexes. However, the distribution of WHR and BF differed among sexes in adolescents, young adults and adults; men had on average a higher WHR while women had a higher BF. Though Z-scores were used and sex was included as a confounder in the main and sensitivity analyses the differences in WHR and BF distributions may highlight an underlying difference which confounds the relationship between adiposity and metabolites. For example, hormonal contraceptive use has shown to influence the metabolome[@Rauschert2017] and is not regularly taken by individuals with a high BMI[@Mody2014]. Sensitivity analyses did not highlight large differences to that of the main analysis, even when performing a complete case analysis in model 3. That being said, this work is not comprehensive of all possible confounders and there is likely residual confounding. <br>

### Summary
The large number of associations identified using multiple exposures adds weight to the evidence, shown previously for BMI, of association between increased adiposity and metabolites. As with previous work, we find associations between increased adiposity and many metabolites, including increased phenylalanine and tyrosine and decreased HDL components. This work highlights the large effects of increased adiposity on the global metabolic profile and shows that effects likely persist over time. Puberty is likely to have an affect on both adiposity, physical activity, and the metabolome and the lack of available data in children (BF and physical activity) means this requires further investigation, particularly as the adolescent time point used will have included post-pubertal individuals. Though confounders were taken into account residual confounding is likely and follow-up analysis will require this to be taken into account. <br>





## Acknowledgments

The following ALSPAC identifiers are associated with the work in this chapter: B3473, B3160, B3230. <br>

We are extremely grateful to all the families who took part in this study, the midwives for their help in recruiting them, and the whole ALSPAC team, which includes interviewers, computer and laboratory technicians, clerical workers, research scientists, volunteers, managers, receptionists and nurses. <br>

Ethical approval for the study was obtained from the ALSPAC Ethics and Law Committee and the Local Research Ethics Committees. Consent for biological samples has been collected in accordance with the Human Tissue Act (2004). Informed consent for the use of data collected via questionnaires and clinics was obtained from participants following the recommendations of the ALSPAC Ethics and Law Committee at the time. <br>

I would like to thank Emma Anderson for providing the diet trajectory data used in this analysis.



