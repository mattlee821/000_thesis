---
output: 
    thesisdown::thesis_pdf: default
bibliography: bib/thesis.bib
csl: csl/nature.csl
space_betwee_paragraphs: true
fig_caption: true
always_allow_html: yes
link-citations: true
toc-depth: 2
lot: true
lof: true
indent: true
header-includes: # include other LaTeX packages here
    \usepackage{booktabs}
    \usepackage{longtable}
    \usepackage{siunitx}
    \usepackage[left]{lineno}
    \usepackage{float}
    \floatplacement{figure}{H}
    \linenumbers
    \pagestyle{plain}
    \raggedbottom 
    \usepackage{indentfirst}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# word count = 
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this will tell the .Rmd file what output you are knitting to (word, pdf, html) so that you cna use if else statements when making tables - html/pdf output tables do not work well in word. For word we need to use the 'flextable' packaged to make tables.
## packages
library(dplyr)
library(kableExtra)
library(flextable)
options(knitr.kable.NA = '')
```

# Associations between multiple measures of adiposity and metabolites: observational analysis {#observational} 
```{r include=FALSE}
ALSPAC_N <- read.table("data/observational/data/metabolomics/data_prep/other/ALSPAC_N.txt", header = T, sep = "\t")
ALSPAC_QC_N <- read.table("data/observational/data/metabolomics/data_prep/final/qc/ALSPAC_QC_N.txt", header = T, sep = "\t")
```


<style>
body {
text-align: justify}
</style>

## Chapter Summary {-}

In Chapters [1](#chapter1) and [2](#chapter2), the link between increased adiposity and disease was presented both in observational and causal analysis frameworks. This work highlighted key limiting areas in understanding the biological pathways leading to disease development. In this chapter, observational epidemiological methods will be used to assess one of the potential pathways linking adiposity to disease, metabolites. The aim of this chapter is to provide an observational grounding for subsequent causal analysis work in Chapters [5](#chapter5) and [9](#chapter9).

#### Contribution statement {-}
All of the work in this chapter was performed by myself.

\newpage

## Introduction {#observational-intro} 
Overweight and obesity are global health concerns, with ~39% and ~13% of individuals classed as overweight or obese[@WorldHealthOrganisation2018; @Ritchie2019]. Increased adiposity is associated with an increased risk of numerous diseases as well as mortality[@Flegal2013; @Lee2015; @Elagizi2018; @Jenkins2018; @Pischon2008; @Rost2018; @Mørkedal2011; @Dong2018; @Lee2018; @Bigaard2004] and is estimated to be responsible for 8% of global deaths[@Stanaway2018]. With these numbers expected to increase[@Ng2014; @NCD-RisC2016; @Abarca-Gomez2017] intervention strategies that reduce the burden of adiposity are important. \par

Previous work has highlighted many potential pathways, such as metabolites[@Bray2004; @Haslam2005; @Collaboration2009], linking increased adiposity with diseases such as cancer[@Bhaskaran2014], CHD[@Paul2006; @Koliaki2019], and type 2 diabetes[@Al-Goblan2014]. As discussed in Section \@ref(previous-work), adiposity has been associated with many metabolites[@Wurtz2014; @Moore2014; @SantosFerreira2017; @Cirulli2019; @Lau2020; @Brachem2020; @Stevens2020; @Wulaningsih2019; @Frigerio2021; @Neeland2019; @Bachlechner2016; @Rangel-Huerta2019]. Although there is evidence to show these associations vary between sexes and over time[@Wurtz2014], the focus of many analyses has been on BMI as an instrument for overall adiposity, has included small sample sizes[@Rangel-Huerta2019], and has looked at a single time-point. \par

While BMI correlates well with, and is a predictor of, many health outcomes[@Donato1998; @NIH2013], is is a crude measure of adiposity with several issues, not least the inability to differentiate lean and fat mass[@Flegal2009]. As discussed in Section \@ref(adiposity-measures), evidence highlights the importance of complimentary assessments of adiposity using multiple measures[@WorldHealthOrganisation2008; @Collaboration2009]. In the largest study to date by Wurtz et al. (2014)[@Wurtz2014], a majority of metabolites were associated with BMI across numerous metabolic classes including amino acids, fatty acids, hormones, inflammatory markers, and lipids. \par

The effects of adiposity are shown to present early in life[@Bibbins-Domingo2007; @Hannon2005; @Baer2005; @Swerdlow2002; @Biro2010]. Few studies have repeated metabolomic measures and are able to investigate the association between adiposity and metabolites over time. The Avon Longitudinal Study of Parents and Children (ALSPAC), a longitudinal birth cohort study, with repeated metabolomic and anthropometric measures, provides an opportunity to expand on the current literature. Here, observational analysis of measures of adiposity and metabolites provide a basis from which to investigate causal associations. In addition, comparison with previous work by from Wurtz et al.[@Wurtz2014] is possible for a number of metabolites. \par

## Methods {#observational-methods} 
Data were available for exposures (measures of adiposity), outcomes (metabolites), and potential confounders from ALSPAC. In ALSPAC, exposures included body mass index (BMI), waist hip ratio (WHR) and body fat percentage (BF; bioelectrical impedance and dual energy x-ray absorptiometry (DXA)); metabolomics data was available for up to `r ALSPAC_N$combined_metabolites[[1]]` metabolites, which included metabolite ratios; data on available confounders included: age, sex, mothers or own education, smoking history, alcohol history, diet, physical activity. All analysis and data manipulation was performed using `R` (version 3.6.2)[@r2019]. Specific `R` packages are described where appropriate. All code for this work is available on [GitHub](https://github.com/mattlee821/000_thesis/index/data/). \par

### Overview: ALSPAC (NOTE: a lot of info in first 3 paras is required by ALSPAC in their documentation - unsure what i can get rid of)
The Avon Longitudinal Study of Parents and Children[@Fraser2013; @Boyd2013; @Northstone2019] is a large prospective cohort study that invited women resident in Avon, UK with expected dates of delivery between 1st April 1991 and 31st December 1992 to participate. The initial number of pregnancies enrolled was 14,541 (for these at least one questionnaire has been returned or a “Children in Focus” clinic has been attended by 19/07/99). Of these initial pregnancies, a total of 14,676 fetuses, resulted in 14,062 live births and 13,988 children alive at one year of age. \par

When the oldest children were approximately seven years of age, an attempt was made to bolster the initial sample with eligible cases who had failed to join the study originally. As a result, when considering variables collected from the age of seven onwards (and potentially abstracted from obstetric notes) there are data available for more than the 14,541 pregnancies mentioned above. The number of new pregnancies not in the initial sample (known as Phase I enrollment) that are currently represented on the built files and reflecting enrollment status at the age of 24 is 913 (456, 262 and 195 recruited during Phases II, III and IV respectively), resulting in an additional 913 children being enrolled. The phases of enrollment are described in more detail in the cohort profile paper and its update[@Fraser2013; @Boyd2013; @Northstone2019]. The total sample size for analyses using any data collected after the age of seven is therefore 15,454 pregnancies, resulting in 15,589 fetuses, of which 14,901 were alive at one year of age. \par

The study [website](http://www.bristol.ac.uk/alspac/) contains details of all the data that is available through a fully searchable data dictionary and [variable search tool](http://www.bristol.ac.uk/alspac/researchers/our-data/). Ethical approval for the study was obtained from the ALSPAC Ethics and Law Committee and the [Local Research Ethics Committees](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). Informed consent for the use of data collected via questionnaire and clinics was obtained from participants following recommendations of the ALSPAC Ethics and Law Committee at the time. Full details of the ALSPAC consent procedures are available on the [study website](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). \par

Data in ALSPAC is split by clinic visits. For this work, data for children was taken from the following clinics: Focus at 7 (~7 years old), Focus at 8 (~8 years old), Before Breakfast Study (~8 years old), Teen Focus 3 (~15 years old) Teen Focus 4 (~17 years old), Focus at 24 (~24 years old). Data on adults was taken from: Focus on Mothers 1 (~50 years old), Focus on Mothers 2 (~50 years old), and Focus on Fathers 1 (~50 years old). The Before Breakfast Study only collected metabolomics data, as such data on exposures and confounders were extracted for these individuals from the Focus at 8 clinic. Metabolomics data for each time point were extracted first and subsequent data on exposures and confounders were extracted for individuals with metabolomics data. \par

### Outcomes: metabolites
```{r QC-data, echo=FALSE}
load("data/observational/data/metabolomics/data_prep/final/qc/children/MetaboQC_release/ReportData.Rdata")
children_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
children_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
children_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/adolescents/MetaboQC_release/ReportData.Rdata")
adolescents_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adolescents_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adolescents_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/young_adults/MetaboQC_release/ReportData.Rdata")
young_adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
young_adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
young_adults_independent <- nrow(qc_data$varexp)

load("data/observational/data/metabolomics/data_prep/final/qc/adults/MetaboQC_release/ReportData.Rdata")
adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adults_independent <- nrow(qc_data$varexp)
```
Briefly, high-throughput proton (^1^H) nuclear magnetic resonance (NMR) assays were performed on EDTA plasma/serum samples. Samples were predominantly fasted. Measurements were taken at three molecular windows (lipoprotein lipids, low molecular-weight metabolites, and lipid extracts) enabling broad quantification of over 220 metabolomic measures. These measures also included derived measures, lipoprotein paarticle size, and fatty acid ratios, inclusion of which has shown to increase overall power in statistical analyses[@Altmaier2008; @Gieger2008; @Suhre2010]. Full details on the NMR methodology has previously been described[@Soininen2009; @Inouye2010; @Kettunen2012; @Soininen2015] and is available from the [ALSPAC data dictionary](http://www.bristol.ac.uk/alspac/researchers/access/) (data dictionary identifiers: children = D5704, mothers = D5705, fathers = D5700). The Before Breakfast study does not have a documentation file and is described elsewhere[@Ong2004]. Descriptions of metabolites are available in the Appendix \@ref(appendix-observational-metabolites). \par

The spectral NMR data was processed by Nightingale Health and provided as a processed file with identifiable individuals (triplets/quadruplets) and individuals who had withdrawn consent removed. Some mothers and fathers were duplicated in the raw data due to the way in which mothers were originally enrolled into the study and assigned IDs. If a mother enrolled with two different pregnancies (both having an expected delivery date within the recruitment period (April 1991-December 1992)), she will have two separate IDs. A father associated with both of these pregnancies will also be duplicated. Duplicate measurements for mothers and fathers were removed. Raw metabolomics data was therefore available for: Focus at 7 (n = `r ALSPAC_N$total_N[1]`; metabolites = `r ALSPAC_N$total_metabolites[1]`), Before Breakfast Study (n = `r ALSPAC_N$total_N[2]`; metabolites = `r ALSPAC_N$total_metabolites[2]`), Teen Focus 3 (n = `r ALSPAC_N$total_N[3]`; metabolites = `r ALSPAC_N$total_metabolites[3]`), Teen Focus 4 (n = `r ALSPAC_N$total_N[4]`; metabolites = `r ALSPAC_N$total_metabolites[4]`), Focus at 24 (n = `r ALSPAC_N$total_N[5]`; metabolites = `r ALSPAC_N$total_metabolites[5]`), Focus on Mothers 1 (n = `r ALSPAC_N$total_N[6]`; metabolites = `r ALSPAC_N$total_metabolites[6]`), Focus on Mothers 2 (n = `r ALSPAC_N$total_N[7]`; metabolites = `r ALSPAC_N$total_metabolites[7]`), Focus on Fathers (n = `r ALSPAC_N$total_N[8]`; metabolites = `r ALSPAC_N$total_metabolites[8]`). Metabolites includes derived ratios. \par 

In order to maximize the sample size at each clinic, data were combined where clinics were within a similar age range. For these combined data sets, duplicate individuals (i.e. those attending both clinics) were identified, and the measurement from the most recent clinic was dropped as these clinics tended to have fewer overall individuals. The number of metabolites measured at each clinic visit for the children and adult data differed; unique metabolites were included in the combined data set. Raw, combined, metabolomics data was therefore available for: children (mean age (SD) = 7.56 (0.36); n = `r ALSPAC_N$combined_N[1]`; metabolites = `r ALSPAC_N$combined_metabolites[1]`), adolescents (mean age (SD) = 16.06 (1.11); n = `r ALSPAC_N$combined_N[3]`; metabolites = `r ALSPAC_N$combined_metabolites[3]`), young adults (mean age (SD) = 24.03 (0.85); n = `r ALSPAC_N$total_N[5]`; metabolites = `r ALSPAC_N$total_metabolites[5]`), adults (mean age (SD) = 49.53 (5.32)n = `r ALSPAC_N$combined_N[9]`; metabolites = `r ALSPAC_N$combined_metabolites[9]`; Table \@ref(tab:observational-table-ALSPAC-N)). </br>

Quality control of the combined metabolite data (i.e. children, adolescents, young adults, adults) was performed using the `R` package [`metaboprep`](https://github.com/MRCIEU/metaboprep) (version 0.0.1). Quality control was performed twice, firstly including and secondly excluding the derived metabolomics measures from missingness and clustering. Briefly, individuals, and then metabolites, with high missingness (>=80%) were removed. Missingness was then re-calculated for individuals and metabolites, with removal based on 20% missingness. Individuals were then removed based on total sum abundance, considering outliers as > 5 standard deviations away from the mean. Using this metabolite data set, a dendrogram based on a Spearman's rho distance matrix is produced, and a set of clusters identified based on a Spearman's rho of 0.5. For each cluster, the metabolite with the least missingness is tagged as the representative feature. Finally, principal component analysis is conducted using the representative features to evaluate structure among individuals. Outliers are identified as being > 5 standard deviations away from the mean of principal component 1 and 2 and were excluded. \par

### Exposures: adiposity
Measures of adiposity (BMI, WHR, BF) were obtained for all individuals with available raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. As metabolomics measures were obtained on unique individuals where multiple clinics were attended, anthropometric data for these individuals were taken from the clinic associated with the metabolomic measure. No anthropometric data was available for the Before Breakfast Study, so the Focus at 8 clinic, as the most age appropriate clinic, was used instead. For this combined data, Focus at 7 measures were matched with Focus at 7 metabolomics measures and Focus at 8 measures were matched with Before Breakfast Study metabolomics measures. \par

Measures for children were taken from Focus at 7 and 8, for adolescents Teen Focus 3 and 4, for mothers Focus on Mothers 1 and 2, for fathers Focus on Fathers. Data on WHR was not available in adolescents. BMI was calculated as $\displaystyle \frac{weight(kg)}{height (m^2)}$ and WHR as $\displaystyle \frac{waist\ circumference\ (cm)} {hip\ circumference\ (cm)}$. BF was measured in adolescents, young adults, and adults using DXA. Briefly, measurement required individuals to be prone and stationary while a Lunar prodigy narrow fan beam densitometer performed a whole body DXA scan. Data was processed using Lunar Prodigy software. Individuals did not have measurements taken if they: were pregnant, had a radiological investigation using contrast media within the week before the DXA scan, had a recent nuclear medicine investigation with persistent radioactivity, weighed greater than 159kg. BF was calculated as a percentage as $\displaystyle \frac{fat\ mass} {fat\ mass + fat\ free\ mass}\ * 100$. Available anthropometric measures for individuals with metabolomics data is given in Table \@ref(tab:observational-table-ALSPAC-adiposity) and distributions given in Figure \@ref(fig:observational-figure-raincloudplot-adiposity-measures). \par

In children, BF was not measured. A bioeletrical impedance measure was available; briefly, children were encouraged to pass urine and undress to their underclothes. A Tanita Body Fat Analyser (Model TBF 305) was used to measure weight and impedance. Height was entered to the nearest $cm$ and 'female standard' was used as the sex variable for all children. The Tanita Body Fat Analyser TBF 305 is a single frequency (50$kHz$) leg-to-leg device. In single frequency devices, impedance is a representation of resistance which is related to the volume of water (which one assumes makes up the majority of fat free mass (FFM)), as such, the higher the resistance/impedance the greater the amount of FFM. Calculation of BF from the impedance measure is only possible at the time of measurement, however these derived BF measures were not stored and the equation to calculate them was not available from the manufacturer. \par

Previous work[@Chouinard2007] has shown that comparison of BF derived from the manufacturer's equation and an alternative[@Jebb2000] showed little difference in resulting BF. The equation was derived in a study involving 205 (101 women) healthy adults with a mean age of 43.8 (SD = 16) for men and 40.4 (SD = 13.6) for women. The equation, where $Z$ is the impedance measure from the device in $ohms$, height is in meters, weight is in kilograms, age is in years, and female-specific components are given in parenthesis, is given as: \par

\begin{equation}
\begin{split}
  BF = -156.1 - 89.1\ ln(height) \\
  \ +\ 45.6\ ln(weight) \\
  \ +\ 0.120\ age\ \\
  \ +\ 0.0494\ Z \\
  \ +\ (19.6\ ln(height))
\end{split}
  (\#eq:BF)
\end{equation}

Given that the equation was derived from adult data, its application to child data was explored. A raw impedance measure, from a similar model (Tanita Body Fat Analyser (Model TBF 401A)), was obtained for adolescents and the equation was used to compare BF derived from the impedance device and BF measured with DXA in adolescents. Exploration involved visual inspection of distribution and Spearman's correlation with BMI, height, weight and other BF measures in adolescents. The same observations were carried out for raw impedance. \par

### Covariates
```{r ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/observational/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/observational/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/observational/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/observational/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# table ====
data <- data.frame(group = c("Metabolomics N",
                             "age", "age", "age",
                             "sex","sex",
                             "education", "education", "education", "education", "education",
                             "smoking",
                             "alcohol", "alcohol", "alcohol", "alcohol", "alcohol",
                             "diet", "diet", "diet",
                             "physical activity", "physical activity","physical activity"),
                   subgroup = c("N",
                                "N","mean","sd",
                                "N","female",
                                "1","2","3","4","5",
                                "N",
                                "1","2","3","4","5",
                                "N","mean","sd",
                                "N/1","mean/2","sd/3"),
                   children = c(ALSPAC_QC_N$N[1],
                                nrow(children_qc[!is.na(children_qc$age),]),round(mean(children_qc$age, na.rm  = T), 2),round(sd(children_qc$age, na.rm  = T), 2),
                                nrow(children_qc[!is.na(children_qc$sex),]),table(children_qc$sex)[[2]],
                                (table(children_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[1] * 100),
                                "-",
                                "-","-","-","-","-",
                                nrow(children_qc[!is.na(children_qc$diet),]),round(mean(children_qc$diet, na.rm  = T), 2),round(sd(children_qc$diet, na.rm  = T), 2),
                                "-","-","-"),
                   adolescents = c(ALSPAC_QC_N$N[2],
                                   nrow(adolescents_qc[!is.na(adolescents_qc$age),]),round(mean(adolescents_qc$age, na.rm  = T), 2),round(sd(adolescents_qc$age, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$sex),]),table(adolescents_qc$sex)[[2]],
                                   (table(adolescents_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$ever_smoked),]),
                                   (table(adolescents_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$diet),]),round(mean(adolescents_qc$diet, na.rm  = T), 2),round(sd(adolescents_qc$diet, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$physical_activity),]),round(mean(adolescents_qc$physical_activity, na.rm  = T), 2),round(sd(adolescents_qc$physical_activity, na.rm  = T), 2)),
                   young_adults = c(ALSPAC_QC_N$N[3],
                                    nrow(young_adults_qc[!is.na(young_adults_qc$age),]),round(mean(young_adults_qc$age, na.rm  = T), 2),round(sd(young_adults_qc$age, na.rm  = T), 2),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$sex),]),table(young_adults_qc$sex)[[2]],
                                    (table(young_adults_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$ever_smoked),]),
                                    (table(young_adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    "-","-","-",
                                    nrow(young_adults_qc[!is.na(young_adults_qc$physical_activity),]),round(mean(young_adults_qc$physical_activity, na.rm  = T), 2),round(sd(young_adults_qc$physical_activity, na.rm  = T), 2)),
                                    
                   adults = c(ALSPAC_QC_N$N[4],
                              nrow(adults_qc[!is.na(adults_qc$age),]),round(mean(adults_qc$age, na.rm  = T), 2),round(sd(adults_qc$age, na.rm  = T), 2),
                              nrow(adults_qc[!is.na(adults_qc$sex),]),table(adults_qc$sex)[[2]],
                              (table(adults_qc$education)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              nrow(adults_qc[!is.na(adults_qc$ever_smoked),]),
                              (table(adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              "-","-","-",
                              (table(adults_qc$physical_activity)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[3]]/ALSPAC_QC_N$N[4] * 100))
                   )
```

Evidence has shown that age[@Yu2012; @Brennan2020], sex[@Brennan2020], education[@Zajacova2018], smoking[@Bonevski2014], alcohol[@Bonevski2014], diet[@Afshin2019], and physical activity[@ODonoghue2018] all influence the metabolomic profile and adiposity. Data on for each of these covariates were obtained for all individuals with raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. Age was taken from the metabolomics clinic visit. The number of individuals with available data is given in Table \@ref(tab:observational-table-ALSPAC-covariates). \par

Maternal education was used for children, adolescents and young adults. Own education was used for mothers and mother reported partner education was used for fathers. Specifically, mothers were asked, during their pregnancy, 'What educational qualifications do you, your partner, your mother, and your father have?' with possible answers: CSE or GCSE (D, E, F or G), O-level or GCSE (A, B, or C), A-level, qualifications in shorthand/ typing/or other skills, e.g. hairdressing, apprenticeship, state enrolled nurse, state registered nurse, City and Guilds intermediate technical, City & Guilds final technical, City & Guilds full technical, teaching qualification, university degree, no qualification, qualifications not known, not applicable, other (please describe). \par

Smoking was binary; adolescents (at the metabolomics clinic), young adults (at the metabolomics clinic), and adults (mothers were asked during pregnancy; fathers were asked in 2013) were asked whether they had ever smoked a cigarette before. \par

Adolescents (Teen Focus 3) were asked what their alcohol drinking pattern was with possible answers: only ever tried drinking once/twice, used to drink sometimes [but] never drink now, sometimes drink but less than once a week, usually drink on 1/2 days a week, usually drink on >2 days a week but not every day, usually drink every day. Adolescents (Teen Focus 4), young adults (at the metabolomics clinic), mothers (in 2013), and fathers (at the metabolomics clinic) were asked the frequency they had drinks containing alcohol with possible answers: never, monthly or less, two to four times a month, two to three times a week, four or more times a week. \par

Diet data derived by Anderson et al. (2013)[@Anderson2013] was available for ages 7 and 13. Data from age 7 was matched with metabolomics data for children while data from age 13 was matched with adolescents. Diet data was not available for young adults or adults. Data is gievn as predicted kilo-calories consumed per day. \par

In adolescents and young adults, accelerometry data was collected at the same clinic for which metabolomics data were collected. Briefly, individuals wore an accelerometry device for the days following their clinic visit whilst keeping a diary of the times they wore and took off the device. Individuals were advised to wear the accelerometer device if the following days were part of a ‘normal week’ with regards to their activity. For young adults, physical activity data is the average number of minutes per day spent doing moderate to vigorous physical activity. For adolescents, data was available from Teen Focus 3 and is the mean counts per minute spent doing moderate to vigorous physical activity for the whole week. Adults were asked 'do you take part in physical activity (e.g. running, swimming, dancing, golf, tennis, squash, jogging, bowls)?' with possible answers: no, occasionally (less than monthly), frequently (once a month or more). Data for mothers was available in 2010, fathers data was available at the metabolomics clinic. Physical activity data was not available for children. <br>

### Statistical analysis
To investigate the association between measures of adiposity and metabolites, all exposures were Z-scored and linear regression was performed. Metabolites were not transformed. Variables known to influence the metabolomic profile and adiposity (age[@Yu2012; @Brennan2020], sex[@Brennan2020], education[@Zajacova2018], smoking[@Bonevski2014], alcohol[@Bonevski2014], diet[@Afshin2019], and physical activity[@ODonoghue2018]), were included as covariates Three linear models were used to investigate potential effects of these confounding variables. Model 1 included age at the metabolomics clinic visit and sex. Model 2 included model 1 and mothers/own level of highest education, whether respondent had ever smoked, frequency respondent had a drink containing alcohol, and predicted kilo-calories consumed per day (diet). Model 3 comprised model 2 and physical activity. For models 1 and 2, individuals with data on all confounders except physical activity were included. Model 3 comprised all individuals included in model 1 and 2 who also had data on physical activity. \par

For all analyses, the units represent the absolute change in each metabolite per standard deviation change in the exposure. Metabolite abbreviations are used in figures and tables for space, for complete labels, class, subclass, and units for each metabolite see Table @\ref(tab:appendix-observational-table-metabolites). Ninety-five percent confidence intervals were calculated and a multiple testing threshold specific for each group was applied. Multiple testing thresholds were calculated as the number of independent metabolites within the raw data given a Spearman’s rho of approximately 0.75 among the metabolites with data for at least 20% of samples -- this was calculated during metabolite quality control. The number of independent metabolites in each group was: children = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`. All results are available on [GitHub](https://github.com/mattlee821/000_thesis).\par

#### Post-hoc analyses
Metabolites were grouped into subclasses (grouping data provided by the metabolomics platform) based on biological pathway. Model 2, as the most adjusted and given the reduced sample size in Model 3, is presented as the main analysis for this work. Consistency in the direction of effect estimates across models within each exposure and age group was investigated, as was the number of tests reaching a multiple testing threshold. Directional consistency was investigated for exposures across age groups for model 2. A Spearmans Rho analysis was used to investigate the correlation between effect estimates across exposures and age groups. Visualization and comparison of global metabolic profiles across exposures within age groups, and within exposures and across age groups was investigated with Circos plots using the `EpiViz` `R` package. Forestplots, created using the `ggforestplot` `R` package, were used to examine specific subclasses where variation among metabolites within the subclass and strong effects were identified. Results for derived measures and *Lipoprotein particle size* and *Fatty acid ratios* are presented in the supplement. Directions of effect estimates were compared to that of previous work by Wurtz et al. (2014)[@Wurtz2014]. \par

\newpage

## Results {#observational-results} 
```{r echo=FALSE, warning=FALSE, error=FALSE}
# data ====
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data <- subset(data, subclass != "NA")
# shared metabolites ====
a <- subset(data, model == "model2")
a <- subset(a, exposure == "bmi")
b <- subset(a, group == "children")
c <- subset(a, group == "adolescents")
d <- subset(a, group == "young_adults")
e <- subset(a, group == "adults")
b <- as.data.frame(b[,1])
colnames(b) <- "metabolite"
b$group <- "children"
c <- as.data.frame(c[,1])
colnames(c) <- "metabolite"
c$group <- "adolescents"
d <- as.data.frame(d[,1])
colnames(d) <- "metabolite"
d$group <- "young_adults"
e <- as.data.frame(e[,1])
colnames(e) <- "metabolite"
e$group <- "adults"
f <- full_join(b,c, by = "metabolite")
f <- full_join(f,d, by = "metabolite")
f <- full_join(f,e, by = "metabolite")
metabolites <- f[complete.cases(f), ]
metabolites <- metabolites[,1]
metabolites <- droplevels(as.factor(metabolites))

# n in each plot
plot_data <- subset(data, exposure == "bmi")
plot_data <- subset(plot_data, model == "model2")
plot_data <- plot_data[plot_data$metabolite %in% metabolites, ]
plot_data <- subset(plot_data, group == "children")
ratios <- subset(plot_data, subclass == "Ratios")
fa_ratios <- subset(plot_data, subclass == "Fatty acids ratios")
lp_size <- subset(plot_data, subclass == "Lipoprotein particle size")
```

### Data overview
In total, metabolomics data were available for 234 metabolites in children (N = `r ALSPAC_N$combined_N[[1]]`), 230 metabolites in adolescents (N = `r ALSPAC_N$combined_N[[3]]`), 224 metabolites in young adults (N = `r ALSPAC_N$combined_N[[5]]`), and 232 metabolites in adults (N = `r ALSPAC_N$combined_N[[9]]`; Table \@ref(tab:observational-table-ALSPAC-N)). Quality control was performed twice, firstly including derived metabolites and secondly excluding them. There was a large difference in the number of representative features identified across the two runs, as such quality controlled data used here on was produced having included derived metabolites. \par

Quality control resulted in: `r children_samples_removed` individuals and `r children_features_removed` metabolites removed from the children's data (4 samples excluded for >= 80% missingness; 1 sample excluded for total sum abundance >= 5 SD from the mean; 1 sample excluded as a result of being >= 5 SD from the mean of PC1 and 2; 4 metabolites removed for >= 20% missingness), `r adolescents_samples_removed` individuals and `r adolescents_features_removed` metabolites removed from the adolescents data (1 sample excluded for total sum abundance >= 5 SD from the mean; 4 samples excluded as a result of being >= 5 SD from the mean of PC1 and 2), `r young_adults_samples_removed` individuals and `r young_adults_features_removed` metabolites removed from the young adults data (1 sample excluded for total sum abundance >= 5 SD from the mean; 3 sample excluded as a result of being >= 5 SD from the mean of PC1 and 2), `r adults_samples_removed` individuals and `r adults_features_removed` metabolites removed from the adults data (1 sample excluded for total sum abundance >= 5 SD from the mean; 6 samples excluded as a eresult of being >= 5 SD from the mean of PC1 and 2; 4 metabolites removed for >= 20% missingness). Quality controlled metabolomics data available for analysis is given in Table \@ref(tab:observational-table-ALSPAC-QC-N). \par

A total of `r nlevels(metabolites)` metabolites were measured in all age groups. Of individuals with metabolomics data, a majority also had data on measures of adiposity (Table \@ref(tab:observational-table-ALSPAC-adiposity) and Figure \@ref(fig:observational-figure-adiposity-distributions)), except for adolescents where data on WHR was not available. Data on covariates were also available in the majority of individuals, the exception being physical activity where fewer individuals had available data and no data was available for children (Table \@ref(tab:observational-table-ALSPAC-adiposity). \par

<!-- Do you factor in difference in N for covarites in the analyses????-->

```{r observational-table-ALSPAC-N, echo=FALSE}
knitr::kable(ALSPAC_N, longtable = F, booktabs = T, format = "latex", escape = F,
    caption = 'Metabolomics data available in ALSPAC', 
    row.names = F,
    col.names = linebreak(c("Combined group", "N", "N\n metabolites", "Subgroup", "Subgroup\n N", "Unique\n N", "Total\n metabolites", "Unique\n metabolites"))) %>%
  collapse_rows(columns = 1:3) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Children were measured at 5 time points and combined into three groups (Children, Adolescents, Young adults). Mothers were measured at two time points and combined. Fathers were measured at a single time point. Combined mothers and the fathers data were grouped as Adults. N = number of individuals in the Combined group; N metabolites = the number of metabolites measured in the Combined group; Subgroup = age or clinic identifier; Subgroup N = number of individuals in the Subgroup; Unique N = the number of individuals in the subgroup who do not appear in the other subgroup; Total metabolites = the number of metabolites measured for the Subgroup; Unique metabolites = as with Unique N, the total number of metabolites measured in the Subgroup not measured in the other Subgroup of that Combined group.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

\par

```{r observational-table-ALSPAC-QC-N, echo=FALSE}
x <- ALSPAC_QC_N

x[3,1] <- "Young adults"
knitr::kable(x, longtable = F, booktabs = T, format = "latex", escape = F,
             row.names = F,
             col.names = c("Group", "N", "Metabolites"),
             caption = 'Quality controlled metabolomics data available in ALSPAC') %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Number of individuals and metabolites available after quality control of metabolomics data. Group = the groups clinic visits were combined into; N = number of individuals with available metabolomics data after quality control; Metabolites = the number of metabolites measured in the Group after quality control.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

\par

```{r observational-table-ALSPAC-adiposity, echo=FALSE, warning=FALSE, error=FALSE}
adiposity_table <- read.table("data/observational/tables/adiposity_table.txt", header = T, sep = "\t")

knitr::kable(adiposity_table, longtable = F, booktabs = T, format = "latex", escape = F,
             caption = 'Measures of adiposity available for individuals with metabolomics data',
             row.names = F,
             col.names = c("Group", "N", "N","mean","SD","N","mean","SD","N","mean","SD")) %>%
  add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3)) %>%
    kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Measures were obtained for all individuals who had raw metabolomics data; wait hip ratio (WHR) was not available for adolescents. Group = the groups clinic visits were combined into; BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage; N = the number of individuals with available data; mean = the mean of the anthropometric measure; SD = standard deviation of the mean; - = data not available.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

\newpage

(ref:observational-figure-adiposity-distributions-cap) **Distribution of adiposity measures across all age groups**. Raincloud plots give the distribution of all adiposity measures across age groups by sex. Body fat percentage (BF) in children is derived from equation \@ref(eq:BF). BMI = body mass index; WHR = waist hip ratio. Data is presented for all individuals given in Table \@ref(tab:observational-table-ALSPAC-adiposity). The interquartile range and median are also shown. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019].

(ref:observational-figure-adiposity-distributions-scap) Distribution of adiposity measures across all age groups

```{r observational-figure-adiposity-distributions, echo=FALSE, out.width='100%', fig.cap='(ref:observational-figure-adiposity-distributions-cap)', fig.scap='(ref:observational-figure-adiposity-distributions-scap)'}
knitr::include_graphics("data/observational/figures/plot_raincloud_adiposity_measures.pdf")
```

\newpage

```{r observational-table-ALSPAC-covariates, echo=FALSE, warning=FALSE, error=FALSE}
covariate_table <- read.table("data/observational/tables/covariate_table.txt", header = T, sep = "\t", colClasses = "character")

knitr::kable(covariate_table, longtable = T, booktabs = T, format = "latex", escape = F,
             caption = 'Covariates available for individuals with metabolomics data', row.names = F, 
             col.names = c("","","Children","Adolescents","Young adults","Adults")) %>%
  collapse_rows(columns = 1) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  kableExtra::footnote(general = "Data on covariates were obtained for all individuals who had raw metabolomics data. Smoking and alcohol data were not available for children. Diet was not available for young adults and adults. Physical activity data was not available for children. Education is highest level of education; for children, adolescents, and young adults education is maternal education; for adults education is own education. Smoking is binary. Alcohol is frequency respondent consumes an alcoholic drink, with 1 being low and 5 high. Diet is predicted kilo-calories consumed per day derived from Anderson et al. (2013)[@Anderson2013]. Physical activity in dolescents is mean counts per minute of activity across 7 days (based on valid days). For young adults physical activity is the average number of valid minutes per day spent doing moderate to vigorous activity. For adults, physical activity is: no physical activity (1), occasionally (2), frequently (3). Group = the groups clinic visits were combined into; N = the number of individuals with available data; mean = the mean of the measure; SD = standard deviation of the mean. - = data not available.", threeparttable = T, general_title = "", footnote_as_chunk = T)
```

\par

### Validation of impedance
In children, a measure of BF was not available. Instead, impedance ($ohms$) was used to calculate (Equation \@ref(eq:BF)) BF. The calculated BF resulted in negative BF estimates for some children (Figure \@ref(fig:observational-figure-BF-validation-distribution)). However, the calculated BF was positively correlated with weight, height and BMI in children. In adolescents, the calculated BF did not produce negative estimates and was positively correlated with impedance and DXA derived BF estimates (Figure \@ref(fig:observational-figure-BF-validation-correlation-2)), as well as with weight, height, and BMI (Figure \@ref(fig:observational-figure-BF-validation-correlation)). Child calculated BF positively correlated with adolescent measures of BF (Figure \@ref(fig:observational-figure-BF-validation-correlation-2)). \par

Equation \@ref(eq:BF) was derived using adult data; given the volumetric difference between adults and children (BMI  cubed rather than BMI squared may be more appropriate in children[@Stergiakouli2014]), differences in the range of estimates is unsurprising. There is strong correlation between calculated BF and other measures of BF in adolescents. Similarly, there is strong correlation between calculated BF with weight, height, and BMI in children even with negative estimates. In a linear model the estimate is based on the per-unit increase, the absolute value of the exposure therefore does not need to be positive. As such, BF calculated using equation \@ref(eq:BF) was used in subsequent analyses as a measure of BF in children. \par 

(ref:observational-figure-BF-validation-distribution-cap) **Distribution of raw impedance and calculated body fat percentage in children and adolescents**. Raincloud plots give the distribution of the raw impedance value measured in $ohms$ and body fat percentage (BF) derived using equation \@ref(eq:BF) for children and adolescents. Data is presented for complete cases across: raw metabolomics, body mass index, waist hip ratio (children only), impedance, height, weight, age, sex, and BF derived by impedance and dual energy x-ray absorptiometry in adolescents. The interquartile range and median are also shown. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019].

(ref:observational-figure-BF-validation-distribution-scap) Distribution of raw impedance and calculated body fat percentage in children and adolescents

```{r observational-figure-BF-validation-distribution, echo=FALSE, out.width='100%', fig.cap='(ref:observational-figure-BF-validation-distribution-cap)', fig.scap='(ref:observational-figure-BF-validation-distribution-scap)'}
knitr::include_graphics("data/observational/figures/bf_validation_raincloud.pdf")
```

\par

(ref:observational-figure-BF-validation-correlation-cap) **Correlation between different body fat percentage measures in children and adolescents**. Scatter plots give Pearsons correlation coefficients for each sex; data for men is shown in red and women in grey. Column 1 gives raw impedance with body fat percentage (BF) calculated in children and adolescents using equation \@ref(eq:BF), and BF derived from dual energy x-ray absorptiometry (DXA) in adolescents. Column 2 gives child calcualted BF using equation \@ref(eq:BF) with adolescent calculated BF using equation \@ref(eq:BF) and DXA derived BF. Column 3 gives adolescent raw impedance with adolescent BF calculated using equation \@ref(eq:BF) and DXA dervied BF. Column 4 gives Adolescent calculated BF using equation \@ref(eq:BF) with adolescent raw impedance, DXA derived BF, and adolescent raw impedance with DXA derived BF. Data is presented for complete cases across: QC'd metabolomics, body mass index, wasit hip ratio (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents.

(ref:observational-figure-BF-validation-correlation-scap) Correlation between different body fat percentage measures in children and adolescents

```{r observational-figure-BF-validation-correlation, echo=FALSE, out.width='100%', fig.cap='(ref:observational-figure-BF-validation-correlation-cap)', fig.scap='(ref:observational-figure-BF-validation-correlation-scap)'}
knitr::include_graphics("data/observational/figures/bf_validation_correlation_bf.pdf")
```

\par

(ref:observational-figure-BF-validation-correlation-2-cap) **Correlation between body fat percentage and anthropometric measures in children and adolescents.** Scatter plots give Pearsons correlation coefficients for each sex; data for men is shown in red and women in grey. Columns 1 (impedance) and 2 (body fat percentage (BF)) give data on children. Columns 3 (impedance), 4 (BF calculated using equation \@ref(eq:BF)), 5 (BF derived from impedance device), and 6 (BF derived from dual energy x-ray absorptiometry (DXA)) give data on adolescents. Impedance is given as $ohms$. Data is presented for complete cases across: QC'd metabolomics, body mass index, waist hip ratio (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. 

(ref:observational-figure-BF-validation-correlation-2-scap) Correlation between body fat percentage and anthropometric measures in children and adolescents

```{r observational-figure-BF-validation-correlation-2, echo=FALSE, out.width='100%', fig.cap='(ref:observational-figure-BF-validation-correlation-2-cap)', fig.scap='(ref:observational-figure-BF-validation-correlation-2-scap)'}
knitr::include_graphics("data/observational/figures/bf_validation_correlation.pdf")
```

\par


### Directional consistency: across models within exposures and age groups
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
```
Across models within each exposure and age group a majority of tests resulted in directionally consistent effect estimates (Figure \@ref(fig:observational-figure-directional-consistency)). Of these directionally consistent effects, the majority of effect estimates were positive. That is, across a majority of metabolites, increased adiposity associated with increased metabolites. The strength of the effect estimates were broadly consistent across models; confidence intervals overlapped across the majority of metabolites for all models within each group and exposure (Appendix \@ref(appendix-observational-figures-forestplots)). Of the `r nlevels(metabolites)` metabolites measured in all age groups, directional consistency was supported by strong evidence of correlation across models within exposures and age groups (Supplement \@ref(appendix-observational-correlations)). \par

(ref:observational-figure-directional-consistency-cap) **Directional consistency across linear models within exposures and age groups**. A positive effect reflects all model betas being in the positive direction; a negative effect reflects all model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-directional-consistency-scap) Directional consistency across linear models within exposures and age groups


```{r observational-figure-directional-consistency, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap='(ref:observational-figure-directional-consistency-cap)', fig.scap='(ref:observational-figure-directional-consistency-scap)'}
knitr::include_graphics("data/observational/figures/plot_directional_consistency_across_models_within_exposures_groups.pdf")
```

### Multiple testing threshold
```{r echo=FALSE, warning=FALSE, error=FALSE}
library(tidyr)
# how many consistent significnat effects
# main analysis, consistent direction, significant ====
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data_all <- data
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

n_children <- nrow(children)/3
n_adolescents <- nrow(adolescents)/2
n_young_adults <- nrow(young_adults)/3
n_adults <- nrow(adults)/3

## subset for multiple testing threshold ====
children <- subset(children, p <= 0.05/54)
adolescents <- subset(adolescents, p <= 0.05/48)
young_adults <- subset(young_adults, p <= 0.05/46)
adults <- subset(adults, p <= 0.05/53)

# limit to interested rows ====
children <- children[,c(1,3,13,14,15)]
adolescents <- adolescents[,c(1,3,13,14,15)]
young_adults <- young_adults[,c(1,3,13,14,15)]
adults <- adults[,c(1,3,13,14,15)]

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

### children ====
data <- children[,c(4:ncol(children))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$group <- "children"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$group <- "adolescents"

### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$group <- "young_adults"

### adults ====
data <- adults[,c(4:ncol(adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$group <- "adults"

```

```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/54)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/54)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/54)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/54)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/54)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/54)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/48)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/48)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/48)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/48)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/48)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/48)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/46)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/46)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/46)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/53)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/53)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/53)

# precent of total ====
children_m1_bmi_percent <- nrow(children_m1_bmi_sig) / nrow(children_m1_bmi) * 100
children_m2_bmi_percent <- nrow(children_m2_bmi_sig) / nrow(children_m2_bmi) * 100
children_m1_whr_percent <- nrow(children_m1_whr_sig) / nrow(children_m1_whr) * 100
children_m2_whr_percent <- nrow(children_m2_whr_sig) / nrow(children_m2_whr) * 100
children_m1_bf_percent <- nrow(children_m1_bf_sig) / nrow(children_m1_bf) * 100
children_m2_bf_percent <- nrow(children_m2_bf_sig) / nrow(children_m2_bf) * 100
adolescents_m1_bmi_percent <- nrow(adolescents_m1_bmi_sig) / nrow(adolescents_m1_bmi) * 100
adolescents_m2_bmi_percent <- nrow(adolescents_m2_bmi_sig) / nrow(adolescents_m2_bmi) * 100
adolescents_m3_bmi_percent <- nrow(adolescents_m3_bmi_sig) / nrow(adolescents_m3_bmi) * 100
adolescents_m1_bf_percent <- nrow(adolescents_m1_bf_sig) / nrow(adolescents_m1_bf) * 100
adolescents_m2_bf_percent <- nrow(adolescents_m2_bf_sig) / nrow(adolescents_m2_bf) * 100
adolescents_m3_bf_percent <- nrow(adolescents_m3_bf_sig) / nrow(adolescents_m3_bf) * 100
young_adults_m1_bmi_percent <- nrow(young_adults_m1_bmi_sig) / nrow(young_adults_m1_bmi) * 100
young_adults_m2_bmi_percent <- nrow(young_adults_m2_bmi_sig) / nrow(young_adults_m2_bmi) * 100
young_adults_m3_bmi_percent <- nrow(young_adults_m3_bmi_sig) / nrow(young_adults_m3_bmi) * 100
young_adults_m1_whr_percent <- nrow(young_adults_m1_whr_sig) / nrow(young_adults_m1_whr) * 100
young_adults_m2_whr_percent <- nrow(young_adults_m2_whr_sig) / nrow(young_adults_m2_whr) * 100
young_adults_m3_whr_percent <- nrow(young_adults_m3_whr_sig) / nrow(young_adults_m3_whr) * 100
young_adults_m1_bf_percent <- nrow(young_adults_m1_bf_sig) / nrow(young_adults_m1_bf) * 100
young_adults_m2_bf_percent <- nrow(young_adults_m2_bf_sig) / nrow(young_adults_m2_bf) * 100
young_adults_m3_bf_percent <- nrow(young_adults_m3_bf_sig) / nrow(young_adults_m3_bf) * 100
adults_m1_bmi_percent <- nrow(adults_m1_bmi_sig) / nrow(adults_m1_bmi) * 100
adults_m2_bmi_percent <- nrow(adults_m2_bmi_sig) / nrow(adults_m2_bmi) * 100
adults_m3_bmi_percent <- nrow(adults_m3_bmi_sig) / nrow(adults_m3_bmi) * 100
adults_m1_whr_percent <- nrow(adults_m1_whr_sig) / nrow(adults_m1_whr) * 100
adults_m2_whr_percent <- nrow(adults_m2_whr_sig) / nrow(adults_m2_whr) * 100
adults_m3_whr_percent <- nrow(adults_m3_whr_sig) / nrow(adults_m3_whr) * 100
adults_m1_bf_percent <- nrow(adults_m1_bf_sig) / nrow(adults_m1_bf) * 100
adults_m2_bf_percent <- nrow(adults_m2_bf_sig) / nrow(adults_m2_bf) * 100
adults_m3_bf_percent <- nrow(adults_m3_bf_sig) / nrow(adults_m3_bf) * 100

min_significant_percent <- round(min(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

max_significant_percent <- round(max(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

mean_significnat_percent <- round(mean(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

median_significant_percent <- round(median(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

# percent change ====
adolescents_m1_m3_bmi_percent_change <- (nrow(adolescents_m1_bmi_sig) - nrow(adolescents_m3_bmi_sig)) / nrow(adolescents_m1_bmi_sig) * 100


```

Across all models and exposures, between `r min_significant_percent` percent and `r max_significant_percent` percent (median = `r round(median_significant_percent,1)` percent) of metabolites reached a multiple testing threshold (children multiple testing threshold = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`; Table \@ref(tab:observational-table-significant-results)). Of those with a consistent direction of effect across the three exposures a total of `r nrow(children)`, `r nrow(adolescents)`, `r nrow(young_adults)`, and `r nrow(adults)` metabolites reached a multiple testing threshold for children, adolescents, young adults, and adults respectively. This equates to `r round(nrow(children)/n_children*100)`, `r round(nrow(adolescents)/n_adolescents*100)`, `r round(nrow(young_adults)/n_young_adults*100)`, and `r round(nrow(adults)/n_adults*100)` percent of metabolites. \par

```{r observational-table-significant-results, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/observational/tables/multiple_testing_table.txt", header = T, sep ="\t")

knitr::kable(data, longtable = T, booktabs = T, format = "latex", escape = F,
             caption = 'Metabolites reaching a multiple testing threshold', row.names = F, 
             col.names = c("","N","1","2","3","1","2","3","1","2","3")) %>%
  collapse_rows(columns = 1) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"), position = "center") %>%
  add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3)) %>%
  kableExtra::footnote(general = "Table gives the number of metabolites reaching a multiple testing threshold for each model within each age group. Multiple testing thresholds: children = 54, adolescents = 48, young adults = 46, adults = 53. N = total number of metabolites tested; BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage (in children this is fat free mass); 1 = model 1 adjustment for age and sex; 2 = model 2 adjustment for model 1 plus maternal/own education, smoking status, alcohol frequency, diet (where available); 3 = model 3, adjustment for model 2 plus physical activity (where available).", threeparttable = T, general_title = "", footnote_as_chunk = T)

```

### Directional consistency: across exposures within age groups for model 2
```{r echo=FALSE, warning=FALSE, error=FALSE}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/observational/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,14,15,16)]
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children ====
data <- children[,c(4:ncol(children))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$exposure <- "children"
# ### children inverse
# data <- children[,c(4:ncol(children))]
# data <- data[complete.cases(data), ]
# data$direction = sapply( 1:nrow(data), function(i){
# 	## set data vector
# 	x = sign( data[i, ] )
# 	##
# 	if( x[1] == -1 & sum(x[2:3]) == 2 ){
# 		direct = 1
# 	} else{
# 		if( x[1] == 1 & sum(x[2:3]) == -2 ){
# 		direct = 2
# 		} else {
# 			direct = 3
# 		}
# 	}
# 	}
# )
# data <- data %>%
#   mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
#                                      direction == 2 ~ "Negative effect",
#                                      direction == 3 ~ "Opposite effect"))
# data$direction_group <- factor(data$direction_group,
#                                levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
# children_inverse <- data
# children_inverse$exposure <- "children_inverse"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$exposure <- "adolescents"
### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$exposure <- "young_adults"
### adults ====
data <- adults[,c(4:ncol(adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$exposure <- "adults"
## join data frames ====
data <- bind_rows(children,adolescents,young_adults,adults)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure)[c(3,1,4,2)])
```

Results here on are presented for model 2 only; results for models 1 and 3 are presented in the supplement. Across the three exposures (BMI, WHR, BF) within each age group, effects showed mostly consistent directions of effect, with the majority being positive (Figure \@ref(fig:observational-figure-directional-consistency-2)). The most inconsistent directions across exposures were found for children, where `r round(table(children$direction_group)[[3]]/(nrow(children))*100)` percent of metabolites showed inconsistent directions of effect. For adolescents, young adults, and adults `r round(table(adolescents$direction_group)[[3]]/(nrow(adolescents))*100)`, `r round(table(young_adults$direction_group)[[3]]/(nrow(young_adults))*100)`, and `r round(table(adults$direction_group)[[3]]/(nrow(adults))*100)` percent of metabolites showed inconsistent effect directions across measures of adiposity respectively. Of the `r nlevels(metabolites)` metabolites measured across all age groups, directional consistency was supported by strong evidence of correlation across exposures within age groups; though still strong, weaker correlations were observed when looking within exposures across age groups (Supplement \@ref(appendix-observational-correlations)).\par

(ref:observational-figure-directional-consistency-2-cap) **Directional consistency for model 2, across exposures within age groups**. A positive effect reflects all model betas being in the positive direction; a negative effect reflects all model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-directional-consistency-2-scap) Directional consistency for model 2, across exposures within age groups

```{r observational-figure-directional-consistency-2, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap='(ref:observational-figure-directional-consistency-2-cap)', fig.scap='(ref:observational-figure-directional-consistency-2-scap)'}
knitr::include_graphics("data/observational/figures/plot_directional_consistency_across_models_within_exposures_groups.pdf")
```

### Global metabolic profile
Visually, the global pattern of association was very similar for all measures of adiposity for children (Figure \@ref(fig:observational-figure-circosplot-main-children)), adolescents (Figure \@ref(fig:observational-figure-circosplot-main-adolescents)), young adults (Figure \@ref(fig:observational-figure-circosplot-main-young-adults)), and adults (Figure \@ref(fig:observational-figure-circosplot-main-adults)). Across all age groups the largest effects were found for the *Fatty Acids* subclass; total fatty acids showed the largest effect for all age groups. Metabolites in subclasses *small VLDL*, *medium VLDL*, *large VLDL*, and *very large VLDL* were the only ones to reach the specified significance thresholds across all exposures and age groups. \par

Effect estimates for derived measures were much higher for all exposures and age groups than with the subclasses presented here (Appendix \@ref(appendix-observational-figures-circosplots)). There was also considerable variation within subclasses for derived measures. The largest effect across all age groups and exposures among derived measures was observed for *Cholesterol esters in very large VLDL to total lipids in very large VLDL ratio* and *Total cholesterol in very large VLDL to total lipids in very large VLDL ratio*. Across age groups, direction of effect was consistent for the majority of metabolites within exposures (Appendix \@ref(appendix-observational-figures-forestplots)). On the whole, effect sizes were lowest in children and increased with age. The largest effect in adults, *Total fatty acids* (beta = 0.51), was twice that observed in children (beta = 0.21). \par

(ref:observational-figure-circosplot-main-children-cap) **Effect estimates from linear regression of adiposity measures on metabolites in children**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the absolute change in each metabolite per standard deviation change in the exposure; 95% confidence intervals are shown. Solid points indicate a multiple testing threshold has been reached ($0.05/54$).

(ref:observational-figure-circosplot-main-children-scap) Effect estimates from linear regression of adiposity measures on metabolites in children

```{r observational-figure-circosplot-main-children, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-children-cap)', fig.scap='(ref:observational-figure-circosplot-main-children-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_children.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-adolescents-cap) **Effect estimates from linear regression of adiposity measures on metabolites in adolescents**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the absolute change in each metabolite per standard deviation change in the exposure; 95% confidence intervals are shown. Solid points indicate a multiple testing threshold has been reached ($0.05/48$).

(ref:observational-figure-circosplot-main-adolescents-scap) Effect estimates from linear regression of adiposity measures on metabolites in adolescents

```{r observational-figure-circosplot-main-adolescents, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-adolescents-cap)', fig.scap='(ref:observational-figure-circosplot-main-adolescents-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_adolescents.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-young-adults-cap) **Effect estimates from linear regression of adiposity measures on metabolites in young adults**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the absolute change in each metabolite per standard deviation change in the exposure; 95% confidence intervals are shown. Solid points indicate a multiple testing threshold has been reached ($0.05/46$).

(ref:observational-figure-circosplot-main-young-adults-scap) Effect estimates from linear regression of adiposity measures on metabolites in young adults

```{r observational-figure-circosplot-main-young-adults, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-young-adults-cap)', fig.scap='(ref:observational-figure-circosplot-main-young-adults-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_young_adults.pdf")
```

\newpage

(ref:observational-figure-circosplot-main-adults-cap) **Effect estimates from linear regression of adiposity measures on metabolites in adults**. The Circos plot shows each track as one of the measures of adiposity; the outer track is body mas index (BMI), the middle track is waist hip ratio (WHR), the inner track is body fat percentage (BF). Units are the absolute change in each metabolite per standard deviation change in the exposure; 95% confidence intervals are shown. Solid points indicate a multiple testing threshold has been reached ($0.05/53$).

(ref:observational-figure-circosplot-main-adults-scap) Effect estimates from linear regression of adiposity measures on metabolites in adults

```{r observational-figure-circosplot-main-adults, echo=FALSE, out.width='120%', fig.cap='(ref:observational-figure-circosplot-main-adults-cap)', fig.scap='(ref:observational-figure-circosplot-main-adults-scap)'}
knitr::include_graphics("data/observational/figures/circosplot_main_adults.pdf")
```

\newpage

### Subclass results
Subclasses enable differentiation of metabolite classes, for example the lipid class can include the subclasses *large LDL* and *small HDL*. Subclasses were provided by the metabolomics platform. Associations were observed for all measures of adiposity across age groups and every subclass except *Large LDL* in children, where weak evidence of association was observed across measures of adiposity. Across the derived measures, associations were observed across measures of adiposity for all subclasses except *Extremely large VLDL ratios* in young adults and adults. \par

Across all age groups and exposures associations with every metabolite in a particular subclass was observed for *Small VLDL*, *Medium VLDL*, *Large VLDL*, *Very large VLDL*, and *Extremely large VLDL* (Figure \@ref(fig:observational-figure-forestplot-subclass-LDL)). As age increased, the number of associations within subclasses tended to increase across all measures of adiposity. For example, across *Small LDL*, *Medium LDL*, and *Large LDL* few associations were observed across measures of adiposity in children, however in adolescents and young adults a majority of metabolites showed evidence of association while in adults all metabolites showed evidence of association. \par

(ref:observational-figure-forestplot-subclass-LDL-cap) **Effect estimates from linear regression of adiposity measures on metabolites in all age groups for select LDL subclasses**. The forestplot shows the absolute change in each metabolite per standard deviation change in the exposure. Ninety-five percent confidence intervals are given. BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage.

(ref:observational-figure-forestplot-subclass-LDL-scap) Effect estimates from linear regression of adiposity measures on metabolites in all age groups for select LDL subclasses - THIS FIGURE NEEDS RE-MAKING, too squashed, currently package is broken 3/6/21

```{r observational-figure-forestplot-subclass-LDL, echo=FALSE, out.width='100%',  fig.cap='(ref:observational-figure-forestplot-subclass-LDL-cap)', fig.scap='(ref:observational-figure-forestplot-subclass-LDL-scap)'}
knitr::include_graphics("data/observational/figures/forestplot_subclass_LDL.pdf")
```

### Comparison with previous work {#chapter4-wurtz-comparison}
A total of 84 metabolic measures, including systolic and diastolic blood pressure, where measured by Wurtz et al. (2014)[@Wurtz2014]. Of these, 42 were comparable with metabolites measured across children, adolescents, young adults, and adults. Across all analyses conducted here for model 2, a majority of metabolites showed a consistent direction of effect with the study by Wurtz et al.[@Wurtz2014] (Figure \@ref(fig:observational-figure-wurtz-comparison)). The majority of effect estimates were in the positive direction, i.e. an increase in adiposity increases metabolite. However, for subclasses *Apolipoproteins*, *Cholesterol*, *IDL*, and *Lipoprotein particle size* a majority of effects were negative, i.e. an increase in adiposity decreases metabolite. The same was true for *Fluid balance*, *Inflammation*, and *Ketone bodies*. \par

(ref:observational-figure-wurtz-comparison-cap) **Comparison of effect estimate direction between Wurtz et al. (2014)[@Wurtz2014] and all model 2 analyses.** The tile plot shows the direction of effect estimate for 42 metabolites as positive (blue) or negative (orange). BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage; IDL = intermediate density lipoproteins. White space indicates no analysis. For full names of metabolites see appendix.

(ref:observational-figure-wurtz-comparison-scap) Comparison of effect estimate direction between Wurtz et al. (2014)[@Wurtz2014] and all model 2 analyses

```{r observational-figure-wurtz-comparison, echo=FALSE, out.width='100%', fig.cap='(ref:observational-figure-wurtz-comparison-cap)', fig.scap='(ref:observational-figure-wurtz-comparison-scap)'}
knitr::include_graphics("data/observational/figures/wurtz_comparison.pdf")
```

## Discussion {#observational-discussion} 
In this chapter, the influence of increased adiposity on the metabolic profile is demonstrated in an observational framework. These effects persist, not only when measured at different ages, but also when adjusted for covariates such as smoking, physical activity, and diet. Effects are similar across multiple measures of adiposity and to those previously reported[@Wurtz2014]. The association between increased adiposity and metabolites is global, with effects seen across all subclasses of metabolites. These effects are broadly consistent between metabolites within each subclass. \par

When looking at each exposure across age groups (e.g. the effects of BMI in children, adolescents, young adults, and adults), we find highly similar effects in individuals measured at multiple time points (children, adolescents, and young adults). As age increased, the number of associations within subclasses tended to increase across all measures of adiposity. Fewer associations were observed in children than in adolescents and young adults. These differences may reflect prolonged adiposity exposure. A similar metabolic profile is apparent in adults, though effect sizes appear slightly larger. The larger effects seen in adults may be due to the fact that metabolite concentrations have been shown to increase in older populations over time[@Darst2019]. Given that longitudinal work has shown that BMI tracks over time[@Singh2008; @Buscot2018] there may be a dose response relationship here whereby increased adiposity has a compounding effect on metabolites over time. \par

Within each age group, there was high directional consistency across the three exposures. Effect sizes across exposures were similar within age groups, with overlapping confidence intervals. BMI showed a broadly higher effect on metabolites across age groups. Effects for BF appeared to be closer to, and crossed, the null more often than BMI and WHR. This may suggest that overall body composition in addition to detrimental deposition, may be driving the effect. \par

Results are consistent across models. Effect estimates showed consistent directions for the majority of tests. Effect sizes were broadly similar in the case of models 1 and 2. Effect sizes in model 3 were smaller compared with models 1 and 2. However, confidence intervals overlapped across the majority of tests even if they crossed the null in some instances for model 3. Additionally, confidence intervals became tighter with models 2 and 3. Consistency across models suggests weak evidence of confounding. Whether these results represent a true causal association or are subject to reverse causation or residual confounding requires further investigation. \par

Previous work by Wurtz et al. (2014)[@Wurtz2014] identified numerous associations between BMI and metabolites in a large population. Results here show a broadly similar pattern of association with those by Wurtz et al[@Wurtz2014] with key metabolites such as phenylalanine and tyrosine showing consistent directions of effect. Both metabolites are known to be increased by adiposity and age[@Haufe2016; @Fattuoni2018; @Zheng2016a; @Ho2016; @Newgard2009; @Yu2018; @Xie2014; @Kim2010]. Differences in effect estimate direction was minimal and split relatively evenly across age groups. Only one metabolite from the Wurtz et al[@Wurtz2014] study, *fatty acid chain length*, had a direction of effect that was inconsistent across all age groups here. In MR analysis by Wurtz et al[@Wurtz2014] *fatty acid chain length* showed a positive direction of effect and crossed the null. \par

### Limitations
#### Metabolomics
There is no standardised approach, nor a gold standard, for performing metabolomics quality control. Here, quality control, including outlier detection and removal, was performed using the `metaboprep` `R` package. The default settings for exclusions based on metabolite missingness (20%), sample missingness (20%), total sum abundance (5 SD), and principal components (5 SD) were used. Most samples were removed for having missingness > 20% compared to total peak area and PC. Twenty percent sample missingness is arbitrarily defined and used among other studies[@Lotta2021], however a more stringent threshold (e.g. 5%) may have impacted on results. Metadata, such as batch and runday, was not available and could not be included in quality control. `metaboprep` calculated the number of independent metabolites using a clustering dendorgram and a tree cut height based on a Spearman's Rho of 0.5. Although most metabolites were shared across age groups, differences in the number of independent metabolites were found. There were also differences in the number of clusters and truly independent metabolites. Similarly, inclusion of derived metabolites resulted in differing numbers of independent metabolites. \par

#### Data availability
Metabolomics measures were taken at specific time points in ALSPAC children and at ~50 years of age in adults. Though measures of adiposity were available at the same time points, data on confounders was not. Smoking status for example was available for adult males at the metabolomics clinic but the closest available measure for adult females was a number of years earlier, in which time they may have taken up smoking. Although data were obtained where available from the closest time point, the mismatch in timings may bias results, particularly in the case of smoking and alcohol consumption. \par

In all age groups, the availability of data was limiting. Absence of physical activity data meant model 3 was not performed for children, while absence of diet data in young adults and adults meant models 2 and 3 were constrained. However, adjusting for diet where available (children and adolescents) had little impact on results (Table \@ref(tab:observational-table-significant-results)) and is therefore likely not to have changed findings in young adults and adults. \par

In children, body fat percentage was not available. A raw impedance measure was available and derivation of BF using Equation \@ref(eq:BF) showed positive correlation with BMI and weight in children and BF measures in adolescents. However, this derived measure included numerous negative estimates of BF. The equation performed well in adolescents, correlating highly with DXA derived BF (Figure \@ref(fig:observational-figure-BF-validation-correlation-2)). The negative estimates of BF are likely a result of Equation \@ref(eq:BF) being derived in an adult population. Brief investigation showed negative estimates of BF remained when using adolescent age with child height and weight (data not shown). Given that in single frequency devices impedance is based on the volume of an individual it is probable that the values used in the equation do not accurately reflect the proportions of children pre-puberty. Child-specific equations were not available and the manufacturer was unwilling to share the equation used by their impedance devices. However, given that in a linear model the estimate is based on the per-unit increase, the absolute value negative or otherwise, will likely not alter the strength of association. \par

#### Sensitivity analyses
The distribution of BMI at each age group was very similar across sexes. However, the distribution of WHR and BF differed among sexes in adolescents, young adults and adults; men had on average a higher WHR while women had a higher BF. Though Z-scores were used and sex was included as a covariate, the differences in WHR and BF distributions may highlight an underlying difference, which confounds the relationship between adiposity and metabolites. For example, hormonal contraceptive use has shown to influence the metabolome[@Rauschert2017] and is not regularly taken by individuals with a high BMI[@Mody2014]. There was little difference in results from the three models in regards to direction of effect estimates. However, when including only individuals with physical activity (model 3) the size of effects and the number of associations reaching a multiple testing threshold decreased. Given the consistency in the direction of effects across models and the highly similar effects across model 1 and 2 there is likely little effect of confounding. However, the possibility of unmeasured confounding can not be ruled out. \par

### Summary
The large number of associations identified using multiple exposures adds weight to the evidence, shown previously for BMI, of association between increased adiposity and metabolites. As with previous work, we find associations between increased adiposity and many metabolites, including increased phenylalanine and tyrosine and decreases with HDL components. This work highlights the large effects of increased adiposity on the global metabolic profile and shows that effects likely persist over time. Puberty is likely to have an affect on both adiposity, physical activity, and the metabolome and the lack of available data in children (BF and physical activity) means this requires further investigation, particularly as the adolescent time point used will have included post-pubertal individuals. Though covariates were included, the potential for unmeasured confounding is likely, and follow-up analysis will require this to be taken into account. Of particular note is the increasing effect size and number of associations as a result of increased adiposity across the metabolic profile with age. Given that many adiposity associated diseases occur later in life, exposure to an altered metabolic profile over time may be important in disease development. This is especially true as weight loss in overweight and obese individuals is associated with a normalizing of metabolite changes[@Rangel-Huerta2019]. \par
