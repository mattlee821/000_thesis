---
output: html_document
bibliography: bib/library.bib
csl: csl/nature.csl
space_betwee_paragraphs: true
fig_caption: true
always_allow_html: yes
link-citations: true
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# word count = 
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this will tell the .Rmd file what output you are knitting to (word, pdf, html) so that you cna use if else statements when making tables - html/pdf output tables do not work well in word. For word we need to use the 'flextable' packaged to make tables.
## packages
library(dplyr)
library(kableExtra)
library(flextable)
options(knitr.kable.NA = '')
```

# Observational analysis {#chapter4} 
```{r include=FALSE}
ALSPAC_N <- read.table("data/chapter4/data/metabolomics/data_prep/other/ALSPAC_N.txt", header = T, sep = "\t")
ALSPAC_QC_N <- read.table("data/chapter4/data/metabolomics/data_prep/final/qc/ALSPAC_QC_N.txt", header = T, sep = "\t")
```


<style>
body {
text-align: justify}
</style>

#### *Associations between measures of adiposity and metabolites: observational analysis*

In Chapters [1](#chapter1) and [2](#chapter2), the link between increased adiposity and disease was presented both in observational and causal analysis frameworks. This work highlighted key limiting areas in understanding the biological pathways leading to disease development. In this chapter, observational epidemiological methods will be used to assess one of the potential pathways linking adiposity to disease, metabolites. The aim of this chapter is to provide an observational grounding for subsequent causal analysis work in Chapters [5](#chapter5) and [9](#chapter9).

\newpage

## Introduction
In Chapter [1](#chapter1) and [2](#chapter2), a growing body of work both observational and causal was presented linking increased adiposity to many diseases. Many of these, and others, have proposed metabolites to be involved in this process[@Bray2004; @Haslam2005; @Collaboration2009]. However, few studies have identified intermediate metabolites and pathways that lie on the disease development pathway.  <br>

Metabolic changes as a result of increased adiposity have recently been highlighted in a systematic review[@Rangel-Huerta2019]. The studies included reveal the wide scale metabolic change as a result of obesity. However, the majority of studies included fewer than 100 individuals and all focused on obesity as a singular measure of adiposity. <br>

Analysis across thousands of individuals has highlighted the wide range of global effects BMI has on the metabolome[@Wurtz2014]. To our knowledge, the work by Wurtz et al. (2014)[@Wurtz2014] is the largest investigation of the effects of increased adiposity on the metabolome to date. Their analysis, involving 88 metabolites measured in 12,664 adolescents and young adults, identified a majority of metabolites to be associated with increased BMI after adjusting for sex. Associations were observed across numerous metabolic classes including amino acids, fatty acids, hormones, inflammatory markers, and lipids. Amino acids were positively associated with BMI, with the largest effect observed for phenylalanine. Fatty acids showed similarly positive effects, except for n-6 fatty acids percentage and polyunsaturated fatty acids percentage which showed negative associations. A positive association was observed for LDL metabolites while a heterogeneous pattern of association was found for HDL metabolites. In MR analysis, similar results were found. <br>

Given the crude estimation of adiposity provided by BMI, the effects identified by Wurtz et al. (2014)[@Wurtz2014] require further consideration across a number of measures of adiposity. The Avon Longitudinal Study of Parents and Children (ALSPAC), a longitudinal birth cohort study, provides an opportunity to expand on this work using data from many thousands of individuals with multiple measures of adiposity and metabolomics data measured at multiple time points. Here, observational analysis of measures of adiposity and metabolites provide a basis from which to investigate causal associations. In addition, replication of results from Wurtz et al.[@Wurtz2014] is possible for a number of metabolites. <br>

\newpage

## Methods
Data were available for exposures (measures of adiposity), outcomes (metabolites), and potential confounders from the Avon Longitudinal Study of Parents and Children (ALSPAC). In ALSPAC, exposures included body mass index (BMI), waist hip ratio (WHR) and body fat percentage (BF); metabolomics data was available for up to `r ALSPAC_N$combined_metabolites[[1]]` metabolites, which included metabolite ratios; data on available confounders included: age, sex, mothers or own education, smoking history, alcohol history, diet, physical activity. All analysis and data manipulation was performed using `R` (version 3.6.2)[@r2019]. Specific `R` packages are described where appropriate. All code for this work is available on [GitHub](https://github.com/mattlee821/000_thesis/index/data/chapter4). <br>

### Overview: ALSPAC
ALSPAC[@Fraser2013; @Boyd2013; @Northstone2019] is a large prospective cohort study that invited women resident in Avon, UK with expected dates of delivery between 1st April 1991 and 31st December 1992 to participate. The initial number of pregnancies enrolled was 14,541 (for these at least one questionnaire has been returned or a “Children in Focus” clinic has been attended by 19/07/99). Of these initial pregnancies, a total of 14,676 fetuses, resulted in 14,062 live births and 13,988 children alive at one year of age. <br>

When the oldest children were approximately seven years of age, an attempt was made to bolster the initial sample with eligible cases who had failed to join the study originally. As a result, when considering variables collected from the age of seven onwards (and potentially abstracted from obstetric notes) there are data available for more than the 14,541 pregnancies mentioned above. The number of new pregnancies not in the initial sample (known as Phase I enrollment) that are currently represented on the built files and reflecting enrollment status at the age of 24 is 913 (456, 262 and 195 recruited during Phases II, III and IV respectively), resulting in an additional 913 children being enrolled. The phases of enrollment are described in more detail in the cohort profile paper and its update[@Fraser2013; @Boyd2013; @Northstone2019]. The total sample size for analyses using any data collected after the age of seven is therefore 15,454 pregnancies, resulting in 15,589 fetuses, of which 14,901 were alive at one year of age. <br>

The study [website](http://www.bristol.ac.uk/alspac/) contains details of all the data that is available through a fully searchable data dictionary and [variable search tool](http://www.bristol.ac.uk/alspac/researchers/our-data/). Ethical approval for the study was obtained from the ALSPAC Ethics and Law Committee and the [Local Research Ethics Committees](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). Informed consent for the use of data collected via questionnaire and clinics was obtained from participants following recommendations of the ALSPAC Ethics and Law Committee at the time. Full details of the ALSPAC consent procedures are available on the [study website](http://www.bristol.ac.uk/alspac/researchers/research-ethics/). <br>

ALSPAC data is split by clinic visits. For this work, data for children was taken from the following clinics: Focus at 7 (~7 years old), Focus at 8 (~8 years old), Before Breakfast Study (~8 years old), Teen Focus 3 (~15 years old) Teen Focus 4 (~17 years old), Focus at 24 (~24 years old). Data on adults was taken from: Focus on Mothers 1 (~50 years old), Focus on Mothers 2 (~50 years old), and Focus on Fathers 1 (~50 years old). The Before Breakfast Study only collected metabolomics data, as such data on exposures and confounders were extracted for these individuals from the Focus at 8 clinic. Metabolomics data for each time point were extracted first and subsequent data on exposures and confounders were extracted for individuals with metabolomics data. <br>

### Outcomes: metabolites
```{r QC-data, echo=FALSE}
load("data/chapter4/data/metabolomics/data_prep/final/qc/children/MetaboQC_release/ReportData.Rdata")
children_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
children_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
children_independent <- nrow(qc_data$varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/adolescents/MetaboQC_release/ReportData.Rdata")
adolescents_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adolescents_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adolescents_independent <- nrow(qc_data$varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/young_adults/MetaboQC_release/ReportData.Rdata")
young_adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
young_adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
young_adults_independent <- nrow(qc_data$varexp)

load("data/chapter4/data/metabolomics/data_prep/final/qc/adults/MetaboQC_release/ReportData.Rdata")
adults_samples_removed <- nrow(raw_data$sample_data) - nrow(qc_data$sample_data)
adults_features_removed <- ncol(raw_data$metabolite_data) - ncol(qc_data$metabolite_data)
adults_independent <- nrow(qc_data$varexp)
```
There were slight differences in the methodology used across time points for the children and for the fathers metabolomics measurements. However, data are directly comparable (See the metabolomics data release file D5700 from the ALSPAC Data Dictionary). Briefly, high-throughput proton (^1^H) nuclear magnetic resonance (NMR) assays were performed on EDTA plasma/serum samples. Samples were predominantly fasted. Measurements were taken at three molecular windows (lipoprotein lipids, low molecular-weight metabolites, and lipid extracts) enabling broad quantification of over 220 metabolomic measures. Full details on the NMR methodology has previously been described[@Soininen2009; @Inouye2010; @Kettunen2012; @Soininen2015] and is available from the [ALSPAC data dictionary](http://www.bristol.ac.uk/alspac/researchers/access/) (data dictionary identifiers: children = D5704, mothers = D5705, fathers = D5700). The Before Breakfast study does not have a documentation file and is described elsewhere[@Ong2004]. Descriptions of metabolites are available in the Appendix \@ref(chapter4-appendix-metabolites). <br>

The spectral NMR data was processed by Nightingale Health and provided as a processed file with identifiable individuals (triplets/quadruplets) and individuals who had withdrawn consent removed. Some mothers and fathers were duplicated in the raw data due to the way in which mothers were originally enrolled into the study and assigned IDs. If a mother enrolled with two different pregnancies (both having an expected delivery date within the recruitment period (April 1991-December 1992)), she will have two separate IDs. A father associated with both of these pregnancies will also be duplicated. Duplicate measurements for mothers and fathers were removed. Raw metabolomics data was therefore available for: Focus at 7 (n = `r ALSPAC_N$total_N[1]`; metabolites = `r ALSPAC_N$total_metabolites[1]`), Before Breakfast Study (n = `r ALSPAC_N$total_N[2]`; metabolites = `r ALSPAC_N$total_metabolites[2]`), Teen Focus 3 (n = `r ALSPAC_N$total_N[3]`; metabolites = `r ALSPAC_N$total_metabolites[3]`), Teen Focus 4 (n = `r ALSPAC_N$total_N[4]`; metabolites = `r ALSPAC_N$total_metabolites[4]`), Focus at 24 (n = `r ALSPAC_N$total_N[5]`; metabolites = `r ALSPAC_N$total_metabolites[5]`), Focus on Mothers 1 (n = `r ALSPAC_N$total_N[6]`; metabolites = `r ALSPAC_N$total_metabolites[6]`), Focus on Mothers 2 (n = `r ALSPAC_N$total_N[7]`; metabolites = `r ALSPAC_N$total_metabolites[7]`), Focus on Fathers (n = `r ALSPAC_N$total_N[8]`; metabolites = `r ALSPAC_N$total_metabolites[8]`). <br> 

In order to maximize the sample size at each clinic, data were combined where clinics were within a similar age range. For these combined data sets, duplicate individuals (i.e. those attending both clinics) were identified, and the measurement from the most recent clinic was dropped. The number of metabolites measured at each clinic visit for the children and adult data differed; unique metabolites were included in the combined data set. Raw, combined, metabolomics data was therefore available for: children (mean age (SD) = 7.56 (0.36); n = `r ALSPAC_N$combined_N[1]`; metabolites = `r ALSPAC_N$combined_metabolites[1]`), adolescents (mean age (SD) = 16.06 (1.11); n = `r ALSPAC_N$combined_N[3]`; metabolites = `r ALSPAC_N$combined_metabolites[3]`), young adults (mean age (SD) = 24.03 (0.85); n = `r ALSPAC_N$total_N[5]`; metabolites = `r ALSPAC_N$total_metabolites[5]`), adults (mean age (SD) = 49.53 (5.32)n = `r ALSPAC_N$combined_N[9]`; metabolites = `r ALSPAC_N$combined_metabolites[9]`; Table \@ref(tab:chapter4-table-ALSPAC-N)). </br>

Quality control of the combined metabolite data (i.e. children, adolescents, young adults, adults) was performed using the `R` package [`MetaboQC`](https://github.com/MRCIEU/MetaboQC) (version 0.0.1). Quality control was performed twice, firstly including and secondly excluding the derived metabolomics measures from missingness and clustering. Briefly, individuals, and then metabolites, with high missingness (>=80%) were removed. Missingness was then re-calculated for individuals and metabolites, with removal based on 20% missingness. Individuals were then removed based on total sum abundance, considering outliers as > 5 standard deviations away from the mean. Using this metabolite data set, a dendrogram based on a Spearman's rho distance matrix is produced, and a set of clusters identified based on a Spearman's rho of 0.5. For each cluster, the metabolite with the least missingness is tagged as the representative feature. Finally, principal component analysis is conducted using the representative features to evaluate structure among individuals. Outliers are identified as being > 5 standard deviations away from the mean of principal component 1 and 2 and were excluded.

### Exposures: measures of adiposity
Measures of adiposity (BMI, WHR, BF) were obtained for all individuals with available raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. As metabolomics measures were obtained on unique individuals where multiple clinics were attended, anthropometric data for these individuals were taken from the clinic associated with the metabolomic measure. No anthropometric data was available for the Before Breakfast Study, so the Focus at 8 clinic, as the most age appropriate clinic, was used instead. For this combined data, Focus at 7 measures were matched with Focus at 7 metabolomics measures and Focus at 8 measures were matched with Before Breakfast Study metabolomics measures. <br>

Measures for children were taken from Focus at 7 and 8, for adolescents Teen Focus 3 and 4, for mothers Focus on Mothers 1 and 2, for fathers Focus on Fathers. Data on WHR was not available in adolescents. BMI was calculated as $\displaystyle \frac{weight(kg)}{height (m^2)}$ and WHR as $\displaystyle \frac{waist\ circumference\ (cm)} {hip\ circumference\ (cm)}$. BF was measured in adolescents, young adults, and adults using dual energy x-ray absorptiometry (DXA). Briefly, measurement required individuals to be prone and stationary while a Lunar prodigy narrow fan beam densitometer performed a whole body DXA scan. Data was processed using Lunar Prodigy software. Individuals did not have measurements taken if they: were pregnant; had a radiological investigation using contrast media within the week before the DXA scan; had a recent nuclear medicine investigation with persistent radioactivity; weighed greater than 159kg. BF was calculated as a percentage as $\displaystyle \frac{fat\ mass} {fat\ mass + fat\ free\ mass}\ * 100$. Available anthropometric measures for individuals with metabolomics data is given in Table \@ref(tab:chapter4-table-ALSPAC-adiposity) and distributions given in Figure \@ref(fig:chapter4-figure-raincloudplot-adiposity-measures). <br>

In children, BF was not measured. A bioeletrical impedance measure was available; briefly, children were encouraged to pass urine and undress to their underclothes. A Tanita Body Fat Analyser (Model TBF 305) was used to measure weight and impedance. Height was entered to the nearest $cm$ and 'female standard' was used for all children for sex. The Tanita Body Fat Analyser TBF 305 is a single frequency (50$kHz$) leg-to-leg device. In single frequency devices, impedance is a representation of resistance which is related to the volume of water (which one assumes makes up the majority of fat free mass (FFM)), as such, the higher the resistance/impedance the greater the amount of FFM. Calculation of BF from the impedance measure is only possible at the time of measurement, however these derived BF measures were not stored and the equation to calculate them was not available from the manufacturer (Appendix \@ref(chapter4-appendix-communications)). 

Previous work[@Chouinard2007] has shown that comparison of BF derived from the manufacturer's equation and an alternative[@Jebb2000] showed little difference in resulting BF. The equation was derived in a study involving 205 (101 women) healthy adults with a mean age of 43.8 (SD = 16) for men and 40.4 (SD = 13.6) for women. The equation, where $Z$ is the impedance measure from the device in $ohms$, height is in meters, weight is in kilograms, age is in years, and female-specific components are given in parenthesis, is given as: <br>

\begin{equation}
\begin{split}
  BF = -156.1 - 89.1\ ln(height) \\
  \ +\ 45.6\ ln(weight) \\
  \ +\ 0.120\ age\ \\
  \ +\ 0.0494\ Z \\
  \ +\ (19.6\ ln(height))
\end{split}
  (\#eq:BF)
\end{equation}

Given that the equation was derived from adult data, its application to child data was explored. A raw impedance measure, from a similar model (Tanita Body Fat Analyser (Model TBF 401A)), was obtained for adolescents and the equation was used to compare BF derived from the impedance device and BF measured with DXA in adolescents. Exploration involved visual inspection of distribution and Spearman's correlation with BMI, height, weight and other BF measures in adolescents. The same observations were carried out for raw impedance. <br>

### Confounders
```{r ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# table ====
data <- data.frame(group = c("Metabolomics N",
                             "age", "age", "age",
                             "sex","sex",
                             "education", "education", "education", "education", "education",
                             "smoking",
                             "alcohol", "alcohol", "alcohol", "alcohol", "alcohol",
                             "diet", "diet", "diet",
                             "physical activity", "physical activity","physical activity"),
                   subgroup = c("N",
                                "N","mean","sd",
                                "N","female",
                                "1","2","3","4","5",
                                "N",
                                "1","2","3","4","5",
                                "N","mean","sd",
                                "N/1","mean/2","sd/3"),
                   children = c(ALSPAC_QC_N$N[1],
                                nrow(children_qc[!is.na(children_qc$age),]),round(mean(children_qc$age, na.rm  = T), 2),round(sd(children_qc$age, na.rm  = T), 2),
                                nrow(children_qc[!is.na(children_qc$sex),]),table(children_qc$sex)[[2]],
                                (table(children_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[1] * 100),(table(children_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[1] * 100),
                                "-",
                                "-","-","-","-","-",
                                nrow(children_qc[!is.na(children_qc$diet),]),round(mean(children_qc$diet, na.rm  = T), 2),round(sd(children_qc$diet, na.rm  = T), 2),
                                "-","-","-"),
                   adolescents = c(ALSPAC_QC_N$N[2],
                                   nrow(adolescents_qc[!is.na(adolescents_qc$age),]),round(mean(adolescents_qc$age, na.rm  = T), 2),round(sd(adolescents_qc$age, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$sex),]),table(adolescents_qc$sex)[[2]],
                                   (table(adolescents_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$ever_smoked),]),
                                   (table(adolescents_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[2] * 100),(table(adolescents_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[2] * 100),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$diet),]),round(mean(adolescents_qc$diet, na.rm  = T), 2),round(sd(adolescents_qc$diet, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$physical_activity),]),round(mean(adolescents_qc$physical_activity, na.rm  = T), 2),round(sd(adolescents_qc$physical_activity, na.rm  = T), 2)),
                   young_adults = c(ALSPAC_QC_N$N[3],
                                    nrow(young_adults_qc[!is.na(young_adults_qc$age),]),round(mean(young_adults_qc$age, na.rm  = T), 2),round(sd(young_adults_qc$age, na.rm  = T), 2),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$sex),]),table(young_adults_qc$sex)[[2]],
                                    (table(young_adults_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$ever_smoked),]),
                                    (table(young_adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[3] * 100),(table(young_adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[3] * 100),
                                    "-","-","-",
                                    nrow(young_adults_qc[!is.na(young_adults_qc$physical_activity),]),round(mean(young_adults_qc$physical_activity, na.rm  = T), 2),round(sd(young_adults_qc$physical_activity, na.rm  = T), 2)),
                                    
                   adults = c(ALSPAC_QC_N$N[4],
                              nrow(adults_qc[!is.na(adults_qc$age),]),round(mean(adults_qc$age, na.rm  = T), 2),round(sd(adults_qc$age, na.rm  = T), 2),
                              nrow(adults_qc[!is.na(adults_qc$sex),]),table(adults_qc$sex)[[2]],
                              (table(adults_qc$education)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$education)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              nrow(adults_qc[!is.na(adults_qc$ever_smoked),]),
                              (table(adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[4] * 100),
                              "-","-","-",
                              (table(adults_qc$physical_activity)[[1]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[2]]/ALSPAC_QC_N$N[4] * 100),(table(adults_qc$physical_activity)[[3]]/ALSPAC_QC_N$N[4] * 100))
                   )
```

Data on confounders were obtained for all individuals with raw metabolomics data; identifiable individuals and those with withdrawn consent were therefore already excluded. The following confounders were used: age, sex, maternal/own education, smoking, alcohol, diet, physical activity. Age was taken from the metabolomics clinic visit. The number of individuals with available data is given in Table \@ref(tab:chapter4-table-ALSPAC-confounders). <br>

Maternal education was used for children, adolescents and young adults. Own education was used for mothers and mother reported partner education was used for fathers. Specifically, mothers were asked, during their pregnancy, 'What educational qualifications do you, your partner, your mother, and your father have?' with possible answers: CSE or GCSE (D, E, F or G), O-level or GCSE (A, B, or C), A-level, qualifications in shorthand/ typing/or other skills, e.g. hairdressing, apprenticeship, state enrolled nurse, state registered nurse, City and Guilds intermediate technical, City & Guilds final technical, City & Guilds full technical, teaching qualification, university degree, no qualification, qualifications not known, not applicable, other (please describe). <br>

Smoking was binary; adolescents (at the metabolomics clinic), young adults (at the metabolomics clinic), and adults (mothers were asked during pregnancy; fathers were asked in 2013) were asked whether they had ever smoked a cigarette before. <br>

Adolescents (Teen Focus 3) were asked what their alcohol drinking pattern was with possible answers: only ever tried drinking once/twice, used to drink sometimes [but] never drink now, sometimes drink but less than once a week, usually drink on 1/2 days a week, usually drink on >2 days a week but not every day, usually drink every day. Adolescents (Teen Focus 4), young adults (at the metabolomics clinic), mothers (in 2013), and fathers (at the metabolomics clinic) were asked the frequency they had drinks containing alcohol with possible answers: never, monthly or less, two to four times a month, two to three times a week, four or more times a week. <br>

Diet data, as predicted kilo-calories consumed per day, was derived from Anderson et al. (2013)[@Anderson2013] and avaialble for ages 7 and 13. Data from age 7 was matched with metabolomics data for children while data from age 13 was matched with adolescents. Diet data was not available for young adults or adults. <br>

In adolescents and young adults, accelerometry data was collected at the same clinic for which metabolomics data were collected. Briefly, individuals wore an accelerometry device for the days following their clinic visit whilst keeping a diary of the times they wore and took off the device. Individuals were advised to wear the accelerometer device if the following days were part of a ‘normal week’ with regards to their activity. For young adults, physical activity data is the average number of minutes per day spent doing moderate to vigorous physical activity. For adolescents, data was available from Teen Focus 3 and is the mean counts per minute spent doing moderate to vigorous physical activity for the whole week. Adults were asked 'do you take part in physical activity (e.g. running, swimming, dancing, golf, tennis, squash, jogging, bowls)?' with possible answers: no, occasionally (less than monthly), frequently (once a month or more). Data for mothers was available in 2010, fathers data was available at the metabolomics clinic. Physical activity data was not available for children. <br>

### Statistical analysis
To investigate the association between measures of adiposity and metabolites, all exposures were Z-scored and linear regression was performed. Variables known to influence the metabolomic profile and adiposity (age[@Yu2012; @Brennan2020], sex[@Brennan2020], education[@Zajacova2018], smoking[@Bonevski2014], alcohol[@Bonevski2014], diet[@Afshin2019], and physical activity[@ODonoghue2018]), were included as confounders. Three linear models were used to investigate potential effects of these confounding variables. Model 1 included age at the metabolomics clinic visit and sex. Model 2 included model 1 and mothers/own level of highest education, whether respondent had ever smoked, frequency respondent had a drink containing alcohol, and predicted kilo-calories consumed per day (diet). Model 3 comprised model 2 and physical activity. For models 1 and 2, individuals with data on all confounders except physical activity were included. Model 3 comprised all individuals included in model 1 and 2 who also had data on physical activity. <br>

For all analyses, the units represent the absolute change in each metabolite per standard deviation change in the exposure. Ninety-five percent confidence intervals were calculated and a multiple testing threshold specific for each group was applied. Multiple testing thresholds were calculated as the number of independent metabolites within the raw data given a Spearman’s rho of approximately 0.75 among the metabolites with data for at least 20% of samples -- this was calculated during metabolite quality control. The number of independent metabolites in each group was: children = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`. <br>

#### Presentation
Metabolites were grouped into subclasses (grouping data provided by the metabolomics platform) based on biological pathway.  Model 2, as the most adjusted and given the reduced sample size in Model 3, is presented as the main analysis for this work. Consistency in the direction of effect estimates across models within each exposure and age group was investigated, as was the number of tests reaching a multiple testing threshold. Directional consistency was investigated for exposures across age groups for model 2. A Spearmans Rho analysis was used to investigate the correlation between effect estimates across exposures and age groups. Visualization and comparison of global metabolic profiles across exposures within age groups, and within exposures and across age groups was performed using Circos plots using the `EpiViz` `R` package[]. Forestplots, created using the `ggforestplot` `R` package, were used to examine specific subclasses where variation among metabolites within the subclass and strong effects were identified. Results for derived measures and *Lipoprotein particle size* and *Fatty acid ratios* are presented in the supplement. Effect estimates were compared to that of previous work by Wurtz et al. (2014)[@Wurtz2014]. <br>

\newpage
## Results
```{r echo=FALSE, warning=FALSE, error=FALSE}
# data ====
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data <- subset(data, subclass != "NA")
# shared metabolites ====
a <- subset(data, model == "model2")
a <- subset(a, exposure == "bmi")
b <- subset(a, group == "children")
c <- subset(a, group == "adolescents")
d <- subset(a, group == "young_adults")
e <- subset(a, group == "adults")
b <- as.data.frame(b[,1])
colnames(b) <- "metabolite"
b$group <- "children"
c <- as.data.frame(c[,1])
colnames(c) <- "metabolite"
c$group <- "adolescents"
d <- as.data.frame(d[,1])
colnames(d) <- "metabolite"
d$group <- "young_adults"
e <- as.data.frame(e[,1])
colnames(e) <- "metabolite"
e$group <- "adults"
f <- full_join(b,c, by = "metabolite")
f <- full_join(f,d, by = "metabolite")
f <- full_join(f,e, by = "metabolite")
metabolites <- f[complete.cases(f), ]
metabolites <- metabolites[,1]
metabolites <- droplevels(metabolites)

# n in each plot
plot_data <- subset(data, exposure == "bmi")
plot_data <- subset(plot_data, model == "model2")
plot_data <- plot_data[plot_data$metabolite %in% metabolites, ]
plot_data <- subset(plot_data, group == "children")
ratios <- subset(plot_data, subclass == "Ratios")
fa_ratios <- subset(plot_data, subclass == "Fatty acids ratios")
lp_size <- subset(plot_data, subclass == "Lipoprotein particle size")


```
In total, metabolomics data was available for 234 metabolites in children (N = `r ALSPAC_N$combined_N[[1]]`), 230 metabolites in adolescents (N = `r ALSPAC_N$combined_N[[3]]`), 224 metabolites in young adults (N = `r ALSPAC_N$combined_N[[5]]`), and 232 metabolites in adults (N = `r ALSPAC_N$combined_N[[9]]`; Table \@ref(tab:chapter4-table-ALSPAC-N)). Quality control was performed twice, firstly including derived metabolites and secondly excluding them. There was a large difference in the number of representative features identified across the two runs, as such quality controlled data used here on was produced having included derived metabolites. <br>

Quality control resulted in: `r children_samples_removed` individuals and `r children_features_removed` metabolites removed from the children's data (4 samples excluded for >= 80% missingness; 1 sample excluded for total sum abundance >= 5 SD from the mean; 1 sample excluded as a result of being >= 5 SD from the mean of PC1 and 2; 4 metabolites removed for >= 20% missingness), `r adolescents_samples_removed` individuals and `r adolescents_features_removed` metabolites removed from the adolescents data (1 sample excluded for total sum abundance >= 5 SD from the mean; 4 samples excluded as a result of being >= 5 SD from the mean of PC1 and 2), `r young_adults_samples_removed` individuals and `r young_adults_features_removed` metabolites removed from the young adults data (1 sample excluded for total sum abundance >= 5 SD from the mean; 3 sample excluded as a result of being >= 5 SD from the mean of PC1 and 2), `r adults_samples_removed` individuals and `r adults_features_removed` metabolites removed from the adults data (1 sample excluded for total sum abundance >= 5 SD from the mean; 6 samples excluded as a eresult of being >= 5 SD from the mean of PC1 and 2; 4 metabolites removed for >= 20% missingness). Quality controlled metabolomics data available for analysis is given in Table \@ref(tab:chapter4-table-ALSPAC-QC-N). A total of `r nlevels(metabolites)` metabolites were measured in all age groups. Of individuals with metabolomics data, a majority also had data on measures of adiposity (Table \@ref(tab:chapter4-table-ALSPAC-adiposity) and Figure \@ref(fig:chapter4-figure-raincloudplot-adiposity-measures)), except for adolescents where data on WHR was not available. Data on confounders were also available in the majority of individuals, the exception being phsyical activity where much fewer individuals had available data and no data was available for children (Table \@ref(tab:chapter4-table-ALSPAC-adiposity). <br>

\blandscape
```{r chapter4-table-ALSPAC-N, echo=FALSE}
data <- ALSPAC_N

# make table
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
  x <- knitr::kable(
    (data), longtable = F, booktabs = T,
    caption = 'Metabolomics data available in ALSPAC', row.names = F,
    col.names = c("Combined group", "N", "N\n metabolites", "Subgroup", "Subgroup\nN", "Unique\nN", "Total\nmetabolites", "Unique\nmetabolites"))
  x <- kable_styling(x, full_width = F) %>%
    collapse_rows(columns = 1:3)
} else {

}
}
x
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-N): the number of individuals with metabolomics data in ALSPAC. Children were measured at 5 time points and combined into three groups (Children, Adolescents, Young adults). Mothers were measured at two time points and combined. Fathers were measured at a single time point. Combined mothers and the fathers data were grouped as Adults. N = number of individuals in the Combined group; N metabolites = the number of metabolites measured in the Combined group; Subgroup = age or clinic identifier; Subgroup N = number of individuals in the Subgroup; Unique N = the number of individuals in the subgroup who do not appear in the other subgroup; Total metabolites = the number of metabolites measured for the Subgroup; Unique metabolites = as with Unique N, the total number of metabolites measured in the Subgroup not measured in the other Subgroup of that Combined group.*
\esmall
\elandscape

```{r chapter4-table-ALSPAC-QC-N, echo=FALSE}
data <- ALSPAC_QC_N
# make table
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
  x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Quality controlled metabolomics data available in ALSPAC', row.names = F,
    col.names = c("Group", "N", "Metabolites"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-QC-N): the number of individuals and metabolites available in ALSPAC after quality control of metabolomics data. Group = the groups clinic visits were combined into; N = number of individuals with available metabolomics data after quality control; Metabolites = the number of metabolites measured in the Group after quality control.*
\esmall

\blandscape
```{r chapter4-table-ALSPAC-adiposity, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")

# adiposity table ====
adiposity_table <- data.frame(Group = c("Children", "Adolescents", "Young_adults", "Adults"),
                              Metabolomics_N = c(ALSPAC_QC_N$N[1],
                                                 ALSPAC_QC_N$N[2],
                                                 ALSPAC_QC_N$N[3],
                                                 ALSPAC_QC_N$N[4]),
                              BMI_N = c(nrow(children_qc[!is.na(children_qc$bmi),]),
                                        nrow(adolescents_qc[!is.na(adolescents_qc$bmi),]),
                                        nrow(young_adults_qc[!is.na(young_adults_qc$bmi),]),
                                        nrow(adults_qc[!is.na(adults_qc$bmi),])),
                              BMI_mean = c(round(mean(children_qc$bmi, na.rm  = T), 2),
                                           round(mean(adolescents_qc$bmi, na.rm  = T), 2),
                                           round(mean(young_adults_qc$bmi, na.rm  = T), 2),
                                           round(mean(adults_qc$bmi, na.rm  = T), 2)),
                              BMI_SD = c(round(sd(children_qc$bmi, na.rm  = T), 2),
                                         round(sd(adolescents_qc$bmi, na.rm  = T), 2),
                                         round(sd(young_adults_qc$bmi, na.rm  = T), 2),
                                         round(sd(adults_qc$bmi, na.rm  = T), 2)),
                              WHR_N = c(nrow(children_qc[!is.na(children_qc$whr),]),
                                        "-",
                                        nrow(young_adults_qc[!is.na(young_adults_qc$whr),]),
                                        nrow(adults_qc[!is.na(adults_qc$whr),])),
                              WHR_mean = c(round(mean(children_qc$whr, na.rm  = T), 2),
                                           "-",
                                           round(mean(young_adults_qc$whr, na.rm  = T), 2),
                                           round(mean(adults_qc$whr, na.rm  = T), 2)),
                              WHR_SD = c(round(sd(children_qc$whr, na.rm  = T), 2),
                                         "-",
                                         round(sd(young_adults_qc$whr, na.rm  = T), 2),
                                         round(sd(adults_qc$whr, na.rm  = T), 2)),
                              BF_N = c(nrow(children_qc[!is.na(children_qc$bf),]),
                                       nrow(adolescents_qc[!is.na(adolescents_qc$bf),]),
                                       nrow(young_adults_qc[!is.na(young_adults_qc$bf),]),
                                       nrow(adults_qc[!is.na(adults_qc$bf),])),
                              BF_mean = c("-",
                                          round(mean(adolescents_qc$bf, na.rm  = T), 2),
                                          round(mean(young_adults_qc$bf, na.rm  = T), 2),
                                          round(mean(adults_qc$bf, na.rm  = T), 2)),
                              BF_SD = c("-",
                                        round(sd(adolescents_qc$bf, na.rm  = T), 2),
                                        round(sd(young_adults_qc$bf, na.rm  = T), 2),
                                        round(sd(adults_qc$bf, na.rm  = T), 2))
                              )
data <- adiposity_table
# make table ====
if (doc.type == "docx") { 
  x <- data
  
  } else { 

if (doc.type != "docx") { 
    x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'measures of adiposity available for individuals with metabolomics data', row.names = F, col.names = c("Group", "N", "BMI N","mean","SD","WHR N","mean","SD","BF N","mean","SD"))
  x <- kable_styling(x, full_width = F) 
} else {

}
}
x
#=====
rm(children_qc,adolescents_qc,young_adults_qc,adults_qc,adiposity_table)
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-adiposity) gives information on measures of adiposity for individuals with metabolomics data. Measures were obtained for all individuals who had raw metabolomics data; WHR was not available for adolescents. Group = the groups clinic visits were combined into; Data = whether the data presented is for the raw or the QC'd metabolomics data; N = the number of individuals with available data; mean = the mean of the anthropometric measure; SD = standard deviation of the mean. NA = data not available.*
\esmall
\elandscape

```{r chapter4-figure-raincloudplot-adiposity-measures, echo=FALSE, out.width='100%', fig.cap="Raincloud plots of ALSPAC individuals data on measures of adiposity"}
knitr::include_graphics("data/chapter4/figures/plot_raincloud_adiposity_measures.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-raincloudplot-adiposity-measures) shows the distribution of adiposity measures among different groups separated by sex. Data is presented for individuals with pre-QC metabolomics data and of known sex. The interquartile range and median are also shown. From left to right: children, adolescents, young adults, adults. From top to bottom: body mass index (BMI), waist hip ratio (WHR), body fat percentage (BF). Red = male; grey = female. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019]*
\esmall

```{r chapter4-table-ALSPAC-confounders, echo=FALSE, warning=FALSE, error=FALSE}
children_qc <- read.table("data/chapter4/data/analysis/children_qc_phenofile.txt", header = T, sep = "\t")
adolescents_qc <- read.table("data/chapter4/data/analysis/adolescents_qc_phenofile.txt", header = T, sep = "\t")
young_adults_qc <- read.table("data/chapter4/data/analysis/young_adults_qc_phenofile.txt", header = T, sep = "\t")
adults_qc <- read.table("data/chapter4/data/analysis/adult_qc_phenofile.txt", header = T, sep = "\t")
ALSPAC_N <- read.table("data/chapter4/data/metabolomics/data_prep/other/ALSPAC_N.txt", header = T, sep = "\t")
ALSPAC_QC_N <- read.table("data/chapter4/data/metabolomics/data_prep/final/qc/ALSPAC_QC_N.txt", header = T, sep = "\t")


# table ====
data <- data.frame(group = c("Metabolomics",
                             "Age", "Age", "Age",
                             "Sex","Sex",
                             "Education", "Education", "Education", "Education", "Education",
                             "Smoking",
                             "Alcohol", "Alcohol", "Alcohol", "Alcohol", "Alcohol",
                             "Diet", "Diet", "Diet",
                             "Physical activity", "Physical activity","Physical activity"),
                   subgroup = c("N",
                                "N","Mean","SD",
                                "N","Female",
                                "1","2","3","4","5",
                                "N",
                                "1","2","3","4","5",
                                "N","Mean","SD",
                                "N/1","Mean/2","SD/3"),
                   children = c(ALSPAC_QC_N$N[1],
                                nrow(children_qc[!is.na(children_qc$age),]),round(mean(children_qc$age, na.rm  = T), 2),round(sd(children_qc$age, na.rm  = T), 2),
                                nrow(children_qc[!is.na(children_qc$sex),]),table(children_qc$sex)[[2]],
                                round(table(children_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[1] * 100, 2),round(table(children_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[1] * 100, 2),round(table(children_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[1] * 100, 2),round(table(children_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[1] * 100, 2),round(table(children_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[1] * 100, 2),
                                "-",
                                "-","-","-","-","-",
                                nrow(children_qc[!is.na(children_qc$diet),]),round(mean(children_qc$diet, na.rm  = T), 2),round(sd(children_qc$diet, na.rm  = T), 2),
                                "-","-","-"),
                   adolescents = c(as.numeric(ALSPAC_QC_N$N[2]),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$age),]),round(mean(adolescents_qc$age, na.rm  = T), 2),round(sd(adolescents_qc$age, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$sex),]),table(adolescents_qc$sex)[[2]],
                                   round(table(adolescents_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[2] * 100, 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$ever_smoked),]),
                                   round(table(adolescents_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[2] * 100, 2),round(table(adolescents_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[2] * 100, 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$diet),]),round(mean(adolescents_qc$diet, na.rm  = T), 2),round(sd(adolescents_qc$diet, na.rm  = T), 2),
                                   nrow(adolescents_qc[!is.na(adolescents_qc$physical_activity),]),round(mean(adolescents_qc$physical_activity, na.rm  = T), 2),round(sd(adolescents_qc$physical_activity, na.rm  = T), 2)),
                   young_adults = c(ALSPAC_QC_N$N[3],
                                    nrow(young_adults_qc[!is.na(young_adults_qc$age),]),round(mean(young_adults_qc$age, na.rm  = T), 2),round(sd(young_adults_qc$age, na.rm  = T), 2),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$sex),]),table(young_adults_qc$sex)[[2]],
                                    round(table(young_adults_qc$maternal_education)[[1]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$maternal_education)[[2]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$maternal_education)[[3]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$maternal_education)[[4]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$maternal_education)[[5]]/ALSPAC_QC_N$N[3] * 100, 2),
                                    nrow(young_adults_qc[!is.na(young_adults_qc$ever_smoked),]),
                                    round(table(young_adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[3] * 100, 2),round(table(young_adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[3] * 100, 2),
                                    "-","-","-",
                                    nrow(young_adults_qc[!is.na(young_adults_qc$physical_activity),]),round(mean(young_adults_qc$physical_activity, na.rm  = T), 2),round(sd(young_adults_qc$physical_activity, na.rm  = T), 2)),
                                    
                   adults = c(ALSPAC_QC_N$N[4],
                              nrow(adults_qc[!is.na(adults_qc$age),]),round(mean(adults_qc$age, na.rm  = T), 2),round(sd(adults_qc$age, na.rm  = T), 2),
                              nrow(adults_qc[!is.na(adults_qc$sex),]),table(adults_qc$sex)[[2]],
                              round(table(adults_qc$education)[[1]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$education)[[2]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$education)[[3]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$education)[[4]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$education)[[5]]/ALSPAC_QC_N$N[4] * 100, 2),
                              nrow(adults_qc[!is.na(adults_qc$ever_smoked),]),
                              round(table(adults_qc$frequency_alcohol)[[1]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$frequency_alcohol)[[2]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$frequency_alcohol)[[3]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$frequency_alcohol)[[4]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$frequency_alcohol)[[5]]/ALSPAC_QC_N$N[4] * 100, 2),
                              "-","-","-",
                              round(table(adults_qc$physical_activity)[[1]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$physical_activity)[[2]]/ALSPAC_QC_N$N[4] * 100, 2),round(table(adults_qc$physical_activity)[[3]]/ALSPAC_QC_N$N[4] * 100, 2))
                   )

# make table ====
if (doc.type == "docx") { 
x <- data

} else { 
  
  if (doc.type != "docx") { 
x <- knitr::kable(
  (data), longtable = T, booktabs = T,
  caption = 'Confounders available for individuals with raw metabolomics data', row.names = F, col.names = c("","","Children","Adolescents","Young adults","Adults"))
x <- kable_styling(x, full_width = F) %>%
  collapse_rows(columns = 1) 
    
    
  } else {
    
  }
}
#=====
rm(children_qc,adolescents_qc,young_adults_qc,adults_qc,data)
x
```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-ALSPAC-confounders) gives information on confounders for individuals with metabolomics data. Data on confounders were obtained for all individuals who had raw metabolomics data. Smoking and alcohol data were not available for children. Diet was not available for young adults and adults. Physical activity data was not available for children. Education is highest level of education; for children, adolescents, and young adults education is maternal education; for adults education is own education. Smoking is binary. Alcohol is frequency respondent consumes an alcoholic drink, with 1 being low and 5 high. Diet is predicted kilo-calories consumed per day derived from Anderson et al. (2013)[@Anderson2013]. Physical activity in adolescents is mean counts per minute of activity across 7 days (based on valid days). For young adults physical activity is the average number of valid minutes per day spent doing moderate to vigorous activity. For adults, physical activity is: no physical activity (1), occasionally (2), frequently (3). Group = the groups clinic visits were combined into; N = the number of individuals with available data; mean = the mean of the measure; SD = standard deviation of the mean. - = data not available.*
\esmall

### Validation of impedance
In children, a measure of BF was not available. Instead, impedance ($ohms$) was used to calculate (Equation \@ref(eq:BF)) BF. The calculated BF resulted in negative estimates of BF for some children (Figure \@ref(fig:chapter4-figure-BF-validation-distribution)). The calculated BF was positively correlated with weight, height and BMI in children. In adolescents, the calculated BF did not produce negative estimates and was positively correlated with impedance and DXA derived BF estimates (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)), as well as with weight, height, and BMI (Figure \@ref(fig:chapter4-figure-BF-validation-correlation)). Child calculated BF positively correlated with adolescent measures of BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). Impedance in children and adolescents negatively correlated with BMI and weight, but showed little evidence for a correlation with height (Figure \@ref(fig:chapter4-figure-BF-validation-distribution)). Similarly, there was weak evidence for correlation between impedance in children and adolescents and adolescent measures of BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). <br>

Equation \@ref(eq:BF) was derived using adult data; given the volumetric difference between adults and children (BMI  cubed rather than BMI squared may be more appropriate in children[@Stergiakouli2014]) differences in the range of estimates is unsurprising. As there is strong correlation between calculated BF and other measures of BF in adolescents, and with weight, height and BMI in children even with negative estimates, and that in a linear model the estimate is based on the per-unit increase, the absolute value of the exposure does not, in this instance, need to be positive. As such, BF calculated using equation \@ref(eq:BF) was used in subsequent analyses. <br> 

```{r chapter4-figure-BF-validation-distribution, echo=FALSE, out.width='100%', fig.cap="Raincloud plots of impedance and BF in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_raincloud.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-distribution) shows the distribution of the raw impedance value measured in $ohms$ and BF derived using equation \@ref(eq:BF) for children and adolescents. Data is presented for complete cases across: raw metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. The interquartile range and median are also shown. Data is organised with males at the top and females at the bottom of each individual plot. Raincloud plots produced using the `RainCloudPlots` `R` package[@Allen2019]*
\esmall

```{r chapter4-figure-BF-validation-correlation-2, echo=FALSE, out.width='100%', fig.cap="Correlation between differnet BF measures in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_correlation_bf.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2) shows correlations for BF calculated using equation \@ref(eq:BF) in children and adolescents. Column 1 shows correlations between child impedance values and adolescent BF estimates. Column 2 shows correlations for child calculated BF and adolescent BF estimates. Column 3 shows correlations for adolescent calculated BF and adolescent BF estimates. Data is presented for complete cases across: QC'd metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. Data for men is shown in grey and women in red.*
\esmall

```{r chapter4-figure-BF-validation-correlation, echo=FALSE, out.width='100%', fig.cap="Correlation between BF and BMI, height, and weight in children and adolescents"}
knitr::include_graphics("data/chapter4/figures/bf_validation_correlation.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-BF-validation-correlation) shows correlations for impedance and BF for children (columns 1 and 2) and adolescents (columns 3-6) with BMI (top row), weight (middle row), and height (bottom row). BF_calculates is BF derived using the raw impedance value measured in ohms and equation \@ref(eq:BF). Data is presented for complete cases across: QC'd metabolomics, BMI, WHR (children only), impedance, height, weight, age, sex, and BF derived by impedance and DXA in adolescents. Data for men is shown in grey and women in red.*
\esmall



### Statistical analysis
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
```
#### Directional consistency: across models within exposures and age groups
Across models within each exposure and age group a majority of tests resulted in directionally consistent effect estimates (Figure \@ref(fig:chapter4-figure-directional-consistency)). Of these directionally consistent effects, the majority of effect estimates were positive. The strength of the effect estimates were broadly consistent across models; confidence intervals overlapped across the majority of metabolites for all models within each group and exposure (Supplementary \@ref(chapter4-appendix-figures-forestplots)). Of the `r nlevels(metabolites)` metabolites measured in all age groups, directional consistency was supported by strong evidence of correlation across models within exposures and age groups (Supplement \@ref(chapter4-appendix-correlations)). <br>

```{r chapter4-figure-directional-consistency, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap="Directional consistency across linear models"}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,14,15,16)]
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## seperate data into exposures ====
children_bmi <- subset(children, exposure == "bmi")
children_whr <- subset(children, exposure == "whr")
children_bf <- subset(children, exposure == "bf")
adolescents_bmi <- subset(adolescents, exposure == "bmi")
adolescents_whr <- subset(adolescents, exposure == "whr")
adolescents_bf <- subset(adolescents, exposure == "bf")
young_adults_bmi <- subset(young_adults, exposure == "bmi")
young_adults_whr <- subset(young_adults, exposure == "whr")
young_adults_bf <- subset(young_adults, exposure == "bf")
adults_bmi <- subset(adults, exposure == "bmi")
adults_whr <- subset(adults, exposure == "whr")
adults_bf <- subset(adults, exposure == "bf")

## convert to wide based on model ====
children_bmi <- spread(children_bmi, model, b)
children_whr <- spread(children_whr, model, b)
children_bf <- spread(children_bf, model, b)
adolescents_bmi <- spread(adolescents_bmi, model, b)
adolescents_whr <- spread(adolescents_whr, model, b)
adolescents_bf <- spread(adolescents_bf, model, b)
young_adults_bmi <- spread(young_adults_bmi, model, b)
young_adults_whr <- spread(young_adults_whr, model, b)
young_adults_bf <- spread(young_adults_bf, model, b)
adults_bmi <- spread(adults_bmi, model, b)
adults_whr <- spread(adults_whr, model, b)
adults_bf <- spread(adults_bf, model, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children_bmi ====
data <- children_bmi[,c(4:ncol(children_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_bmi <- data
children_bmi$exposure <- "children_bmi"
### children_whr ====
data <- children_whr[,c(4:ncol(children_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_whr <- data
children_whr$exposure <- "children_whr"


### children_bf ====
data <- children_bf[,c(4:ncol(children_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children_bf <- data
children_bf$exposure <- "children_bf"

### adolescents_bmi ====
data <- adolescents_bmi[,c(4:ncol(adolescents_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents_bmi <- data
adolescents_bmi$exposure <- "adolescents_bmi"

### adolescents_bf ====
data <- adolescents_bf[,c(4:ncol(adolescents_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents_bf <- data
adolescents_bf$exposure <- "adolescents_bf"

### young_adults_bmi ====
data <- young_adults_bmi[,c(4:ncol(young_adults_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_bmi <- data
young_adults_bmi$exposure <- "young_adults_bmi"

### young_adults_whr ====
data <- young_adults_whr[,c(4:ncol(young_adults_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_whr <- data
young_adults_whr$exposure <- "young_adults_whr"

### young_adults_bf ====
data <- young_adults_bf[,c(4:ncol(young_adults_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults_bf <- data
young_adults_bf$exposure <- "young_adults_bf"

### adults_bmi ====
data <- adults_bmi[,c(4:ncol(adults_bmi))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_bmi <- data
adults_bmi$exposure <- "adults_bmi"

### adults_whr ====
data <- adults_whr[,c(4:ncol(adults_whr))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_whr <- data
adults_whr$exposure <- "adults_whr"

### adults_bf ====
data <- adults_bf[,c(4:ncol(adults_bf))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults_bf <- data
adults_bf$exposure <- "adults_bf"

## join data frames ====
data <- bind_rows(children_bmi,children_whr,children_bf,adolescents_bmi,adolescents_bf,young_adults_bmi,young_adults_whr,young_adults_bf,adults_bmi,adults_whr,adults_bf)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure )[c(6,8,7,2,1,10,9,11,4,5,3)])
# plot ====
ggplot(data = data,
       aes(x = exposure)) +
  geom_bar(aes(fill = direction_group))  +
  scale_fill_manual(values = discrete_wes_pal) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                             title = "",
                             label.hjust = 0,
                             label.vjust = 0.5)) +
  xlab("") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank())
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-directional-consistency) shows the directional consistency of all models for each group and exposure A positive effect reflects both model betas being in the positive direction; a negative effect reflects both model betas being in a negative direction; opposite effect reflects different directions for the model betas. BMI = body mass index; WHR = waist hip ratio; FFM = fat free mass; BF = body fat percentage.*
\esmall

#### Multiple testing threshold
```{r echo=FALSE, warning=FALSE, error=FALSE}
library(tidyr)
# how many consistent significnat effects
# main analysis, consistent direction, significant ====
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data_all <- data
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

n_children <- nrow(children)/3
n_adolescents <- nrow(adolescents)/2
n_young_adults <- nrow(young_adults)/3
n_adults <- nrow(adults)/3

## subset for multiple testing threshold ====
children <- subset(children, p <= 0.05/54)
adolescents <- subset(adolescents, p <= 0.05/48)
young_adults <- subset(young_adults, p <= 0.05/46)
adults <- subset(adults, p <= 0.05/53)

# limit to interested rows ====
children <- children[,c(1,3,13,14,15)]
adolescents <- adolescents[,c(1,3,13,14,15)]
young_adults <- young_adults[,c(1,3,13,14,15)]
adults <- adults[,c(1,3,13,14,15)]

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

### children ====
data <- children[,c(4:ncol(children))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$group <- "children"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$group <- "adolescents"

### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$group <- "young_adults"

### adults ====
data <- adults[,c(4:ncol(adults))]
data <- data[complete.cases(data), ]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                                     direction == 2 ~ "Negative effect",
                                     direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                               levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$group <- "adults"

```

```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/54)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/54)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/54)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/54)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/54)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/54)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/48)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/48)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/48)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/48)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/48)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/48)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/46)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/46)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/46)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/53)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/53)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/53)

# precent of total ====
children_m1_bmi_percent <- nrow(children_m1_bmi_sig) / nrow(children_m1_bmi) * 100
children_m2_bmi_percent <- nrow(children_m2_bmi_sig) / nrow(children_m2_bmi) * 100
children_m1_whr_percent <- nrow(children_m1_whr_sig) / nrow(children_m1_whr) * 100
children_m2_whr_percent <- nrow(children_m2_whr_sig) / nrow(children_m2_whr) * 100
children_m1_bf_percent <- nrow(children_m1_bf_sig) / nrow(children_m1_bf) * 100
children_m2_bf_percent <- nrow(children_m2_bf_sig) / nrow(children_m2_bf) * 100
adolescents_m1_bmi_percent <- nrow(adolescents_m1_bmi_sig) / nrow(adolescents_m1_bmi) * 100
adolescents_m2_bmi_percent <- nrow(adolescents_m2_bmi_sig) / nrow(adolescents_m2_bmi) * 100
adolescents_m3_bmi_percent <- nrow(adolescents_m3_bmi_sig) / nrow(adolescents_m3_bmi) * 100
adolescents_m1_bf_percent <- nrow(adolescents_m1_bf_sig) / nrow(adolescents_m1_bf) * 100
adolescents_m2_bf_percent <- nrow(adolescents_m2_bf_sig) / nrow(adolescents_m2_bf) * 100
adolescents_m3_bf_percent <- nrow(adolescents_m3_bf_sig) / nrow(adolescents_m3_bf) * 100
young_adults_m1_bmi_percent <- nrow(young_adults_m1_bmi_sig) / nrow(young_adults_m1_bmi) * 100
young_adults_m2_bmi_percent <- nrow(young_adults_m2_bmi_sig) / nrow(young_adults_m2_bmi) * 100
young_adults_m3_bmi_percent <- nrow(young_adults_m3_bmi_sig) / nrow(young_adults_m3_bmi) * 100
young_adults_m1_whr_percent <- nrow(young_adults_m1_whr_sig) / nrow(young_adults_m1_whr) * 100
young_adults_m2_whr_percent <- nrow(young_adults_m2_whr_sig) / nrow(young_adults_m2_whr) * 100
young_adults_m3_whr_percent <- nrow(young_adults_m3_whr_sig) / nrow(young_adults_m3_whr) * 100
young_adults_m1_bf_percent <- nrow(young_adults_m1_bf_sig) / nrow(young_adults_m1_bf) * 100
young_adults_m2_bf_percent <- nrow(young_adults_m2_bf_sig) / nrow(young_adults_m2_bf) * 100
young_adults_m3_bf_percent <- nrow(young_adults_m3_bf_sig) / nrow(young_adults_m3_bf) * 100
adults_m1_bmi_percent <- nrow(adults_m1_bmi_sig) / nrow(adults_m1_bmi) * 100
adults_m2_bmi_percent <- nrow(adults_m2_bmi_sig) / nrow(adults_m2_bmi) * 100
adults_m3_bmi_percent <- nrow(adults_m3_bmi_sig) / nrow(adults_m3_bmi) * 100
adults_m1_whr_percent <- nrow(adults_m1_whr_sig) / nrow(adults_m1_whr) * 100
adults_m2_whr_percent <- nrow(adults_m2_whr_sig) / nrow(adults_m2_whr) * 100
adults_m3_whr_percent <- nrow(adults_m3_whr_sig) / nrow(adults_m3_whr) * 100
adults_m1_bf_percent <- nrow(adults_m1_bf_sig) / nrow(adults_m1_bf) * 100
adults_m2_bf_percent <- nrow(adults_m2_bf_sig) / nrow(adults_m2_bf) * 100
adults_m3_bf_percent <- nrow(adults_m3_bf_sig) / nrow(adults_m3_bf) * 100

min_significant_percent <- round(min(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

max_significant_percent <- round(max(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

mean_significnat_percent <- round(mean(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

median_significant_percent <- round(median(children_m1_bmi_percent,children_m2_bmi_percent,children_m1_whr_percent,children_m2_whr_percent,children_m2_bf_percent,
    adolescents_m1_bmi_percent,adolescents_m2_bmi_percent,adolescents_m3_bmi_percent,adolescents_m1_bf_percent,adolescents_m2_bf_percent,adolescents_m3_bf_percent,
    young_adults_m1_bmi_percent,young_adults_m2_bmi_percent,young_adults_m3_bmi_percent,young_adults_m1_whr_percent,young_adults_m2_whr_percent,young_adults_m3_whr_percent,young_adults_m1_bf_percent,young_adults_m2_bf_percent,young_adults_m3_bf_percent,
    adults_m1_bmi_percent,adults_m2_bmi_percent,adults_m3_bmi_percent,adults_m1_whr_percent,adults_m2_whr_percent,adults_m3_whr_percent,adults_m1_bf_percent,adults_m2_bf_percent,adults_m3_bf_percent),2)

# percent change ====
adolescents_m1_m3_bmi_percent_change <- (nrow(adolescents_m1_bmi_sig) - nrow(adolescents_m3_bmi_sig)) / nrow(adolescents_m1_bmi_sig) * 100


```

Across all models and exposures, between `r min_significant_percent` percent and `r max_significant_percent` percent (median = `r round(median_significant_percent,1)` percent) of metabolites reached a multiple testing threshold (children multiple testing threshold = `r children_independent`, adolescents = `r adolescents_independent`, young adults = `r young_adults_independent`, adults = `r adults_independent`; Table \@ref(tab:chapter4-table-significant-results)). Of those with a consistent direction of effect across the three exposures a total of `r nrow(children)`, `r nrow(adolescents)`, `r nrow(young_adults)`, and `r nrow(adults)` metabolites reached a multiple testing threshold for children, adolescents, young adults, and adults respectively. This equates to `r round(nrow(children)/n_children*100)`, `r round(nrow(adolescents)/n_adolescents*100)`, `r round(nrow(young_adults)/n_young_adults*100)`, and `r round(nrow(adults)/n_adults*100)` percent of metabolites. <br>

```{r chapter4-table-significant-results, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")

# children ====
children_m1_bmi <- subset(data, model == "model1" & group == "children" & exposure == "bmi")
children_m1_bmi_sig <- subset(children_m1_bmi, p < 0.05/54)
children_m2_bmi <- subset(data, model == "model2" & group == "children" & exposure == "bmi")
children_m2_bmi_sig <- subset(children_m2_bmi, p < 0.05/54)
children_m1_whr <- subset(data, model == "model1" & group == "children" & exposure == "whr")
children_m1_whr_sig <- subset(children_m1_whr, p < 0.05/54)
children_m2_whr <- subset(data, model == "model2" & group == "children" & exposure == "whr")
children_m2_whr_sig <- subset(children_m2_whr, p < 0.05/54)
children_m1_bf <- subset(data, model == "model1" & group == "children" & exposure == "bf")
children_m1_bf_sig <- subset(children_m1_bf, p < 0.05/54)
children_m2_bf <- subset(data, model == "model2" & group == "children" & exposure == "bf")
children_m2_bf_sig <- subset(children_m2_bf, p < 0.05/54)

# adolescents ====
adolescents_m1_bmi <- subset(data, model == "model1" & group == "adolescents" & exposure == "bmi")
adolescents_m1_bmi_sig <- subset(adolescents_m1_bmi, p < 0.05/48)
adolescents_m2_bmi <- subset(data, model == "model2" & group == "adolescents" & exposure == "bmi")
adolescents_m2_bmi_sig <- subset(adolescents_m2_bmi, p < 0.05/48)
adolescents_m3_bmi <- subset(data, model == "model3" & group == "adolescents" & exposure == "bmi")
adolescents_m3_bmi_sig <- subset(adolescents_m3_bmi, p < 0.05/48)
adolescents_m1_bf <- subset(data, model == "model1" & group == "adolescents" & exposure == "bf")
adolescents_m1_bf_sig <- subset(adolescents_m1_bf, p < 0.05/48)
adolescents_m2_bf <- subset(data, model == "model2" & group == "adolescents" & exposure == "bf")
adolescents_m2_bf_sig <- subset(adolescents_m2_bf, p < 0.05/48)
adolescents_m3_bf <- subset(data, model == "model3" & group == "adolescents" & exposure == "bf")
adolescents_m3_bf_sig <- subset(adolescents_m3_bf, p < 0.05/48)

# young_adults ====
young_adults_m1_bmi <- subset(data, model == "model1" & group == "young_adults" & exposure == "bmi")
young_adults_m1_bmi_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_bmi <- subset(data, model == "model2" & group == "young_adults" & exposure == "bmi")
young_adults_m2_bmi_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_bmi <- subset(data, model == "model3" & group == "young_adults" & exposure == "bmi")
young_adults_m3_bmi_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_whr <- subset(data, model == "model1" & group == "young_adults" & exposure == "whr")
young_adults_m1_whr_sig <- subset(young_adults_m1_bmi, p < 0.05/46)
young_adults_m2_whr <- subset(data, model == "model2" & group == "young_adults" & exposure == "whr")
young_adults_m2_whr_sig <- subset(young_adults_m2_bmi, p < 0.05/46)
young_adults_m3_whr <- subset(data, model == "model3" & group == "young_adults" & exposure == "whr")
young_adults_m3_whr_sig <- subset(young_adults_m3_bmi, p < 0.05/46)
young_adults_m1_bf <- subset(data, model == "model1" & group == "young_adults" & exposure == "bf")
young_adults_m1_bf_sig <- subset(young_adults_m1_bf, p < 0.05/46)
young_adults_m2_bf <- subset(data, model == "model2" & group == "young_adults" & exposure == "bf")
young_adults_m2_bf_sig <- subset(young_adults_m2_bf, p < 0.05/46)
young_adults_m3_bf <- subset(data, model == "model3" & group == "young_adults" & exposure == "bf")
young_adults_m3_bf_sig <- subset(young_adults_m3_bf, p < 0.05/46)

# adults ====
adults_m1_bmi <- subset(data, model == "model1" & group == "adults" & exposure == "bmi")
adults_m1_bmi_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_bmi <- subset(data, model == "model2" & group == "adults" & exposure == "bmi")
adults_m2_bmi_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_bmi <- subset(data, model == "model3" & group == "adults" & exposure == "bmi")
adults_m3_bmi_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_whr <- subset(data, model == "model1" & group == "adults" & exposure == "whr")
adults_m1_whr_sig <- subset(adults_m1_bmi, p < 0.05/53)
adults_m2_whr <- subset(data, model == "model2" & group == "adults" & exposure == "whr")
adults_m2_whr_sig <- subset(adults_m2_bmi, p < 0.05/53)
adults_m3_whr <- subset(data, model == "model3" & group == "adults" & exposure == "whr")
adults_m3_whr_sig <- subset(adults_m3_bmi, p < 0.05/53)
adults_m1_bf <- subset(data, model == "model1" & group == "adults" & exposure == "bf")
adults_m1_bf_sig <- subset(adults_m1_bf, p < 0.05/53)
adults_m2_bf <- subset(data, model == "model2" & group == "adults" & exposure == "bf")
adults_m2_bf_sig <- subset(adults_m2_bf, p < 0.05/53)
adults_m3_bf <- subset(data, model == "model3" & group == "adults" & exposure == "bf")
adults_m3_bf_sig <- subset(adults_m3_bf, p < 0.05/53)

# table data frame ====
data <- data.frame(group = c("Children", "Adolescents", "Young adults", "Adults"),
                   metabolites = c(nrow(children_m1_bmi), nrow(adolescents_m1_bmi), nrow(young_adults_m1_bmi), nrow(adults_m1_bmi)),
                   m1_bmi = c(nrow(children_m1_bmi_sig), nrow(adolescents_m1_bmi_sig), nrow(young_adults_m1_bmi_sig), nrow(adults_m1_bmi_sig)),
                   m2_bmi = c(nrow(children_m2_bmi_sig), nrow(adolescents_m2_bmi_sig), nrow(young_adults_m2_bmi_sig), nrow(adults_m2_bmi_sig)),
                   m3_bmi = c("--", nrow(adolescents_m3_bmi_sig), nrow(young_adults_m3_bmi_sig), nrow(adults_m3_bmi_sig)),
                   m1_whr = c(nrow(children_m1_whr_sig), "--", nrow(young_adults_m1_whr_sig), nrow(adults_m1_whr_sig)),
                   m2_whr = c(nrow(children_m2_whr_sig), "--", nrow(young_adults_m2_whr_sig), nrow(adults_m2_whr_sig)),
                   m3_whr = c("--", "--", nrow(young_adults_m3_whr_sig), nrow(adults_m3_whr_sig)),
                   m1_bf = c(nrow(children_m1_bf_sig), nrow(adolescents_m1_bf_sig), nrow(young_adults_m1_bf_sig), nrow(adults_m1_bf_sig)),
                   m2_bf = c(nrow(children_m2_bf_sig), nrow(adolescents_m2_bf_sig), nrow(young_adults_m2_bf_sig), nrow(adults_m2_bf_sig)),
                   m3_bf = c("--", nrow(adolescents_m3_bf_sig), nrow(young_adults_m3_bf_sig), nrow(adults_m3_bf_sig))
                   )


# make table ====
if (doc.type == "docx") { 
x <- data
  } else { 

if (doc.type != "docx") { 
    x <- knitr::kable(
    (data), longtable = T, booktabs = T,
    caption = 'Metabolites reaching a multiple testing threshold', row.names = F, col.names = c("","N","1","2","3","1","2","3","1","2","3"))
  x <- kable_styling(x, full_width = F) %>%
    add_header_above(c(" " = 2, "BMI" = 3, "WHR" = 3, "BF" = 3))
} else {

}
}
x

```
\noindent 
\bsmall
*Table \@ref(tab:chapter4-table-significant-results) shows the number of metabolites reaching a multiple testing threshold for each model within each age group. Multiple testing thresholds: children = 54, adolescents = 48, young adults = 46, adults = 53. N = total number of metabolites tested; BMI = body mass index; WHR = waist hip ratio; BF = body fat percentage (in children this is fat free mass); 1 = model 1 adjustment for age and sex; 2 = model 2 adjustment for model 1 plus maternal/own education, smoking status, alcohol frequency, diet (where available); 3 = model 3, adjustment for model 2 plus physical activity (where available).*
\esmall

#### Directional consistency: across exposures within age groups for model 2
```{r echo=FALSE, warning=FALSE, error=FALSE}
# packages
library(tidyr)
library(dplyr)
library(ggplot2)
library(cowplot)
source("data/index/colour_palette.R")
# data ==== 
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep ="\t")
data <- data[,c(1,3,14,15,16)]
data <- subset(data, model == "model2")
children <- subset(data, group == "children")
adolescents <- subset(data, group == "adolescents")
young_adults <- subset(data, group == "young_adults")
adults <- subset(data, group == "adults")

## convert to wide based on model ====
children <- spread(children, exposure, b)
adolescents <- spread(adolescents, exposure, b)
young_adults <- spread(young_adults, exposure, b)
adults <- spread(adults, exposure, b)

## assign values for directions consistent across non-clumped and clumped data ====
### children ====
data <- children[,c(4:ncol(children))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
children <- data
children$exposure <- "children"
# ### children inverse
# data <- children[,c(4:ncol(children))]
# data <- data[complete.cases(data), ]
# data$direction = sapply( 1:nrow(data), function(i){
# 	## set data vector
# 	x = sign( data[i, ] )
# 	##
# 	if( x[1] == -1 & sum(x[2:3]) == 2 ){
# 		direct = 1
# 	} else{
# 		if( x[1] == 1 & sum(x[2:3]) == -2 ){
# 		direct = 2
# 		} else {
# 			direct = 3
# 		}
# 	}
# 	}
# )
# data <- data %>%
#   mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
#                                      direction == 2 ~ "Negative effect",
#                                      direction == 3 ~ "Opposite effect"))
# data$direction_group <- factor(data$direction_group,
#                                levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
# children_inverse <- data
# children_inverse$exposure <- "children_inverse"

### adolescents ====
data <- adolescents[,c(4:ncol(adolescents))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adolescents <- data
adolescents$exposure <- "adolescents"
### young_adults ====
data <- young_adults[,c(4:ncol(young_adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
young_adults <- data
young_adults$exposure <- "young_adults"
### adults ====
data <- adults[,c(4:ncol(adults))]
data$direction <- sapply(1:nrow(data), function(x) ifelse(all(sign(data[x,]) == 1), 1, ifelse(all(sign(data[x,]) == -1), 2, 0)))
data <- data %>%
  mutate(direction_group = case_when(direction == 1 ~ "Positive effect",
                               direction == 2 ~ "Negative effect",
                               direction == 0 ~ "Opposite effect"))
data$direction_group <- factor(data$direction_group,
                            levels = c("Positive effect", "Negative effect", "Opposite effect"),ordered = TRUE)
adults <- data
adults$exposure <- "adults"
## join data frames ====
data <- bind_rows(children,adolescents,young_adults,adults)
data$exposure <- as.factor(data$exposure)
data$exposure <- factor(data$exposure ,levels(data$exposure)[c(3,1,4,2)])
```

Results here on are presented for model 2 only; results for models 1 and 3 are presented in the supplement. Across exposures within each age group, effects showed mostly consistent directions of effect, with the majority being  positive (Figure \@ref(fig:chapter4-figure-directional-consistency-2)). The most inconsistent directions across exposures were found for children, where `r round(table(children$direction_group)[[3]]/(nrow(children))*100)` percent of metabolites showed inconsistent directions of effect. For adolescents, young adults, and adults `r round(table(adolescents$direction_group)[[3]]/(nrow(adolescents))*100)`, `r round(table(young_adults$direction_group)[[3]]/(nrow(young_adults))*100)`, and `r round(table(adults$direction_group)[[3]]/(nrow(adults))*100)` percent of metabolites showed inconsistent effect directions across measures of adiposity respectively. Of the `r nlevels(metabolites)` metabolites measured across all age groups, directional consistency was supported by strong evidence of correlation across exposures within age groups; though still strong, weaker correlations were observed when looking within exposures across age groups (Supplement \@ref(chapter4-appendix-correlations)).<br>

```{r chapter4-figure-directional-consistency-2, eval=TRUE, include=TRUE, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, out.width='100%', fig.cap="Directional consistency across exposures within each age group"}
# plot ====
ggplot(data = data,
       aes(x = exposure)) +
  geom_bar(aes(fill = direction_group))  +
  scale_fill_manual(values = discrete_wes_pal) +
  guides(fill = guide_legend(override.aes = list(size = 5),
                             title = "",
                             label.hjust = 0,
                             label.vjust = 0.5)) +
  xlab("") +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 90),
        axis.ticks.x = element_blank())
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-directional-consistency-2) shows the directional consistency of all exposures for each age group. A positive effect reflects effect estimates for all exposures being in the positive direction; a negative effect reflects effect estimates being in the negative direction; opposite effect reflects different directions for the effect estimates across the exposures.*
\esmall
\noindent 

#### Global metabolic profile
Globally, the pattern of association was very similar for all measures of adiposity for children (Figure \@ref(fig:chapter4-figure-circosplot-main-children)), adolescents (Figure \@ref(fig:chapter4-figure-circosplot-main-adolescents)), young adults (Figure \@ref(fig:chapter4-figure-circosplot-main-young-adults)), and adults (Figure \@ref(fig:chapter4-figure-circosplot-main-adults)). Across all age groups the largest effects were found for the *Fatty Acids* subclass; total fatty acids showed the largest effect for all age groups. Metabolites in subclasses *small VLDL*, *medium VLDL*, *large VLDL*, and *very large VLDL* were the only ones to reach the specified significance thresholds across all exposures and age groups. Effect estimates for derived measures were much higher for all exposures and age groups than with the subclasses presented here (Supplementary \@ref(chapter4-appendix-circosplot-supplement2)). There was also considerable variation within subclasses for derived measures. The largest effect across all age groups and exposures among derived measures was observed for *Cholesterol esters in very large VLDL to total lipids in very large VLDL ratio* and *Total cholesterol in very large VLDL to total lipids in very large VLDL ratio*. Across age groups, direction of effect was consistent for the majority of metabolites within exposures (Supplementary \@ref(chapter4-appendix-figures-forestplots)). On the whole, effect sizes were lowest in children and increased with age. The largest effect in adults, *Total fatty acids* (beta = 0.51), was over twice that observed in children (beta = 0.21). <br>

```{r chapter4-figure-circosplot-main-children, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of measures of increased adipsoity and metabolites in children"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_children.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-children) shows each track as one of the measures of adiposity; the outer track is BMI, the middle track is WHR, the inner track is BF. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (54).*
\esmall

```{r chapter4-figure-circosplot-main-adolescents, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of measures of increased adipsoity and metabolites in adolescents"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_adolescents.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-adolescents) shows each track as one of the measures of adiposity; the outer track is BMI, the other track is BF - WHR was not available for adolescents. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (48).*
\esmall

```{r chapter4-figure-circosplot-main-young-adults, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of measures of increased adipsoity and metabolites in young adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_young_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-young-adults) shows each track as one of the measures of adiposity; the outer track is BMI, the middle track is WHR, the inner track is BF. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (46).*
\esmall

```{r chapter4-figure-circosplot-main-adults, echo=FALSE, out.width='100%', fig.cap="Circos plot of effect estimates from a linear regression of measures of increased adipsoity and metabolites in adults"}
knitr::include_graphics("data/chapter4/figures/circosplot_main_adults.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-circosplot-main-adults) shows each track as one of the measures of adiposity; the outer track is BMI, the middle track is WHR, the inner track is BF. Solid points indicate a multiple testing threshold has been reached -- threshold set to the lowest of the age groups (53).*
\esmall




#### Subclass results
At the level of the subclass, associations were observed for all measures of adiposity across age groups and every subclass except *Large LDL* in children, where weak evidence of association was observed across measures of adiposity. Across the derived measures, associations were observed across measures of adiposity for all subclasses except *Extremely large VLDL ratios* in young adults and adults. <br>

Across all age groups and exposures associations with every metabolite in a particular subclass was observed for *Small VLDL*, *Medium VLDL*, *Large VLDL*, *Very large VLDL*, and *Extremely large VLDL* (Figure \@ref(fig:chapter4-figure-forestplot-subclass-LDL)). As age increased, the number of associations within subclasses tended to increase across all measures of adiposity. For example, across *Small LDL*, *Medium LDL*, and *Large LDL* few associations were observed across measures of adiposity in children, however in adolescents and young adults a majority of metabolites showed evidence of association while in adults all metabolites showed evidence of association. <br> 

```{r chapter4-figure-forestplot-subclass-LDL, echo=FALSE, out.width='100%', fig.cap="Forestplot of effect estimates across exposures and ages for LDL subclasses"}
knitr::include_graphics("data/chapter4/figures/forestplot_subclass_LDL.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-forestplot-subclass-LDL) gives the effect estimate and 95% confidence interval for model 2 across all exposures and age groups.*
\esmall

#### Individual results
```{r echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data_main <- subset(data, model == "model2")
data_main <- subset(data_main, derived_features == "no")
data_main <- subset(data_main, subclass != "Fatty acids ratios")
data_main <- subset(data_main, subclass != "Lipoprotein particle size")
```
Excluding derived measures, *Fatty acids ratios*, and *Lipoprotein particle size* subclasses, which showed much larger and varied effects compared to other subclasses, effects ranged from `r round(min(data_main$b),2)` to `r round(max(data_main$b))` with a median of `r round(median(data_main$b),3)`. The largest positive effects ($> 0.1$) were seen for Total fatty acids and mono-unsaturated fatty acids; the largest negative effects ($< -0.1$) were for Total lipids in large HDL and Total cholesterol in HDL (Table \@ref(tab:chapter4-table-largest-effects)). <br>

\blandscape
```{r chapter4-table-largest-effects, echo=FALSE, warning=FALSE, error=FALSE}
data <- read.table("data/chapter4/data/analysis/results/combined/combined.txt", header = T, sep = "\t")
data <- subset(data, model == "model2")
data <- subset(data, derived_features == "no")
a <- c("Ratios", "Fatty acids ratios", "Lipoprotein particle size")
data <- data[!data$subclass %in% a, ]
a <- subset(data, b >= 0.1)
b <- subset(data, b <= -0.1)
data <- rbind(a,b)
data <- data[,c(8,10,15,14,3,6,7)]
data <- data[order(data$subclass, data[[1]], -data$b), ]

# make table ====
if (doc.type == "docx") { 
x <- data

} else { 
  
  if (doc.type != "docx") { 
x <- knitr::kable(
  (data), longtable = T, booktabs = T, digits = 2, linesep = "",
  caption = 'Largest effects (<= -0.1 and => 0.1) found across exposures and age groups', row.names = F, col.names = c("Metabolite","Subclass","Group","Exposure","Beta","Lower CI", "Upper CI"))
x <- kable_styling(x, full_width = T) %>%
  column_spec(1, width = "15em") %>%
  column_spec(c(2,3), width = "5em") %>%
  collapse_rows(columns = c(1:4))
    
    
  } else {
    
  }
}
#=====
x
```
\noindent 
\bsmall
*Results only shown for model 2. All results reported a P-value < 1.17 x 10^-4^.*
\esmall
\elandscape

#### Comparison with Wurtz et al. (2014)[@Wurtz2014] {#chapter4-wurtz-comparison}
A total of 84 metabolic measures, including systolic and diastolic blood pressure, where measured by Wurtz et al. (2014)[@Wurtz2014]. Of these, 42 were comparable with metabolites measured here. Direction of effect estimates were broadly similar across both studies (Figure \@ref(fig:chapter4-figure-forestplot-wurtz-comparison)). The size of the effects among *IDL*, *Lipoprotein particle size*, *Glycolysis related metabolites*, *Fatty acids ratios*, *Fatty acids*, *Cholesterol*, and *Apolipoproteins* were, bar a few metabolites within the subclasses, broadly similar; large confidence intervals among analysis conducted here among *Glycolysis related metabolites* meant effects overlapped with those of Wurtz et al (2014). Effects on metabolites in the remaining subclasses were much larger in the Wurtz et al. (2014) analysis than that conducted here; this is particularly evident for *Amino acids*, *Aromatic amino acids*, and *Branched-chain amino acids*. <br>.

\blandscape
```{r chapter4-figure-forestplot-wurtz-comparison, echo=FALSE, out.width='100%', fig.cap="Forestplot of effect estimates across exposures and ages for LDL subclasses"}
knitr::include_graphics("data/chapter4/figures/forestplot_wurtz_comparison.pdf")
```
\noindent 
\bsmall
*Figure \@ref(fig:chapter4-figure-forestplot-wurtz-comparison) gives the effect estimate and 95% confidence interval for model 2 across all exposures and age groups.*
\esmall
\elandscape
\newpage

## Discussion
In this chapter, the influence of increased adiposity on the metabolic profile is demonstrated in an observational framework. These effects persist, not only when measured at different ages, but also when adjusted for confounders and when examined across multiple measures of adiposity. <br>

The association between increased adiposity and metabolites is global, with effects seen across all subclasses of metabolites. These effects are broadly consistent between metabolites within each subclass. When looking at each exposure across age groups (e.g. the effects of BMI in children, adolescents, young adults, and adults), we find highly similar effects in individuals measured at multiple time points (children, adolescents, and young adults). A similar metabolic profile is apparent in adults, though effect sizes appear slightly larger. The larger effects seen in adults may be due to the fact that metabolite concentrations have been shown to increase in older populations over time[@Darst2019]. Given that longitudinal work has shown that BMI tracks over time[@Singh2008; @Buscot2018] there may be a dose response relationship here whereby increased adiposity over time leads to increased metabolite concentrations. <br>

Within each age group, there was high directional consistency across the three exposures. Effect sizes across exposures were similar within age groups, with overlapping confidence intervals; BMI showed a broadly higher effect on metabolites across age groups. Effects for BF appeared to be closer to, and crossed, the null more often than BMI and WHR. This may suggest that overall adipose mass in addition to detrimental deposition, may be driving the effect of increased adiposity on metabolites which may lead to disease. <br>

These results are consistent across models; consistency in the direction of effect estimates were observed for the majority of tests. The effect size was broadly similar in the case of models 1 and 2. There was a decreases in effect sizes in model 3 compared with 1 and 2. However, confidence intervals overlapped across the majority of tests even if they crossed the null in some instances for model 3. Consistency across models suggests the association between measures of adiposity and metabolites shows weak evidence of confounding. Whether these results represent a true causal association or are subject to reverse causation or residual confounding requires further investigation. <br>

Previous work by Wurtz et al. (2014)[@Wurtz2014] identified numerous associations between BMI and metabolites in a large population. Results here are broadly in line with theirs in terms of effect direction. However, the size of effects differed drastically for a number of metabolites, with much larger effects seen in the study by Wurtz et al(2014)[@Wurtz2014]; for the remaining metabolites effect sizes were comparable. These large differences may be a result of differences in metabolite data preparation; here, metabolomics data underwent quality control and if the same quality control had been eprformed by Wurtz et al. (2014)[@Wurtz2014] some metabolites may have been excluded. Also, metabolites reported here are absolute values where as Wurtz et al. (2014)[@Wurtz2014] scaled concentrations to standard deviation units. In addition, where as multiple covariates were included here, only age and sex were included by Wurtz et al. (2014)[@Wurtz2014]. Though effect sizes differed there was consistency in effect direction for key metabolites such as phenylalanine and tyrosine, which, as a result of increased adiposity is increased across ages here and in numerous studies[@Haufe2016; @Fattuoni2018; @Zheng2016; @Ho2016; @Newgard2009; @Yu2018; @Xie2014; @Kim2010b]. <br>

### Limitations

#### Metabolomics
There is no standardised approach, nor a gold standard, for performing metabolomics quality control. Here, quality control, including outlier detection and removal, was performed using the `MetaboQC` `R` package. The default settings for exclusions based on metabolite missingness (20%), sample missingness (20%), total sum abundance (5 SD), and principal components (5 SD) were used. Most samples were removed for having missingness > 20% compared to total peak area and PC. Twenty percent sample missingness is arbitrarily defined and used among other studies[@Lotta2020], however a more stringent threshold (e.g. 5%) may have impacted on results. Especially given that metadata such as batch and runday information was not available. `MetaboQC` calculated the number of independent metabolites using a clustering dendorgram and a tree cut height based on a Spearman's Rho of 0.5. Although most metabolites were shared across age groups, differences in the number of independent metabolites were found. There were also differences in the number of clusters and truly independent metabolites. Similalry, inclusion of derived metabolites resulted in differing numbers of independent metabolites. <br>

#### Data availability
Metabolomics measures were taken at specific time points in ALSPAC children and at ~50 years of age in adults. Though measures of adiposity were available at the same time points, data on confounders was not. Smoking status for example was available for adult males at the metabolomics clinic but the closest available measure for adult females was a number of years earlier, in which time they may have taken up smoking. Although data were obtained where available from the closest time point, the mismatch in timings may bias results, particularly in the case of smoking and alcohol consumption. <br>

In all age groups, the availability of data was limiting. Absence of physical activity data meant model 3 was not performed for children, while absence of diet data in young adults and adults meant models 2 and 3 were constrained. However, adjusting for diet where available (children and adolescents) had little impact on results (Table \@ref(tab:chapter4-table-significant-results)) and is therefore likely not to have changed findings in young adults and adults. <br>

In children, body fat percentage was not available. A raw impedance measure was available and derivation of BF using Equation \@ref(eq:BF) showed positive correlation with BMI and weight in children and BF measures in adolescents. However, this derived measure included numerous negative estimates of BF. The equation performed well in adolescents, correlating highly with DXA derived BF (Figure \@ref(fig:chapter4-figure-BF-validation-correlation-2)). The negative estimates of BF are likely a result of Equation \@ref(eq:BF) being derived in an adult population. Brief investigation showed negative estimates of BF remained when using adolescent age with child height and weight (data not shown). Given that in single frequency devices impedance is based on the volume of an individual it is probable that the values used in the equation do not accurately reflect the proportions of children pre-puberty. Child-specific equations were not available and the manufacturer was unwilling to share the equation used by their impedance devices. However, given that in a linear model the estimate is based on the per-unit increase, the absolute value negative or otherwise, will not impact on the final result. <br>

#### Sensitivity analyses
The distribution of BMI at each age group was very similar across sexes. However, the distribution of WHR and BF differed among sexes in adolescents, young adults and adults; men had on average a higher WHR while women had a higher BF. Though Z-scores were used and sex was included as a covariate, the differences in WHR and BF distributions may highlight an underlying difference, which confounds the relationship between adiposity and metabolites. For example, hormonal contraceptive use has shown to influence the metabolome[@Rauschert2017] and is not regularly taken by individuals with a high BMI[@Mody2014]. There was little difference in results from the three models in regards to direction of effect estimates. However, when including only individuals with physical activity (model 3) the size of effects and the number of associations reaching a multiple testing threshold decreased. Given the consistency in the direction of effects across models and the highly similar effects across model 1 and 2 there is likely little effect of confounding. However, the possibility of unmeasured confounding can not be ruled out. <br>

### Summary
The large number of associations identified using multiple exposures adds weight to the evidence, shown previously for BMI, of association between increased adiposity and metabolites. As with previous work, we find associations between increased adiposity and many metabolites, including increased phenylalanine and tyrosine and decreased HDL components. This work highlights the large effects of increased adiposity on the global metabolic profile and shows that effects likely persist over time. Puberty is likely to have an affect on both adiposity, physical activity, and the metabolome and the lack of available data in children (BF and physical activity) means this requires further investigation, particularly as the adolescent time point used will have included post-pubertal individuals. Though confounders were taken into account the potential for unmeasured confounding is likely, and follow-up analysis will require this to be taken into account. Of particular note is the increasing effect size and number of associations as a result of increased adiposity across the metabolic profile with age. Given that many adiposity associated diseases occur later in life, exposure to an altered metabolic profile over time may be important in disease development, especially as weight loss in overweight and obese individuals is associated with reductions in elevated and increases in reduced metabolites[@Rangel-Huerta2019]. <br>
