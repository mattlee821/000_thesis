---
output: 
    thesisdown::thesis_pdf: default
bibliography: bib/thesis.bib
csl: csl/nature.csl
space_betwee_paragraphs: true
fig_caption: true
always_allow_html: yes
link-citations: true
toc-depth: 2
lot: true
lof: true
indent: true
header-includes: # include other LaTeX packages here
    \usepackage{booktabs}
    \usepackage{longtable}
    \usepackage{siunitx}
    \usepackage[left]{lineno}
    \usepackage{float}
    \floatplacement{figure}{H}
    \linenumbers
    \pagestyle{plain}
    \raggedbottom 
    \usepackage{indentfirst}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
# word count = 
doc.type <- knitr::opts_knit$get('rmarkdown.pandoc.to') # this will tell the .Rmd file what output you are knitting to (word, pdf, html) so that you cna use if else statements when making tables - html/pdf output tables do not work well in word. For word we need to use the 'flextable' packaged to make tables.
## packages
library(dplyr)
library(kableExtra)
library(flextable)
```

# EpiViz: a tool to visualise large association analyses {#visualisation}

<style>
body {
text-align: justify}
</style>

## Chapter summary {-}
The exploration, interpretation, display, and communication of analyses which use a large number of traits is challenging. Previous studies have used Circos plots, whereby data are presented in a circular layout, to visualise and provide overview of large association analyses. However, the process of producing Circos plots is cumbersome and, through personal experience[@Taylor2019], has been time consuming and inefficient. This Chapter details `EpiViz`, a web application and `R` package that efficiently produces Circos plots to summarise and aid interpretation of association analyses. `EpiViz` is used in following chapters to gain a global overview and identify patterns of association in observational and Mendelian randomization (MR) analyses. `EpiViz` considerably improves the speed and efficiency of producing Circos plots and has been used in multiple studies[@Bos2021; @Bell2020; @Taylor2019] since its development. `EpiViz` is available on [GitHub](https://github.com/mattlee821/EpiViz/).\par

\newpage

## Introduction
Large epidemiological analyses, involving potentially hundreds of associations between exposures and outcomes, pose a challenge for the digestion and interpretation of results. Data visualisation is key to improving the exploration, interpretation, communication, and display of data[@Tufte1983]. This is particularly relevant for metabolite measures, where looking at a single metabolite may not provide a complete picture given they are highly inter-correlated. That is, a change in one metabolite is unlikely to occur in isolation. In addition, a key aim of this thesis is the use of complimentary measurements of adiposity (discussed in Chapter \@ref(introduction)). The ability therefore to provide overview of metabolic profiles and to compare these across adiposity measures is key to interpreting the effects of adiposity. \par

Traditionally, forest plots have been used to effectively communicate association analyses and, have been used successfully for analyses involving metabolites[@May-Wilson2017; @Taylor2019; @Soares2019; @SantosFerreira2019; @Hartley2020; @Borges2017]. These studies have however been limited to a relatively small number of associations between exposures and outcomes, and have therefore been unable to present a global picture (profile) of metabolic effects. When dealing with hundreds of variables, forest plots can become cumbersome, requiring many separate plots to be created in order to present all of the analyses. This makes comparison and the ability to gain global overview of large analyses difficult. \par

An alternative approach is to compress information into a circular rather than vertical or horizontal form. Circos plots[@Krzywinski2009], as implemented in many genetics studies to condense large genomic information into informative visuals[@Saben2014], provide an efficient visualisation tool for incorporating hundreds to thousands of data points. Circos plots have been used effectively to communicate results from large metabolomic analyses[@Kettunen2012; @Kettunen2016; @Shin2014; @Bos2021; @Taylor2019; @Bell2020]. However, the Circos software is designed for genomic data and written in programming languages unfamiliar to many epidemiologists. The `R` package `Circlize`[@Gu2014] provides most of the functionality of the Circos software and is publicly available. However, it is not designed for association analyses as performed in this thesis. As such, it can be time consuming and inefficient to produce Circos plots.

In order to efficiently and reproducibly create Circos plots that enable the exploration, interpretation, communication, and display of large, and complex, epidemiological analyses as conducted in this thesis, `EpiViz` was developed. `EpiViz` is a web application and `R` package, that builds on the `Circlize`[@Gu2014] and `ComplexHeatmap`[@Gu2016] `R` packages. It enables data to be presented in a compact form that allows for the efficient identification of profile changes in metabolomic data specifically for this thesis, as well as global patterns of associations in high-dimensional epidemiological data. \par

## Methods
### Circos plots for association analyses
`EpiViz` composes Circos plots using six elements: a template, plotting space, data, an optional legend, tracks, and sections (Figure \@ref(fig:epiviz-annotated-circos-plot)). The template element is a square of defined proportions within which information is plotted. Each additional element is layered onto the template one after the other. The plotting space element is an empty circle which is layered and centred on top of the template. Data is plotted on to the plotting space. An optional extra of the Circos plot, the legend element, takes the dimensions of the template and creates a separate plotting space that can be layered on to the bottom of the template element. \par

The plotting space is separated into tracks and sections. Tracks are laid down as rings within the plotting space. Each track represents a single element of information such as an exposure or method. Tracks are numbered from the outside to the centre of the circle and can be coloured separately. Sections divide the plotting space into distinct areas, much like a pie chart. Sections are defined by a grouping variable such as a metabolite class or pathways (e.g., class or sub class). A section track is placed at the outside of the tracks to give a header for each section. The header is referenced in the legend element. \par

Once the template, plotting space, tracks and sections are laid down, coordinates for each section and track location can be called to plot the data element. Each track and section coordinate, e.g., track 2 section 3, is treated as an individual plotting space. As such, data can be plotted based on the following coordinates: track, section, $X$, $Y$. The $X$ axis of each track is defined by the number of rows in the data frame, i.e., a data frame with 100 rows will have an $X$ axis of length 100, with each row given an $X$ axis coordinate from 1--100. The $Y$ axis is defined by the minimum and maximum of the data for that track, e.g., effect estimate or p-value. As such, each track and section coordinate, e.g., track 2 section 3, can be considered an individual plot with a $Y$ axis that is shared by all of the sections in that track. For each position on the $X$ axis, the label element of each row is plotted outside of the section header. \par

(ref:epiviz-annotated-circos-plot-cap) **Circos plot highlighting the six elements used to plot data**. The Circos plot shows three tracks and 28 sections of data simulated to give an example of the effect of three exposures on over 100 outcomes. Available on [GitHub](https://github.com/mattlee821/000_thesis/blob/master/index/data/visualisation/figures/annotated_circos_plot.pdf).

(ref:epiviz-annotated-circos-plot-scap) Circos plot highlighting the six elements used to plot data

```{r epiviz-annotated-circos-plot, echo=FALSE, out.width='100%', fig.align='center', fig.cap='(ref:epiviz-annotated-circos-plot-cap)', fig.scap='(ref:epiviz-annotated-circos-plot-scap)'}
knitr::include_graphics("data/visualisation/figures/annotated_circos_plot.pdf")
```

### Implementation
`EpiViz` is a `Shiny` web application and `R` package. `R`[@r2019] version 3.6.2 and `Shiny`[@Chang2019] version 1.4.0 were used to develop the web application; `R` version 3.6.2 was used to develop the `R` package. `Shiny` is an `R` package that enables the development and deployment of web applications written in the `R` programming language. Development of `EpiViz` was progressive and feedback from colleagues was vital in this process. \par

### Operation
The [web application](https://mattlee.shinyapps.io/EpiViz/) is publicly accessible and held under an [MIT license](https://github.com/mattlee821/EpiViz/blob/master/LICENSE.txt). The web application has been tested on computers running macOS (version 10.14) and Windows (version 10) using: Internet Explorer (version 11; Windows), Google Chrome (version 79; macOS and Windows), and Safari (version 13; macOS). \par

The [`R` package](https://github.com/mattlee821/EpiViz/tree/master/R_package) is publicly accessible through GitHub and held under an [MIT license](https://github.com/mattlee821/EpiViz/blob/master/LICENSE.txt). The `R` package is accessible on all computers with `R` version 3.3.0 or higher and has been tested on macOS (version 10.14) and Windows (version 10) running `R` version 3.3.0 or higher. \par

A legend function is available for both the web application and `R` package and is implemented using functions from the `ComplexHeatmap`[@Gu2016] `R` package. By default, the colours used for the Circos plot in both the web application and `R` package are accessible colours identified using [i want hue](https://medialab.github.io/iwanthue/). Example data, that I produced, has been provided for users of both the web application and R package. This example data was sourced from Kettunen et al., (2016)[@Kettunen2016], which detailed the effect of body mass index (BMI) on metabolites using Mendelian randomization (MR) using genetic variants associated with BMI in male, female and sex-combined samples. This data is provided on the Home tab on the web application and can be accessed with the `R` package using the `EpiViz::EpiViz_data*()` function, where `*` is 1-3, specifying data using male (1), female (2), or sex-combined (3) instruments. Example data can be produced for use with the web-application and `R` package using code on [GitHub](https://github.com/mattlee821/EpiViz/blob/master/R_package/data-raw/example_data_simulation.R). \par

#### Web application
In order to use the [web application](https://mattlee.shinyapps.io/EpiViz/), a web-browser and an internet connection of at least 1Mbps is required. No other system requirements are needed. Upon opening the web application, users are shown example Circos plots created using simulated and the example data described above, and are directed towards the *Home* tab. The *Home* tab provides users with a short summary of the application, a link to the `R` package, and example data for use with the app. \par

The *How to* tab provides instructions for using the application. Step 1 deals with the preparation of data, Step 2 deals with how to use the application, and Step 3 provides information on potential next steps. Users are instructed to upload one data frame per track of the Circos plot. Each data frame should be a tab delimited text file and `R` code is provided for users to achieve this. The user is guided through an example utilizing the example data of the effect of BMI on metabolites from Kettunen et al., (2016). \par

Once users have uploaded their data, descriptive information, including a volcano plot (where the effect estimate from the data is shown on the x-axis and p-value on the y-axis), will be produced automatically. Users then select the *Plot* tab, in which they specify the names of the columns in the data for the: label, section, estimate, p-value, lower confidence interval, and upper confidence interval. The estimate, p-value and confidence interval detail the association results provided in the data, the label column details what the user would like to label each association result (e.g., the name of the outcome) and the section column details how the data should be grouped into sections, for example by metabolite class. A p-value adjustment ($X$) can be provided to indicate a p-value threshold in the format $\displaystyle \frac{0.05} {X}$. On the Circos plot, a solid point is indicated as reaching the p-value threshold. An optional legend function is provided and users can choose the labels for the legend points. The legend is auto-populated using the levels in the section column of the uploaded data frame. Finally, an option to use colours accessible to individuals with colour impaired sight is provided. \par

#### `R` package
Documentation for using the package is available as a `README` on [GitHub](https://github.com/mattlee821/EpiViz/tree/master/R_package). The `README` includes use cases and troubleshooting. The `R` package can be installed and loaded into the current `R` session directly from GitHub with the following code: 

```{r eval=FALSE}
# Install devtools
install.packages("devtools")
library(devtools)

# Install directly from GitHub
devtools::install_github("mattlee821/EpiViz/R_package")
library(EpiViz)
```

\newpage

Once installed, users can use the example data provided with the package to produce Figure \@ref(fig:epiviz-figure-example-circos1), which illustrates the three different types of track available (point, line, bar), using the following `R` code:

```{r eval=FALSE}
circos_plot(track_number = 3,
            track1_data = EpiViz::EpiViz_data1,
            track2_data = EpiViz::EpiViz_data2,
            track3_data = EpiViz::EpiViz_data3,
            track1_type = "points",
            track2_type = "lines",
            track3_type = "bar",
            label_column = 1,
            section_column = 9,
            estimate_column = 2,
            pvalue_column = 3,
            pvalue_adjustment = 1,
            lower_ci = 4,
            upper_ci = 5,
            lines_column = 2,
            lines_type = "o",
            bar_column = 2,
            legend = TRUE,
            track1_label = "Track 1",
            track2_label = "Track 2",
            track3_label = "Track 3",
            pvalue_label = "<= 0.05")
```

(ref:epiviz-figure-example-circos1-cap) **Example Circos plot using `EpiViz` `R` package and example data**. Data presented are results from Mendelian randomization analyses of the association between body mass index and metabolites using data from Kettunen et al., (2016)[@Kettunen2016] using male (blue), female (yellow), and sex-combined (brown) instruments from Locke et al., (2015[@Locke2015]. Available on [GitHub](https://github.com/mattlee821/000_thesis/blob/master/index/data/visualisation/figures/r_package_3_track_type_plot.pdf).

(ref:epiviz-figure-example-circos1-scap) Example Circos plot using `EpiViz` `R` package and example data

```{r epiviz-figure-example-circos1, echo=FALSE, out.width='100%', fig.align = 'center', fig.cap='(ref:epiviz-figure-example-circos1-cap)', fig.scap='(ref:epiviz-figure-example-circos1-scap)'}
knitr::include_graphics("data/visualisation/figures/r_package_3_track_type_plot.pdf")
```

In producing plots using the `R` package, users are advised to save as `PDF` using the below code. This is because the Circos plot is designed to be larger than normal plots, as such viewers like the `R` Studio Viewer pane display the plot in a compressed form, squashing the plot. Viewers like this should be used only as a guide when making the plot. `PDF` files can be converted to other image formats without compression. Users are advised to iterate the sizing of the plot, adjusting the width and height arguments to get the desired plot size and then adjust the point size argument to increase and decrease the size of the information in the plot (labels, points, lines, etc.). The values provided in the below code work with most plots and were used for all examples in this Chapter. In addition, users can adjust the size of the Circos plot directly using the argument `circle_size`. The default for `circle_size` is 25, smaller numbers increase the size of the circle and larger numbers decrease the size of the circle:

```{r eval=FALSE}
pdf("my_circos_plot.pdf",
    width = 30, height = 30, pointsize = 35)
circos_plot(...
            circle_size = 25)
dev.off()
```

Finally, users can adjust the height of tracks individually using `track*_height` where `*` refers to the track number. The default for each track is 20 percent of the total size of the circle, the section track is fixed at 5 percent of the total size of the circle. The remaining space is at the centre of the circle. Tracks can be increased in size to occupy more, or less, of the circles size using the following arguments:

```{r eval=FALSE}
circos_plot(...
            track1_height = 0.2,
            track2_height = 0.2,
            track3_height = 0.2)
```

In order to minimise the time required to maintain the `R` package, further customisation is achieved by the users themselves. The function is written to aid this customisation with *Default parameters* and *Customisable parameters* located at the top of the `circos_plot()` function. Guidance and code is provided on [GitHub](https://github.com/mattlee821/EpiViz/tree/master/R_package) to aid user customisation. \par

## Discussion
Circos plots have been used to visualise and provide overview of large metabolomic association analyses[@Shin2014; @Kettunen2012; @Kettunen2016; @Bos2021; @Taylor2019]. When creating Circos plots for Taylor et al. (2019)[@Taylor2019], the process was cumbersome and inefficient with each revision requiring me to write bespoke code. `EpiViz` simplifies and streamlines the process of making Circos plots. In Bos et al. (2021)[@Bos2021], `EpiViz` was used to summarise and visually compare observational and Mendelian randomization analyses of multiple sleep traits on over 100 metabolites. `EpiViz` made producing and refining Circos plots for this analysis faster and more efficient. \par

The web application is intended for researchers with limited to no experience of `R` and is in a stable release. Additions to the web applications functionality are therefore not envisioned. The `R` package, also in a stable release, will be the focus of further development as maintenance costs are lower as there is no requirement for the additional coding of the user interface as with the web application. The focus of future changes should be on converting the current code style to the [`tidy` style](https://tidyverse.tidyverse.org/articles/manifesto.html) to improve readability and consistency. This will also improve the ease with which contributions can be implemented. Additional features should be directed by the needs of the users, this is likely to include additional plotting mechanics such as the chord diagram, which shows relatedness between nodes. In the case of metabolites, a chord diagram would provide greater understanding about the relationship between different sections and individual metabolites. In addition, the ability to filter and choose specific sections to display would simplify the presentation of key results -- currently this is achieved with supplementary forest plots. \par

In order to achieve the desired goal of providing global overview of large association analyses, Circos plots are larger than traditional plots. This poses a challenge for their use in print as there are size restrictions. Circos plots are therefore ideally suited to online use, however, if large enough, and with proper sizing of text, they can be used as overview figures in printed media. When used online there is the potential for creating interactive Circos plots, allowing users to expand and filter the Circos plot as desired. Interactive plots can be used in online publications such as [F1000](https://blog.f1000.com/2017/07/19/so-long-static-we-now-support-interactive-ploty-figures-in-our-articles/) which encourage use of the `plotly` `R` package for interactive figures. This can enhance the reader experience, allowing readers to gain a better understanding of the presented research. \par

For this thesis, the effect of adiposity on metabolites as a whole and as subclasses, i.e., profiles, is key to interpreting the effects of adiposity. This is because metabolites are highly inter-correlated and perturbations rarely happen in isolation. The ability to visualise these profiles can therefore aid the interpretation of the global effects of adiposity as well as provide context for the effect of adiposity on an individual metabolite. Forest plots can provide this overview, however the need for many, or very long, plots makes summarising results challenging and visually unappealing. Circos plots, while remaining visually appealing, are able to visualise a far greater number of results and maintain their ability to provide global overview. \par

`EpiViz` is simple and efficient to use. The web app provides a platform for quick and simple plots to be generated while the `R` applicaton provides customisation. `EpiViz` has been successfully used to interrogate large metabolomic association analyses[@Bos2021; @Bell2020; @Taylor2019] and will be used throughout this thesis to achieve the same goals. \par

\newpage

